<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ì†ìµë¥  ê³„ì‚°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSS ì„¤ì • */
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        /* ì¶”ê°€ì ì¸ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .calculator {
            max-width: 500px;
            margin: 20px auto;
            background: #ffffff;
            /* ëª¨ë°”ì¼ ìµœì í™”ë¥¼ ìœ„í•´ íŒ¨ë”©ì„ 16pxì—ì„œ 12pxë¡œ ì¶•ì†Œ */
            padding: 16px 12px; 
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
            display: block; /* ëª¨ë°”ì¼ì—ì„œ ë ˆì´ë¸”ì´ í•œ ì¤„ ì°¨ì§€í•˜ë„ë¡ */
            margin-bottom: 0.25rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        input[readonly] {
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: default;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 32px;
            height: 32px;
            line-height: 1;
            font-size: 1.1rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0; /* ê³µê°„ì´ ë¶€ì¡±í•´ë„ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ - ëª¨ë°”ì¼ ìµœì í™” */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.95em;
            /* í‘œê°€ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ ê°•ì œ ì„¤ì • */
            table-layout: fixed; 
        }
        .result-table th, .result-table td {
            /* ëª¨ë°”ì¼ í™”ë©´ ë°€ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ íŒ¨ë”©ì„ 8pxë¡œ ì¶•ì†Œ */
            padding: 8px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            /* ê¸´ ìˆ«ìê°€ í™”ë©´ì„ ë°€ì–´ë‚´ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ í—ˆìš© */
            word-break: break-word; 
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            /* ì²« ë²ˆì§¸ ì—´ì´ í…ìŠ¤íŠ¸ë¥¼ ë‹´ì„ ìˆ˜ ìˆë„ë¡ ë„ˆë¹„ ì¡°ì • */
            width: 60%;
        }
        .result-table td {
             /* ë‘ ë²ˆì§¸ ì—´ì´ ìˆ«ìë¥¼ ë‹´ì„ ìˆ˜ ìˆë„ë¡ ë„ˆë¹„ ì¡°ì • */
            width: 40%;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: bold;
        }
        
        /* ì´ ê³µì œì•¡ ë° ìƒì„¸ í•­ëª© ìƒ‰ìƒ (íŒŒë€ìƒ‰) */
        .deduction-color {
            color: #3498db; /* íŒŒë€ìƒ‰ (ì†ì‹¤ê³¼ ë™ì¼) */
            font-weight: bold;
        }
        .deduction-detail th, .deduction-detail td {
            padding-top: 4px;
            padding-bottom: 4px;
            font-size: 0.9em;
            font-weight: normal;
        }
        .deduction-detail .value-col {
            color: #3498db; /* ìƒì„¸ ê³µì œì•¡ë„ íŒŒë€ìƒ‰ */
            font-weight: 500;
        }

        /* ë§¤ë„ í›„ ìˆœíšŒìˆ˜ì•¡ (ìš”ì²­ì— ë”°ë¼ êµµì€ ë³´ë¼ìƒ‰ìœ¼ë¡œ ê°•ì¡°) */
        .net-proceeds-color {
            color: #6c5ce7; /* ì§™ì€ ë³´ë¼ìƒ‰ */
            font-weight: 800; /* Extra bold */
            font-size: 1.1em; /* í¬ê¸° ì•½ê°„ í‚¤ì›€ */
        }


        /* ì†ìµ/ì†ì‹¤ ìƒ‰ìƒ ì •ì˜ (ìˆ˜ìµ: ë¹¨ê°•, ì†ì‹¤: íŒŒë‘) */
        .profit {
            color: #e74c3c; /* ìˆ˜ìµ (ë¹¨ê°„ìƒ‰) */
            font-size: 1.2em;
        }
        .loss {
            color: #3498db; /* ì†ì‹¤ (íŒŒë€ìƒ‰) */
            font-size: 1.2em;
        }
        .neutral {
            color: #34495e; /* ì¤‘ë¦½ (íšŒìƒ‰) */
            font-size: 1.2em;
        }

        /* ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„) í•­ëª©ì— ëŒ€í•œ ìŠ¤íƒ€ì¼ */
        .net-result.profit-text {
            color: #e74c3c; /* ìˆ˜ìµ (ë¹¨ê°„ìƒ‰) */
            font-weight: bold;
        }
        .net-result.loss-text {
            color: #3498db; /* ì†ì‹¤ (íŒŒë€ìƒ‰) */
            font-weight: bold;
        }
        .net-result.neutral-text {
            color: #34495e; /* ì¤‘ë¦½ (íšŒìƒ‰) */
            font-weight: bold;
        }
        /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #2ecc71;
            border-radius: 4px;
        }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    <h2 class="text-2xl font-bold text-center text-blue-800 border-b-4 border-blue-500 pb-3 mb-6">ğŸ“ˆ ì£¼ì‹ ê±°ë˜ ì†ìµë¥  ê³„ì‚°ê¸°</h2>
    <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ì‹¤ì‹œê°„ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

    <!-- 1. ë§¤ìˆ˜ ë‹¨ê°€ (ì¿ í‚¤ ì €ì¥, ê°œë³„ ì´ˆê¸°í™” ê°€ëŠ¥) -->
    <div class="input-group">
        <label for="buyPrice">1. ë§¤ìˆ˜ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
        <div class="flex items-center space-x-2">
            <input type="text" id="buyPrice" value="0" required oninput="handleCurrencyInputAndSave(this, 'stockBuyPrice')" inputmode="numeric" class="w-full">
            <button type="button" onclick="resetIndividualInput('buyPrice', 'stockBuyPrice', '0', 'currency')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
        </div>
    </div>

    <!-- 2. ìˆ˜ëŸ‰ (ì¿ í‚¤ ì €ì¥, ê°œë³„ ì´ˆê¸°í™” ê°€ëŠ¥) -->
    <div class="input-group">
        <label for="quantity">2. ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜)</label>
        <div class="flex items-center space-x-2">
            <input type="text" id="quantity" value="0" required oninput="handleCurrencyInputAndSave(this, 'stockQuantity')" inputmode="numeric" class="w-full">
            <button type="button" onclick="resetIndividualInput('quantity', 'stockQuantity', '0', 'currency')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
        </div>
    </div>

    <!-- 3. ë§¤ë„ ë‹¨ê°€ (ì¿ í‚¤ ì €ì¥, ê°œë³„ ì´ˆê¸°í™” ê°€ëŠ¥) -->
    <div class="input-group">
        <label for="sellPrice">3. ë§¤ë„ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
        <div class="flex items-center space-x-2">
            <input type="text" id="sellPrice" value="0" required oninput="handleCurrencyInputAndSave(this, 'stockSellPrice')" inputmode="numeric" class="w-full">
            <button type="button" onclick="resetIndividualInput('sellPrice', 'stockSellPrice', '0', 'currency')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
        </div>
    </div>
    
    <!-- 4. ìˆ˜ìˆ˜ë£Œìœ¨ ì…ë ¥ ë° ê³„ì‚° ê¸ˆì•¡ í‘œì‹œ -->
    <div class="input-group">
        <label for="feeRateInput">4. ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œìœ¨ (%) 
        </label>
        <div class="flex items-center space-x-2">
            <input type="text" id="feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'stockFeeRate');" inputmode="decimal" class="w-full">
            <button type="button" onclick="resetIndividualInput('feeRateInput', 'stockFeeRate', '0.015', 'rate')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
        </div>
    </div>
    <div class="input-group">
        <label for="calculatedFeeAmount">4-1. ê³„ì‚°ëœ ì´ ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡</label>
        <input type="text" id="calculatedFeeAmount" value="0" required readonly class="w-full">
    </div>

    <!-- 5. ê±°ë˜ì„¸ìœ¨ ì…ë ¥ ë° ê³„ì‚° ê¸ˆì•¡ í‘œì‹œ -->
    <div class="input-group">
        <label for="taxRateInput">5. ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%) 
        </label>
        <div class="flex items-center space-x-2">
            <!-- ê¸°ë³¸ê°’ 0.15% -->
            <input type="text" id="taxRateInput" value="0.15" required oninput="handleRateInputAndSave(this, 'stockTaxRate');" inputmode="decimal" class="w-full">
            <!-- ì´ˆê¸°í™” ê¸°ë³¸ê°’ë„ 0.15% -->
            <button type="button" onclick="resetIndividualInput('taxRateInput', 'stockTaxRate', '0.15', 'rate')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
        </div>
    </div>
    <div class="input-group">
        <label for="calculatedTaxAmount">5-1. ê³„ì‚°ëœ ê±°ë˜ì„¸ ê¸ˆì•¡ (ì›)</label>
        <input type="text" id="calculatedTaxAmount" value="0" required readonly class="w-full">
    </div>
    
    <div id="result" class="result mt-6 p-4 border-2 border-green-500 bg-green-50 rounded-lg" style="display: none;">
        <h3 class="text-xl font-semibold text-gray-700 text-center mb-3">ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
        
        <table id="resultTable" class="result-table">
            <!-- Content filled by JavaScript -->
        </table>
    </div>
</div>

<script type="module">
    // --- Configuration ---
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.15;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %


    // --- Cookie Helper Functions ---

    /**
     * ì¿ í‚¤ì—ì„œ ì§€ì •ëœ ì´ë¦„ì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
     * @param {string} name ì¿ í‚¤ ì´ë¦„
     * @returns {string|null} ì¿ í‚¤ ê°’ ë˜ëŠ” null
     */
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    /**
     * ì¿ í‚¤ì— ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤. (ë§Œë£Œì¼ 30ì¼ ì„¤ì •)
     * @param {string} name ì¿ í‚¤ ì´ë¦„
     * @param {string} value ì €ì¥í•  ê°’
     */
    function setCookie(name, value) {
        const date = new Date();
        date.setTime(date.getTime() + (30*24*60*60*1000)); // 30 days expiration
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
    }

    // --- Format & Input Handlers ---

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤. (ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ ì¶”ê°€)
     * @param {number} amount - ê¸ˆì•¡
     * @param {number} [precision=0] - ì†Œìˆ˜ì  ì´í•˜ ìë¦¿ìˆ˜ (ê¸°ë³¸ê°’: 0, ì •ìˆ˜)
     * @returns {string} í¬ë§·ëœ ë¬¸ìì—´
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const fixedAmount = amount.toFixed(precision);
        const parts = fixedAmount.split('.');
        const integerPart = parts[0];
        const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return formattedIntegerPart + decimalPart;
    }

    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ(,)ë¡œ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. (ë¡œë“œ ì‹œ ì‚¬ìš©)
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     */
    window.formatCurrencyInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9]/g, ''); 

        if (rawValue === '') {
            input.value = '';
            return; 
        }

        const newValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;
        
        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë§¤ìˆ˜ ë‹¨ê°€/ìˆ˜ëŸ‰/ë§¤ë„ ë‹¨ê°€)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë©°, ìˆ˜ìˆ˜ë£Œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     * @param {string} cookieName ì €ì¥í•  ì¿ í‚¤ ì´ë¦„ (ì˜ˆ: 'stockSellPrice')
     */
    window.handleCurrencyInputAndSave = function(input, cookieName) {
        // 1. í¬ë§·íŒ… ë° ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9]/g, ''); 

        if (rawValue === '') {
            input.value = '';
            setCookie(cookieName, '');
            updateFeeAndTaxFields();
            calculateProfitLoss(); // ì…ë ¥ê°’ ì—†ì„ ë•Œë„ ê³„ì‚° ì‹¤í–‰ (ê²°ê³¼ ìˆ¨ê¹€ ì²˜ë¦¬ìš©)
            return; 
        }

        const newValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
        
        // 2. ì¿ í‚¤ ì €ì¥ (ì‰¼í‘œ ì—†ëŠ” ì›ì‹œ ê°’ì„ ì €ì¥)
        setCookie(cookieName, rawValue);

        // 3. ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì—…ë°ì´íŠ¸
        updateFeeAndTaxFields();

        // 4. ìë™ ê³„ì‚° ì‹¤í–‰ (ëª¨ë“  í†µí™” ì…ë ¥ ë³€ê²½ ì‹œ)
        calculateProfitLoss(); 
    }
    
    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ê³ , ìˆ˜ìˆ˜ë£Œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     * @param {string} cookieName ì €ì¥í•  ì¿ í‚¤ ì´ë¦„
     */
    window.handleRateInputAndSave = function(input, cookieName) {
        // ì‰¼í‘œë§Œ ì œê±°í•˜ê³  ì‹¤ìˆ˜ ê·¸ëŒ€ë¡œ ì €ì¥
        const rawValue = input.value.replace(/,/g, ''); 
        
        // ìœ íš¨í•œ ìˆ«ìì¸ ê²½ìš°ë§Œ ì €ì¥
        if (!isNaN(parseFloat(rawValue))) {
            setCookie(cookieName, rawValue);
        }
        
        // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì—…ë°ì´íŠ¸
        updateFeeAndTaxFields();

        // ìë™ ê³„ì‚° ì‹¤í–‰ (ë¹„ìœ¨ ì…ë ¥ ë³€ê²½ ì‹œ)
        calculateProfitLoss(); 
    }
    
    /**
     * ê°œë³„ ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ê³  ì¿ í‚¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     * @param {string} inputId ì´ˆê¸°í™”í•  ì…ë ¥ ìš”ì†Œì˜ ID
     * @param {string} cookieName ì €ì¥ëœ ì¿ í‚¤ ì´ë¦„
     * @param {string} defaultValue ì…ë ¥ í•„ë“œì˜ ê¸°ë³¸ê°’ (í¬ë§·ë˜ì§€ ì•Šì€ ìˆ«ì ë¬¸ìì—´)
     * @param {string} type ì…ë ¥ íƒ€ì… ('currency' ë˜ëŠ” 'rate')
     */
    window.resetIndividualInput = function(inputId, cookieName, defaultValue, type) {
        const input = document.getElementById(inputId);
        
        // 1. ê°’ ì„¤ì • ë° ì¿ í‚¤ ì—…ë°ì´íŠ¸
        if (type === 'currency') {
            // í†µí™”: í¬ë§·í•˜ì—¬ í™”ë©´ì— í‘œì‹œí•˜ê³ , ì›ì‹œ ê°’ì„ ì¿ í‚¤ì— ì €ì¥
            input.value = formatCurrency(parseFloat(defaultValue)); 
            setCookie(cookieName, defaultValue); 
        } else { // rate
            // ë¹„ìœ¨: ê·¸ëŒ€ë¡œ í™”ë©´ì— í‘œì‹œí•˜ê³ , ì¿ í‚¤ì— ì €ì¥
            input.value = defaultValue; 
            setCookie(cookieName, defaultValue);
        }
        
        // 2. ë§¤ë„ ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ë§Œ ì´ˆê¸°í™”ë˜ë©´ ìˆ˜ìˆ˜ë£Œ/ê±°ë˜ì„¸ ê¸ˆì•¡ì´ 0ì´ ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê³„ì‚° í•„ë“œ ì—…ë°ì´íŠ¸
        updateFeeAndTaxFields();
        
        // 3. ìë™ ê³„ì‚° ì‹¤í–‰ (ëª¨ë“  ì´ˆê¸°í™” ì‹œ)
        calculateProfitLoss();
    };


    // --- Calculation Logic ---

    /**
     * ì…ë ¥ëœ ë§¤ìˆ˜ ìˆ˜ëŸ‰, ë§¤ë„ ë‹¨ê°€, ì„¸ìœ¨ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œì™€ ê±°ë˜ì„¸ ê¸ˆì•¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    window.updateFeeAndTaxFields = function() {
        const buyPrice = parseFloat(document.getElementById('buyPrice').value.replace(/,/g, '')) || 0;
        const quantity = parseFloat(document.getElementById('quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('sellPrice').value.replace(/,/g, '')) || 0;

        const feeRateInput = document.getElementById('feeRateInput').value.replace(/,/g, '');
        const taxRateInput = document.getElementById('taxRateInput').value.replace(/,/g, '');
        
        // feeRateì™€ taxRateëŠ” í¼ì„¼íŠ¸ ê°’ìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤ (ì˜ˆ: 0.015%ì—ì„œ 0.015)
        const feeRate = parseFloat(feeRateInput) || 0;
        const taxRate = parseFloat(taxRateInput) || 0;
        
        // ì´ ë§¤ìˆ˜ ë¹„ìš© (ì›ê¸ˆ)
        const totalBuyCost = buyPrice * quantity;
        // ì´ ë§¤ë„ ê¸ˆì•¡ (ì„¸ì „)
        const grossSellAmount = sellPrice * quantity;
        
        // ----------------------------------------------------
        // ìˆ˜ìˆ˜ë£Œ: ë§¤ìˆ˜ ê¸ˆì•¡ê³¼ ë§¤ë„ ê¸ˆì•¡ ëª¨ë‘ì— ê°ê° ì ìš©
        // ----------------------------------------------------
        const feeRateFactor = feeRate / 100; // 0.015 -> 0.00015 (ë¹„ìœ¨)
        
        const calculatedFeeOnBuy = totalBuyCost * feeRateFactor;
        const calculatedFeeOnSell = grossSellAmount * feeRateFactor;

        // ìµœì¢… ì´ ìˆ˜ìˆ˜ë£Œ (ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ + ë§¤ë„ ìˆ˜ìˆ˜ë£Œ)
        const totalCalculatedFee = calculatedFeeOnBuy + calculatedFeeOnSell;
        
        // ----------------------------------------------------
        // ê±°ë˜ì„¸: ì´ ë§¤ë„ ê¸ˆì•¡ì—ë§Œ ì ìš©
        // ----------------------------------------------------
        const taxRateFactor = taxRate / 100; // 0.15 -> 0.0015 (ë¹„ìœ¨)
        const calculatedTax = grossSellAmount * taxRateFactor;
        
        document.getElementById('calculatedFeeAmount').value = formatCurrency(totalCalculatedFee);
        document.getElementById('calculatedTaxAmount').value = formatCurrency(calculatedTax);
    }

    /**
     * ì£¼ì‹ ê±°ë˜ì˜ ì†ìµë¥ ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
     */
    window.calculateProfitLoss = function() {
        updateFeeAndTaxFields(); // ìµœì‹  ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ê¸ˆì•¡ ê³„ì‚°

        const buyPrice = parseFloat(document.getElementById('buyPrice').value.replace(/,/g, '')) || 0;
        const quantity = parseFloat(document.getElementById('quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('sellPrice').value.replace(/,/g, '')) || 0;
        
        // ëª¨ë“  í•µì‹¬ ì…ë ¥ê°’ì´ 0ì¸ ê²½ìš° ê²°ê³¼ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
        if (buyPrice === 0 && quantity === 0 && sellPrice === 0) {
            document.getElementById('result').style.display = 'none';
            return;
        }

        // ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œì™€ ê±°ë˜ì„¸ ê¸ˆì•¡ì„ í¬ë§·ë˜ì§€ ì•Šì€ ìˆ«ìë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const totalFee = parseFloat(document.getElementById('calculatedFeeAmount').value.replace(/,/g, '')) || 0;
        const totalTax = parseFloat(document.getElementById('calculatedTaxAmount').value.replace(/,/g, '')) || 0;
        const totalDeductions = totalFee + totalTax; // ì´ ê³µì œì•¡

        const totalBuyCost = buyPrice * quantity;
        const totalQuantity = quantity;

        const grossSellAmount = sellPrice * totalQuantity; 
        
        // 1. ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„): (ë§¤ë„ ê¸ˆì•¡) - (ì´ ë§¤ìˆ˜ ë¹„ìš©) - (ì´ ê³µì œì•¡)
        const netProfitLoss = grossSellAmount - totalDeductions - totalBuyCost;
        
        // 2. ìµœì¢… ì†ìµë¥ : ìˆœì´ìµ/ì†ì‹¤ì„ ì´ ë§¤ìˆ˜ ë¹„ìš©ìœ¼ë¡œ ë‚˜ëˆˆ ê°’
        let profitRate = 0;
        if (totalBuyCost > 0) {
            profitRate = (netProfitLoss / totalBuyCost) * 100;
        } else if (netProfitLoss > 0) {
            profitRate = Infinity;
        }

        // 3. (ì°¸ê³ ìš©) ë‹¨ìˆœ ë§¤ë§¤ì°¨ìµ: ìˆ˜ìˆ˜ë£Œì™€ ì„¸ê¸ˆì„ ê³ ë ¤í•˜ì§€ ì•Šì€ ì‹œì„¸ ì°¨ìµ
        const simpleProfit = grossSellAmount - totalBuyCost;

        // 4. (ì°¸ê³ ìš©) ë‹¨ìˆœ ë§¤ë§¤ì°¨ìµë¥ : ë‹¨ìˆœ ì°¨ìµì„ ì´ ë§¤ìˆ˜ ë¹„ìš©ìœ¼ë¡œ ë‚˜ëˆˆ ê°’ (ì™¸ë¶€ íˆ´ 9.31%ì— í•´ë‹¹í•˜ëŠ” ê°’)
        let simpleProfitRate = 0;
        if (totalBuyCost > 0) {
            simpleProfitRate = (simpleProfit / totalBuyCost) * 100;
        } else if (simpleProfit > 0) {
            simpleProfitRate = Infinity;
        }


        // 5. ê²°ê³¼ ì¶œë ¥ (í…Œì´ë¸” í˜•ì‹)
        const profitRateText = (isFinite(profitRate) ? profitRate.toFixed(2) : 'N/A') + '%';
        const simpleProfitRateText = (isFinite(simpleProfitRate) ? simpleProfitRate.toFixed(2) : 'N/A') + '%';

        // ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„) í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²°ì •
        let netResultClass = 'net-result neutral-text';
        if (netProfitLoss > 0) {
            netResultClass = 'net-result profit-text'; 
        } else if (netProfitLoss < 0) {
            netResultClass = 'net-result loss-text'; 
        } else {
            netResultClass = 'net-result neutral-text';
        }

        // ìµœì¢… ì†ìµë¥  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²°ì •
        let rateClass = 'neutral';
        if (netProfitLoss > 0) {
            rateClass = 'profit';
        } else if (netProfitLoss < 0) {
            rateClass = 'loss';
        }

        // ë§¤ë„ í›„ ìˆœíšŒìˆ˜ì•¡ ì¬ê³„ì‚°
        const feeRate = parseFloat(document.getElementById('feeRateInput').value.replace(/,/g, '')) || 0;
        const calculatedFeeOnSell = grossSellAmount * (feeRate / 100);
        const netProceedsAfterSellDeductions = grossSellAmount - (calculatedFeeOnSell + totalTax);

        const tableHTML = `
            <thead>
                <tr>
                    <th colspan="2" class="text-center bg-blue-100 rounded-t-lg">ê±°ë˜ ìš”ì•½</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>ì´ ë§¤ìˆ˜ ë¹„ìš© (ì›ê¸ˆ)</th>
                    <td class="value-col">${formatCurrency(totalBuyCost)} ì›</td>
                </tr>
                <tr>
                    <th>ì´ ë§¤ë„ ê¸ˆì•¡ (ì„¸ì „)</th>
                    <td class="value-col">${formatCurrency(grossSellAmount)} ì›</td>
                </tr>
                <tr>
                    <!-- í…ìŠ¤íŠ¸ ê¸¸ì´ ì¶•ì†Œ: ì´ ê³µì œì•¡ (ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ìˆ˜ë£Œ + ê±°ë˜ì„¸) -> ì´ ê³µì œì•¡ -->
                    <th><span class="deduction-color">ì´ ê³µì œì•¡</span></th>
                    <td class="value-col deduction-color">- ${formatCurrency(totalDeductions)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <!-- í…ìŠ¤íŠ¸ ê¸¸ì´ ì¶•ì†Œ: ã„´ ì´ ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œ (ë§¤ìˆ˜/ë§¤ë„ í•©ì‚°) -> ã„´ ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œ (ì´ì•¡) -->
                    <th style="padding-left: 20px;">ã„´ ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œ (ì´ì•¡)</th>
                    <td class="value-col">- ${formatCurrency(totalFee)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <!-- í…ìŠ¤íŠ¸ ê¸¸ì´ ì¶•ì†Œ: ã„´ ì´ ê±°ë˜ì„¸ (ë§¤ë„ ì‹œ) -> ã„´ ê±°ë˜ì„¸ -->
                    <th style="padding-left: 20px;">ã„´ ê±°ë˜ì„¸</th>
                    <td class="value-col">- ${formatCurrency(totalTax)} ì›</td>
                </tr>
                
                <!-- ë§¤ë„ í›„ ìˆœíšŒìˆ˜ì•¡ (ì„¸í›„) -->
                <tr class="bg-indigo-50">
                    <th class="font-bold">ë§¤ë„ í›„ ìˆœíšŒìˆ˜ì•¡ (ì„¸í›„)</th>
                    <td class="value-col net-proceeds-color">${formatCurrency(netProceedsAfterSellDeductions)} ì›</td>
                </tr>

                <tr class="bg-gray-50">
                    <th>ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„)</th>
                    <td class="value-col">
                        <span class="${netResultClass}">${formatCurrency(netProfitLoss)} ì›</span>
                    </td>
                </tr>
                <!-- í…ìŠ¤íŠ¸ ê¸¸ì´ ì¶•ì†Œ: ìµœì¢… ì†ìµë¥  (ì„¸í›„ ìˆœìˆ˜ìµë¥ ) -> ìµœì¢… ì†ìµë¥  (ì„¸í›„) -->
                <tr class="font-bold text-lg bg-yellow-100">
                    <th><span class="text-blue-600">ìµœì¢… ì†ìµë¥  (ì„¸í›„)</span></th>
                    <td class="value-col">
                        <span class="${rateClass}">${profitRateText}</span>
                    </td>
                </tr>
                <!-- í…ìŠ¤íŠ¸ ê¸¸ì´ ì¶•ì†Œ: ì°¸ê³ : ë‹¨ìˆœ ìˆ˜ìµë¥  (ë¹„ìš© ë¯¸ë°˜ì˜) -> ì°¸ê³ : ë‹¨ìˆœ ìˆ˜ìµë¥  (ì„¸ì „) -->
                <tr>
                    <th>ì°¸ê³ : ë‹¨ìˆœ ìˆ˜ìµë¥  (ì„¸ì „)</th>
                    <td class="value-col">
                        <span class="${rateClass}">${simpleProfitRateText}</span>
                    </td>
                </tr>
            </tbody>
        `;

        document.getElementById('resultTable').innerHTML = tableHTML;
        document.getElementById('result').style.display = 'block';
    }
    
    /**
     * ì¿ í‚¤ì— ì €ì¥ëœ ëª¨ë“  ê°’ì„ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ì›ë‹ˆë‹¤.
     */
    function loadFromCookies() {
        // í†µí™” ê´€ë ¨ ì¿ í‚¤ ë¡œë“œ
        const buyPriceInput = document.getElementById('buyPrice');
        const quantityInput = document.getElementById('quantity');
        const sellPriceInput = document.getElementById('sellPrice');
        
        const storedPrice = getCookie('stockBuyPrice');
        const storedQuantity = getCookie('stockQuantity');
        const storedSellPrice = getCookie('stockSellPrice'); // ë§¤ë„ ë‹¨ê°€ ì¿ í‚¤ ë¡œë“œ

        
        // 1. ë§¤ìˆ˜ ë‹¨ê°€
        if (storedPrice !== null && storedPrice !== "") {
            buyPriceInput.value = storedPrice;
            window.formatCurrencyInput(buyPriceInput); 
        } else {
             buyPriceInput.value = formatCurrency(0);
        }
        
        // 2. ìˆ˜ëŸ‰
        if (storedQuantity !== null && storedQuantity !== "") {
            quantityInput.value = storedQuantity;
            window.formatCurrencyInput(quantityInput);
        } else {
            quantityInput.value = formatCurrency(0);
        }

        // 3. ë§¤ë„ ë‹¨ê°€
        if (storedSellPrice !== null && storedSellPrice !== "") {
            sellPriceInput.value = storedSellPrice;
            window.formatCurrencyInput(sellPriceInput);
        } else {
            sellPriceInput.value = formatCurrency(0);
        }
        
        // ì„¸ìœ¨ ê´€ë ¨ ì¿ í‚¤ ë¡œë“œ
        const feeRateInput = document.getElementById('feeRateInput');
        const taxRateInput = document.getElementById('taxRateInput');

        const storedFeeRate = getCookie('stockFeeRate');
        const storedTaxRate = getCookie('stockTaxRate');
        
        feeRateInput.value = (storedFeeRate !== null && storedFeeRate !== "") ? storedFeeRate : DEFAULT_FEE_RATE;
        taxRateInput.value = (storedTaxRate !== null && storedTaxRate !== "") ? storedTaxRate : DEFAULT_TAX_RATE;
        
        // ì¿ í‚¤ ë¡œë“œ í›„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ í•„ë“œ ì—…ë°ì´íŠ¸ (ê¸ˆì•¡ ê³„ì‚°)
        updateFeeAndTaxFields();

        // ì´ˆê¸° ë¡œë“œ í›„ ìë™ ê³„ì‚° ì‹¤í–‰
        calculateProfitLoss();
    }

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        loadFromCookies(); // 1. ì¿ í‚¤ì—ì„œ ëª¨ë“  ê°’ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì´ˆê¸° ê³„ì‚° ì‹¤í–‰

        // 'ì†ìµë¥  ê³„ì‚°í•˜ê¸°' ë²„íŠ¼ì´ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ, ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” í•„ìš” ì—†ìŒ.
    });

</script>
</body>
</html>

