<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ë¬¼íƒ€ê¸° ì†ìµ ì‹œë®¬ë ˆì´í„° (ê¸°ë³¸ ì„¤ì •)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        
        .calculator {
            max-width: 500px;
            margin: 20px auto;
            background: #ffffff;
            padding: 16px 12px; 
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
            display: block;
            margin-bottom: 0.25rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 32px;
            height: 32px;
            line-height: 1;
            font-size: 1.1rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ì´ íŒŒì¼ì—ì„œëŠ” ë¯¸ì‚¬ìš©ë˜ì§€ë§Œ, ì¼ê´€ì„±ì„ ìœ„í•´ ì •ì˜ ìœ ì§€) */
        .result-table, .cost-color, .break-even-price-color, .profit-text, .loss-text, .neutral-text, .pre-dca-result {
            /* Styles related to result/profit will not apply here but are kept for completeness */
        }
        
        /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #2ecc71;
            border-radius: 4px;
        }
        
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    <h2 class="text-2xl font-bold text-center text-indigo-800 border-b-4 border-indigo-500 pb-3 mb-6">ğŸ“ˆ ê¸°ë³¸ ë³´ìœ  ì •ë³´ ë° ë¹„ìš© ì„¤ì •</h2>
    <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ë°ì´í„°ê°€ ì €ì¥ë˜ë©°, **ì£¼ì‹ê³„ì‚°ê¸° íƒ­**ì—ì„œ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

    
    <!-- 1. í˜„ì¬ ì‹œì¥ ê°€ê²© ì„¹ì…˜ -->
    <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg mb-6">
        <h3 class="text-xl font-semibold text-indigo-800 mb-4">1. í˜„ì¬ ì‹œì¥ ê°€ê²©</h3>
        
        <!-- í˜„ì¬ ì£¼ê°€ -->
        <div class="input-group">
            <label for="currentMarketPrice">í˜„ì¬ ì£¼ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="currentMarketPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaMarketPrice')" inputmode="numeric" class="w-full text-lg font-bold text-indigo-700">
                <button type="button" onclick="resetIndividualInput('currentMarketPrice', 'dcaMarketPrice', '0', 'currency')" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
    </div>

    <!-- 2. í˜„ì¬ ë³´ìœ  ì •ë³´ ì„¹ì…˜ -->
    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg mb-6">
        <h3 class="text-xl font-semibold text-blue-800 mb-4">2. í˜„ì¬ ë³´ìœ  ì •ë³´</h3>
        
        <!-- í˜„ì¬ í‰ë‹¨ê°€ -->
        <div class="input-group">
            <label for="currentPrice">í˜„ì¬ í‰ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="currentPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaCurrentPrice')" inputmode="numeric" class="w-full text-lg">
                <button type="button" onclick="resetIndividualInput('currentPrice', 'dcaCurrentPrice', '0', 'currency')" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
    
        <!-- í˜„ì¬ ìˆ˜ëŸ‰ -->
        <div class="input-group">
            <label for="currentQuantity">í˜„ì¬ ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜, ì£¼)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="currentQuantity" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaCurrentQuantity')" inputmode="numeric" class="w-full text-lg">
                <button type="button" onclick="resetIndividualInput('currentQuantity', 'dcaCurrentQuantity', '0', 'currency')" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
    </div>
    
    <!-- 4. ê±°ë˜ ë¹„ìš© ì„¤ì • ì„¹ì…˜ -->
    <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg mb-6">
        <h3 class="text-xl font-semibold text-yellow-800 mb-4">4. ê±°ë˜ ë¹„ìš© ì„¤ì • (%)</h3>
        
        <!-- ì´ ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œìœ¨ -->
        <div class="input-group">
            <label for="feeRateInput">ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%) 
                <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.015% â†’ 0.015 ì…ë ¥)</span>
            </label>
            <div class="flex items-center space-x-2">
                <input type="text" id="feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'dcaFeeRate');" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('feeRateInput', 'dcaFeeRate', '0.015', 'rate')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <!-- ë§¤ë„ ê±°ë˜ì„¸ìœ¨ -->
        <div class="input-group">
            <label for="taxRateInput">ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%) 
                <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.15% â†’ 0.15 ì…ë ¥)</span>
            </label>
            <div class="flex items-center space-x-2">
                <input type="text" id="taxRateInput" value="0.15" required oninput="handleRateInputAndSave(this, 'dcaTaxRate');" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('taxRateInput', 'dcaTaxRate', '0.15', 'rate')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
    </div>
    
</div>

<!-- ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ì€ ì¿ í‚¤ ê´€ë¦¬ë¥¼ ìœ„í•´ ì´ íŒŒì¼ì—ë„ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. -->
<script type="module">
    // --- Global State & Configuration ---
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.15;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %
    let purchaseEntryIdCounter = 0; // ë™ì  í•­ëª© ê³ ìœ  ID ìƒì„±ìš© ì¹´ìš´í„°


    // --- Cookie Helper Functions ---

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function setCookie(name, value) {
        const date = new Date();
        date.setTime(date.getTime() + (30*24*60*60*1000)); // 30 days expiration
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
    }

    // --- Format & Input Handlers ---

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤. (ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ ì¶”ê°€)
     * (ì´ íŒŒì¼ì—ì„œëŠ” í¬ë§·ëœ ê°’ì´ í™”ë©´ì— ì§ì ‘ í‘œì‹œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê°„ë‹¨íˆ êµ¬í˜„)
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const absoluteAmount = Math.abs(amount);
        
        if (precision === 0) {
            return Math.floor(absoluteAmount).toLocaleString('ko-KR', { maximumFractionDigits: 0 });
        }
        return absoluteAmount.toLocaleString('ko-KR', { minimumFractionDigits: precision, maximumFractionDigits: precision });
    }


    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. 
     */
    window.formatCurrencyInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 

        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = ''; 
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
        
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë‹¨ê°€/ìˆ˜ëŸ‰/ê¸ˆì•¡)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë©°, ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.handleCurrencyInputAndSave = function(input, cookieName) {
        // 1. í¬ë§·íŒ… ë° ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 
        
        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '') {
            input.value = '';
            // ì •ì  ì…ë ¥ í•„ë“œë§Œ ì¿ í‚¤ ì €ì¥
            if (cookieName) setCookie(cookieName, '');
            // calculateAllResults()ëŠ” ì´ íŒŒì¼ì—ì„œëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (ë‹¤ë¥¸ íŒŒì¼ì—ì„œ ìµœì¢… ê³„ì‚°)
            return; 
        }
        
        // 0 ì…ë ¥ ì‹œ ë¹ˆ ë¬¸ìì—´ë¡œ í‘œì‹œ
        if (parseFloat(rawValue) === 0) {
            input.value = '';
        } else {
            const [integerPart, decimalPart] = rawValue.split('.');
            const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
            
            input.value = newValue;

            const diff = newValue.length - oldValue.length;
            let newCursorStart = cursorStart + diff;

            if (newValue.length > oldValue.length) {
                if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
            }
            
            newCursorStart = Math.min(newCursorStart, newValue.length);
            input.setSelectionRange(newCursorStart, newCursorStart);
        }
        
        // 2. ì¿ í‚¤ ì €ì¥ (ì •ì  ì…ë ¥ í•„ë“œë§Œ)
        if (cookieName) setCookie(cookieName, rawValue);

        // ì´ íŒŒì¼ì—ì„œëŠ” calculateAllResults()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³ , ë°ì´í„°ë§Œ ì¿ í‚¤ì— ì €ì¥í•©ë‹ˆë‹¤.
    }

    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ê³ , ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.handleRateInputAndSave = function(input, cookieName) {
        const rawValue = input.value.replace(/,/g, ''); 
        
        if (!isNaN(parseFloat(rawValue))) {
            setCookie(cookieName, rawValue);
        }
        
        // ì´ íŒŒì¼ì—ì„œëŠ” calculateAllResults()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³ , ë°ì´í„°ë§Œ ì¿ í‚¤ì— ì €ì¥í•©ë‹ˆë‹¤.
    }
    
    /**
     * ê°œë³„ ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ê³  ì¿ í‚¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.resetIndividualInput = function(inputId, cookieName, defaultValue, type) {
        const input = document.getElementById(inputId);
        
        if (type === 'currency') {
            // í†µí™”/ìˆ˜ëŸ‰ ì…ë ¥ì€ 0ì¼ ë•Œ ë¹ˆ ë¬¸ìì—´ë¡œ í‘œì‹œ
            input.value = ""; 
            setCookie(cookieName, defaultValue); 
        } else { // rate
            input.value = defaultValue; 
            setCookie(cookieName, defaultValue);
        }
        
        // ì´ íŒŒì¼ì—ì„œëŠ” calculateAllResults()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³ , ë°ì´í„°ë§Œ ì¿ í‚¤ì— ì €ì¥í•©ë‹ˆë‹¤.
    };


    // --- Dynamic Purchase Entry Handlers (Cal2.htmlì—ë§Œ í•„ìš”í•˜ë¯€ë¡œ, ì´ íŒŒì¼ì—ì„œëŠ” ë”ë¯¸ í•¨ìˆ˜) ---

    window.addPurchaseEntry = function() { /* Do nothing here */ };
    window.removePurchaseEntry = function(id) { /* Do nothing here */ };


    // --- Calculation Logic (Cal2.htmlì—ë§Œ í•„ìš”í•˜ë¯€ë¡œ, ì´ íŒŒì¼ì—ì„œëŠ” ë”ë¯¸ í•¨ìˆ˜) ---

    window.calculateAllResults = function() { /* Do nothing here */ };

    /**
     * ì¿ í‚¤ì— ì €ì¥ëœ ëª¨ë“  ê°’ì„ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ì›ë‹ˆë‹¤.
     */
    function loadFromCookies() {
        // í†µí™”/ìˆ˜ëŸ‰ ë¡œë“œ (ì •ì  í•„ë“œ)
        const currencyInputs = [
            { id: 'currentPrice', cookie: 'dcaCurrentPrice', default: '0' },
            { id: 'currentQuantity', cookie: 'dcaCurrentQuantity', default: '0' },
            { id: 'currentMarketPrice', cookie: 'dcaMarketPrice', default: '0' }
        ];

        currencyInputs.forEach(item => {
            const input = document.getElementById(item.id);
            const storedValue = getCookie(item.cookie);
            
            if (storedValue !== null && storedValue !== "" && parseFloat(storedValue) !== 0) {
                input.value = storedValue;
                window.formatCurrencyInput(input); 
            } 
        });
        
        // ë¹„ìœ¨ ë¡œë“œ (ë¹„ìš© í•„ë“œ)
        const feeRateInput = document.getElementById('feeRateInput');
        const taxRateInput = document.getElementById('taxRateInput');

        const storedFeeRate = getCookie('dcaFeeRate');
        const storedTaxRate = getCookie('dcaTaxRate');
        
        feeRateInput.value = (storedFeeRate !== null && storedFeeRate !== "") ? storedFeeRate : DEFAULT_FEE_RATE;
        taxRateInput.value = (storedTaxRate !== null && storedTaxRate !== "") ? storedTaxRate : DEFAULT_TAX_RATE;
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
        loadFromCookies(); 
    });

</script>
</body>
</html>

