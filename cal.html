<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ì†ìµë¥  ê³„ì‚°ê¸° (ì„¸ìœ¨ ìˆ˜ì • ë° ì¿ í‚¤ ì €ì¥)</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        body {
            font-family: 'Inter', Arial, sans-serif;
            padding: 20px;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        /* ê³„ì‚°ê¸° ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .calculator {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
        }
        .rate-info {
            font-size: 0.8em;
            color: #7f8c8d;
            font-weight: normal;
        }
        /* ì…ë ¥ í•„ë“œ ê·¸ë£¹ */
        .input-group {
            margin-bottom: 15px;
        }
        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
            text-align: right;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        /* Readonly í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[readonly] {
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: default;
        }
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            width: 100%;
            padding: 14px;
            margin-top: 30px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:active {
            transform: scale(0.99);
        }
        /* ê²°ê³¼ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .result {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #2ecc71;
            border-radius: 10px;
            background-color: #e8f8f5;
            text-align: center;
        }
        .result h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .result p {
            margin: 8px 0;
            font-size: 1em;
        }
        /* ì†ìµë¥  í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .profit {
            color: #2ecc71; /* ìƒìŠ¹ (ì´ˆë¡) */
            font-size: 1.6em;
            font-weight: bold;
        }
        .loss {
            color: #e74c3c; /* í•˜ë½ (ë¹¨ê°•) */
            font-size: 1.6em;
            font-weight: bold;
        }
        .neutral {
            color: #34495e; /* ì¤‘ë¦½ (íšŒìƒ‰) */
            font-size: 1.6em;
            font-weight: bold;
        }
        /* ë°©ë¬¸ì ì¹´ìš´í„° ìŠ¤íƒ€ì¼ */
        .visitor-counter {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9em;
            color: #555;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 500px) {
            .calculator {
                padding: 15px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>

<div class="calculator">
    <h2>ğŸ“ˆ ì£¼ì‹ ê±°ë˜ ì†ìµë¥  ê³„ì‚°ê¸°</h2>

    <!-- ë§¤ìˆ˜ ì •ë³´ ì„¹ì…˜ (ì¿ í‚¤ ì €ì¥) -->
    <div class="input-group">
        <label for="buyPrice">1. ë§¤ìˆ˜ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
        <input type="text" id="buyPrice" value="10,000" required oninput="handleCurrencyInputAndSave(this, 'stockBuyPrice')" inputmode="numeric">
    </div>

    <div class="input-group">
        <label for="quantity">2. ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜)</label>
        <input type="text" id="quantity" value="100" required oninput="handleCurrencyInputAndSave(this, 'stockQuantity')" inputmode="numeric">
    </div>

    <!-- ë§¤ë„ ì •ë³´ ì„¹ì…˜ -->
    <div class="input-group">
        <label for="sellPrice">3. ë§¤ë„ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
        <input type="text" id="sellPrice" value="12,000" required oninput="parseAndFormatInput(this); updateFeeAndTaxFields();" inputmode="numeric">
    </div>
    
    <!-- 4. ìˆ˜ìˆ˜ë£Œìœ¨ ì…ë ¥ ë° ê³„ì‚° ê¸ˆì•¡ í‘œì‹œ -->
    <div class="input-group">
        <label for="feeRateInput">4. ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ <span class="rate-info">(ì´ ë§¤ë„ ê¸ˆì•¡ ëŒ€ë¹„, ì˜ˆ: 0.015)</span></label>
        <input type="text" id="feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'stockFeeRate');" inputmode="decimal">
    </div>
    <div class="input-group">
        <label for="calculatedFeeAmount">4-1. ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡ (ì›)</label>
        <input type="text" id="calculatedFeeAmount" value="0" required readonly>
    </div>

    <!-- 5. ê±°ë˜ì„¸ìœ¨ ì…ë ¥ ë° ê³„ì‚° ê¸ˆì•¡ í‘œì‹œ -->
    <div class="input-group">
        <label for="taxRateInput">5. ë§¤ë„ ê±°ë˜ì„¸ìœ¨ <span class="rate-info">(ì´ ë§¤ë„ ê¸ˆì•¡ ëŒ€ë¹„, ì˜ˆ: 0.2)</span></label>
        <input type="text" id="taxRateInput" value="0.2" required oninput="handleRateInputAndSave(this, 'stockTaxRate');" inputmode="decimal">
    </div>
    <div class="input-group">
        <label for="calculatedTaxAmount">5-1. ê³„ì‚°ëœ ê±°ë˜ì„¸ ê¸ˆì•¡ (ì›)</label>
        <input type="text" id="calculatedTaxAmount" value="0" required readonly>
    </div>
    
    <button id="calculateButton">ì†ìµë¥  ê³„ì‚°í•˜ê¸°</button>

    <div id="result" class="result" style="display: none;">
        <h3>ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
        
        <p>ì´ ë§¤ìˆ˜ ë¹„ìš© (ì›ê¸ˆ): <span id="totalBuy"></span>ì›</p>
        <p>ì´ íšŒìˆ˜ ê¸ˆì•¡ (ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ì°¨ê°): <span id="totalSell"></span>ì›</p>
        <p>ìˆœì´ìµ/ì†ì‹¤: <span id="netProfit"></span>ì›</p>
        <p>ìµœì¢… ì†ìµë¥ :</p>
        <div id="profitRateContainer">
            <span id="profitRate" class="neutral"></span>
        </div>
    </div>

    <!-- ë°©ë¬¸ì ì¹´ìš´í„° -->
    <div class="visitor-counter">
        ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜: <span id="visitorCount">0</span>ëª…
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, query, where, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firestore ë° App ID ì„¤ì •
    let db;
    let auth;
    let appId;
    const DAILY_VISITORS_COLLECTION = "daily_visits";
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.2;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %


    // --- Cookie Helper Functions ---

    /**
     * ì¿ í‚¤ì—ì„œ ì§€ì •ëœ ì´ë¦„ì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
     * @param {string} name ì¿ í‚¤ ì´ë¦„
     * @returns {string|null} ì¿ í‚¤ ê°’ ë˜ëŠ” null
     */
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    /**
     * ì¿ í‚¤ì— ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤. (ë§Œë£Œì¼ 30ì¼ ì„¤ì •)
     * @param {string} name ì¿ í‚¤ ì´ë¦„
     * @param {string} value ì €ì¥í•  ê°’
     */
    function setCookie(name, value) {
        const date = new Date();
        date.setTime(date.getTime() + (30*24*60*60*1000)); // 30 days expiration
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
    }

    // --- Format & Input Handlers ---

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤. (ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ ì¶”ê°€)
     * @param {number} amount - ê¸ˆì•¡
     * @param {number} [precision=0] - ì†Œìˆ˜ì  ì´í•˜ ìë¦¿ìˆ˜ (ê¸°ë³¸ê°’: 0, ì •ìˆ˜)
     * @returns {string} í¬ë§·ëœ ë¬¸ìì—´
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const fixedAmount = amount.toFixed(precision);
        const parts = fixedAmount.split('.');
        const integerPart = parts[0];
        const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return formattedIntegerPart + decimalPart;
    }

    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ(,)ë¡œ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. (ë§¤ë„ ë‹¨ê°€ìš©)
     */
    window.parseAndFormatInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9]/g, ''); 

        if (rawValue === '') {
            input.value = '';
            return; 
        }

        const newValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë§¤ìˆ˜ ë‹¨ê°€/ìˆ˜ëŸ‰)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë©°, ìˆ˜ìˆ˜ë£Œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     * @param {string} cookieName ì €ì¥í•  ì¿ í‚¤ ì´ë¦„
     */
    window.handleCurrencyInputAndSave = function(input, cookieName) {
        // 1. í¬ë§·íŒ… ë° ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9]/g, ''); 

        if (rawValue === '') {
            input.value = '';
            setCookie(cookieName, '');
            updateFeeAndTaxFields();
            return; 
        }

        const newValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
        
        // 2. ì¿ í‚¤ ì €ì¥ (ì‰¼í‘œ ì—†ëŠ” ì›ì‹œ ê°’ì„ ì €ì¥)
        setCookie(cookieName, rawValue);

        // 3. ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì—…ë°ì´íŠ¸
        updateFeeAndTaxFields();
    }
    
    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ê³ , ìˆ˜ìˆ˜ë£Œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     * @param {string} cookieName ì €ì¥í•  ì¿ í‚¤ ì´ë¦„
     */
    window.handleRateInputAndSave = function(input, cookieName) {
        // ì‰¼í‘œë§Œ ì œê±°í•˜ê³  ì‹¤ìˆ˜ ê·¸ëŒ€ë¡œ ì €ì¥
        const rawValue = input.value.replace(/,/g, ''); 
        
        // ìœ íš¨í•œ ìˆ«ìì¸ ê²½ìš°ë§Œ ì €ì¥
        if (!isNaN(parseFloat(rawValue))) {
            setCookie(cookieName, rawValue);
        }
        
        // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì—…ë°ì´íŠ¸
        updateFeeAndTaxFields();
    }


    // --- Calculation Logic ---

    /**
     * ì…ë ¥ëœ ë§¤ìˆ˜ ìˆ˜ëŸ‰, ë§¤ë„ ë‹¨ê°€, ì„¸ìœ¨ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œì™€ ê±°ë˜ì„¸ ê¸ˆì•¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    window.updateFeeAndTaxFields = function() {
        // 1. í•„ìš” ê°’ ê°€ì ¸ì˜¤ê¸°
        const quantity = parseFloat(document.getElementById('quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('sellPrice').value.replace(/,/g, '')) || 0;

        // ì„¸ìœ¨ ê°€ì ¸ì˜¤ê¸° (ì…ë ¥ê°’ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ê°„ì£¼)
        const feeRateInput = document.getElementById('feeRateInput').value.replace(/,/g, '');
        const taxRateInput = document.getElementById('taxRateInput').value.replace(/,/g, '');
        
        const feeRate = parseFloat(feeRateInput) || 0;
        const taxRate = parseFloat(taxRateInput) || 0;
        
        // 2. ì´ ë§¤ë„ ê¸ˆì•¡ ê³„ì‚°
        const grossSellAmount = sellPrice * quantity;
        
        // 3. ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ê³„ì‚° (ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì€ í¼ì„¼íŠ¸(%)ì´ë¯€ë¡œ 100ìœ¼ë¡œ ë‚˜ëˆ”)
        const calculatedFee = grossSellAmount * (feeRate / 100);
        const calculatedTax = grossSellAmount * (taxRate / 100);
        
        // 4. ì½ê¸° ì „ìš© í•„ë“œ ì—…ë°ì´íŠ¸ (ì •ìˆ˜ë¡œ í¬ë§·)
        document.getElementById('calculatedFeeAmount').value = formatCurrency(calculatedFee);
        document.getElementById('calculatedTaxAmount').value = formatCurrency(calculatedTax);
    }

    /**
     * ì£¼ì‹ ê±°ë˜ì˜ ì†ìµë¥ ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
     */
    window.calculateProfitLoss = function() {
        updateFeeAndTaxFields(); // í•„ë“œê°€ ìµœì‹  ê°’ì¸ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ì¬ì‹¤í–‰
        
        // 1. ì…ë ¥ ê°’ ê°€ì ¸ì˜¤ê¸° (ê³„ì‚°ì— í•„ìš”í•œ ìˆœìˆ˜ ìˆ«ì ê°’)
        const buyPrice = parseFloat(document.getElementById('buyPrice').value.replace(/,/g, '')) || 0;
        const quantity = parseFloat(document.getElementById('quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('sellPrice').value.replace(/,/g, '')) || 0;
        
        // ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ê¸ˆì•¡ (ì½ê¸° ì „ìš© í•„ë“œì—ì„œ ê°€ì ¸ì˜´)
        const totalFee = parseFloat(document.getElementById('calculatedFeeAmount').value.replace(/,/g, '')) || 0;
        const totalTax = parseFloat(document.getElementById('calculatedTaxAmount').value.replace(/,/g, '')) || 0;

        // 2. ì´ ë§¤ìˆ˜ ì›ê¸ˆ ê³„ì‚°
        const totalBuyCost = buyPrice * quantity;
        const totalQuantity = quantity;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (totalQuantity <= 0) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = "<h3>ê²½ê³ </h3><p style='color:#e74c3c;'>ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.</p>";
            resultDiv.style.display = 'block';
            return;
        }

        // 3. ì´ ë§¤ë„ ê¸ˆì•¡ ê³„ì‚° (ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ì°¨ê°)
        const grossSellAmount = sellPrice * totalQuantity; 
        const totalSell = grossSellAmount - (totalFee + totalTax); 

        // 4. ìˆœì´ìµ/ì†ì‹¤ ë° ì†ìµë¥  ê³„ì‚°
        const netProfitLoss = totalSell - totalBuyCost;
        
        let profitRate = 0;
        if (totalBuyCost > 0) {
            profitRate = (netProfitLoss / totalBuyCost) * 100;
        }

        // 5. ê²°ê³¼ ì¶œë ¥
        document.getElementById('totalBuy').textContent = formatCurrency(totalBuyCost);
        document.getElementById('totalSell').textContent = formatCurrency(totalSell);
        document.getElementById('netProfit').textContent = formatCurrency(netProfitLoss);
        
        const profitRateElement = document.getElementById('profitRate');
        profitRateElement.textContent = profitRate.toFixed(2) + '%';
        
        // ìƒ‰ìƒ ë° í´ë˜ìŠ¤ ë³€ê²½
        profitRateElement.classList.remove('profit', 'loss', 'neutral');
        
        if (netProfitLoss > 0) {
            profitRateElement.classList.add('profit');
        } else if (netProfitLoss < 0) {
            profitRateElement.classList.add('loss');
        } else {
            profitRateElement.classList.add('neutral');
        }

        document.getElementById('result').style.display = 'block';
    }
    
    /**
     * ì¿ í‚¤ì— ì €ì¥ëœ ë§¤ìˆ˜ ë‹¨ê°€, ìˆ˜ëŸ‰, ì„¸ìœ¨ì„ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ì›ë‹ˆë‹¤.
     */
    function loadFromCookies() {
        // í†µí™” ê´€ë ¨ ì¿ í‚¤ ë¡œë“œ
        const buyPriceInput = document.getElementById('buyPrice');
        const quantityInput = document.getElementById('quantity');
        
        const storedPrice = getCookie('stockBuyPrice');
        const storedQuantity = getCookie('stockQuantity');
        
        if (storedPrice !== null && storedPrice !== "") {
            buyPriceInput.value = storedPrice;
            window.parseAndFormatInput(buyPriceInput); 
        }
        
        if (storedQuantity !== null && storedQuantity !== "") {
            quantityInput.value = storedQuantity;
            window.parseAndFormatInput(quantityInput);
        }
        
        // ì„¸ìœ¨ ê´€ë ¨ ì¿ í‚¤ ë¡œë“œ
        const feeRateInput = document.getElementById('feeRateInput');
        const taxRateInput = document.getElementById('taxRateInput');

        const storedFeeRate = getCookie('stockFeeRate');
        const storedTaxRate = getCookie('stockTaxRate');
        
        if (storedFeeRate !== null && storedFeeRate !== "") {
            feeRateInput.value = storedFeeRate;
        } else {
            feeRateInput.value = DEFAULT_FEE_RATE;
        }

        if (storedTaxRate !== null && storedTaxRate !== "") {
            taxRateInput.value = storedTaxRate;
        } else {
            taxRateInput.value = DEFAULT_TAX_RATE;
        }
        
        // ì¿ í‚¤ ë¡œë“œ í›„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ í•„ë“œ ì—…ë°ì´íŠ¸ (ê¸ˆì•¡ ê³„ì‚°)
        updateFeeAndTaxFields();
    }


    /**
     * Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì˜¤ëŠ˜ ì ‘ì†ì ì¹´ìš´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    async function initializeFirebaseAndCounter() {
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Counter will not work.");
            return;
        }
        
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayDateKey = today.toISOString().split('T')[0];
        
        try {
            const userCredential = initialAuthToken 
                ? await signInWithCustomToken(auth, initialAuthToken) 
                : await signInAnonymously(auth);
            
            const userId = userCredential.user.uid;
            
            const visitRef = doc(db, `artifacts/${appId}/public/data/${DAILY_VISITORS_COLLECTION}`, userId);
            
            await setDoc(visitRef, {
                visitTime: serverTimestamp(),
                dateKey: todayDateKey, 
                userId: userId 
            }, { merge: true });

            const visitorsCollectionRef = collection(db, `artifacts/${appId}/public/data/${DAILY_VISITORS_COLLECTION}`);
            
            const q = query(
                visitorsCollectionRef, 
                where("dateKey", "==", todayDateKey)
            );

            onSnapshot(q, (snapshot) => {
                const uniqueDailyVisitors = snapshot.size;
                document.getElementById('visitorCount').textContent = formatCurrency(uniqueDailyVisitors);
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                document.getElementById('visitorCount').textContent = 'Error';
            });

        } catch (error) {
            console.error("Firebase Authentication Error:", error);
        }
    }

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        loadFromCookies(); // 1. ì¿ í‚¤ì—ì„œ ëª¨ë“  ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        initializeFirebaseAndCounter(); // 2. Firebase ë° ì¹´ìš´í„° ì´ˆê¸°í™”

        document.getElementById('calculateButton').addEventListener('click', calculateProfitLoss);
    });

</script>
</body>
</html>

