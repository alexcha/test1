<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ê±°ë˜ ì†ìµë¥  ê³„ì‚°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        
        .calculator {
            max-width: 500px;
            margin: 0 auto;
            background: #ffffff;
            padding: 24px; /* íŒ¨ë”© ì¦ê°€ */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .input-group {
             margin-bottom: 1.5rem;
        }
        .input-group label {
            font-weight: 600; /* êµµê²Œ */
            color: #2c3e50;
            font-size: 0.95em;
            display: block;
            margin-bottom: 0.4rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1.1em;
            text-align: right;
            transition: border-color 0.3s, box-shadow 0.3s;
            padding: 0.6rem 0.85rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 36px;
            height: 36px;
            line-height: 1;
            font-size: 1.2rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 9999px; /* ì›í˜• */
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
            transform: rotate(-90deg);
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.95em; 
            table-layout: fixed; 
        }
        .result-table th, .result-table td {
            padding: 12px 10px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            word-break: break-word; 
        }
        .result-table th {
            background-color: #fafbfd;
            color: #34495e;
            font-weight: 600;
            width: 60%;
        }
        .result-table td {
            width: 40%;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: 700;
        }
        
        /* ì†ìµë¥  ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ */
        .pl-deduction-color {
            color: #6c757d; /* íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ */
            font-weight: normal;
        }
        .pl-net-proceeds-color {
            color: #2c3e50;
            font-weight: 800;
            font-size: 1.05em; 
        }
        .pl-profit-text {
            color: #e74c3c; /* í•œêµ­ì‹ ë¹¨ê°• (ìˆ˜ìµ) */
            font-weight: 800;
        }
        .pl-loss-text {
            color: #3498db; /* í•œêµ­ì‹ íŒŒë‘ (ì†ì‹¤) */
            font-weight: 800;
        }
        .pl-neutral-text {
            color: #34495e; 
            font-weight: 800;
        }

        /* ê³µí†µ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 20px;
            padding: 8px 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
        }

        /* History List Styling - ì •ëˆëœ ë””ìì¸ */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .history-item:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-color: #3498db;
        }
        .history-item-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.95em;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 15px;
        }
        .history-actions button {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s;
            margin-left: 8px;
            font-weight: 600;
        }
        .load-btn {
            background-color: #3498db;
            color: white;
            border: none;
        }
        .load-btn:hover {
            background-color: #2980b9;
        }
        .delete-btn {
            background-color: #f1f1f1;
            color: #e74c3c;
            border: 1px solid #ddd;
        }
        .delete-btn:hover {
            background-color: #ffe8e6;
            border-color: #e74c3c;
        }
        
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ì‹¤ì‹œê°„ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

    <div id="tab-profit-loss" class="tab-content">

        <div class="input-group">
            <label for="pl_buyPrice">1. ë§¤ìˆ˜ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_buyPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'stockBuyPrice'); calculateProfitLoss();" inputmode="numeric" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_buyPrice', 'stockBuyPrice', '0', 'currency'); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <div class="input-group">
            <label for="pl_quantity">2. ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_quantity" value="" required oninput="handleCurrencyInputAndSave(this, 'stockQuantity'); calculateProfitLoss();" inputmode="numeric" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_quantity', 'stockQuantity', '0', 'currency'); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <div id="bep_display" class="mb-5 p-4 bg-gray-50 border-2 border-gray-300 rounded-lg shadow-sm" style="display: none;">
            <p class="text-sm text-gray-700 font-semibold mb-1">ì†ìµë¶„ê¸° ë§¤ë„ ë‹¨ê°€ (BEP)</p>
            <p id="bep_value" class="text-2xl text-gray-800 font-extrabold text-right"></p>
        </div>
        <div class="input-group">
            <label for="pl_sellPrice">3. ë§¤ë„ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_sellPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'stockSellPrice'); calculateProfitLoss();" inputmode="numeric" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_sellPrice', 'stockSellPrice', '0', 'currency'); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
        
        <div class="input-group">
            <label for="pl_feeRateInput">4. ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'stockFeeRate'); calculateProfitLoss();" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_feeRateInput', 'stockFeeRate', '0.015', 'rate'); calculateProfitLoss();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <div class="input-group">
            <label for="pl_taxRateInput">5. ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_taxRateInput" value="0.15" required oninput="handleRateInputAndSave(this, 'stockTaxRate'); calculateProfitLoss();" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_taxRateInput', 'stockTaxRate', '0.15', 'rate'); calculateProfitLoss();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
        
        <div id="pl_result" class="result mt-6 p-4 border-2 border-green-500 bg-green-50 rounded-lg shadow-lg" style="display: none;">
            <h3 class="text-2xl font-bold text-gray-700 text-center mb-4">ğŸ’° ìµœì¢… ê³„ì‚° ê²°ê³¼</h3>
            <table id="pl_resultTable" class="result-table"></table>
        </div>
    </div>
    
    <div class="mt-10 pt-6 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-5 flex items-center">
            <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8V6a1 1 0 012 0v4h2a1 1 0 110 2h-2v2a1 1 0 11-2 0v-2H7a1 1 0 010-2h2z" clip-rule="evenodd"></path></svg>
            ê³„ì‚° ì €ì¥ ë° íˆìŠ¤í† ë¦¬
        </h2>
        
        <div class="p-4 mb-6 bg-yellow-50 border border-yellow-300 rounded-lg shadow-md">
            <label for="saveNameInput" class="font-bold text-yellow-800 mb-2 block">ì €ì¥ ì´ë¦„ ì…ë ¥:</label>
            <div class="flex space-x-2">
                <input type="text" id="saveNameInput" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì 1ì°¨ ë§¤ìˆ˜" class="w-full text-left p-2 border-yellow-400 focus:border-yellow-600 rounded-lg">
                <button onclick="saveCalculationLocal()" class="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700 transition duration-150 flex-shrink-0 whitespace-nowrap">
                    ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>

        <h3 class="text-xl font-semibold text-gray-700 mb-3">ì €ì¥ëœ ê³„ì‚° ëª©ë¡ (Local Storage)</h3>
        <div id="history-list" class="space-y-2 p-3 bg-white rounded-lg border border-gray-200 shadow-inner">
            <p id="no-history-message" class="text-gray-500 text-sm text-center py-4">ì €ì¥ëœ ê³„ì‚° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <p class="text-xs text-red-500 mt-3 p-1">âš ï¸ ì´ ê¸°ë¡ì€ í˜„ì¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©°, ë¸Œë¼ìš°ì €ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ ê¸°ë¡ì„ ì‚­ì œí•˜ë©´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
    </div>
    </div>


<script>
    // --- Global Configuration ---
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.15;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %
    const HISTORY_STORAGE_KEY = 'stockCalculatorHistory'; // Local Storage Key

    // --- Local Storage Helper Functions ---

    function getHistoryData() {
        const storedData = localStorage.getItem(HISTORY_STORAGE_KEY);
        try {
            return storedData ? JSON.parse(storedData) : [];
        } catch (e) {
            console.error("Error parsing history data from localStorage:", e);
            return [];
        }
    }

    function setHistoryData(data) {
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(data));
    }


    // --- History Data Operations (Local Storage) ---

    window.saveCalculationLocal = function() {
        const saveNameInput = document.getElementById('saveNameInput');
        let name = saveNameInput.value.trim();
        
        const currentBuyPrice = document.getElementById('pl_buyPrice').value.replace(/,/g, '');
        const currentQuantity = document.getElementById('pl_quantity').value.replace(/,/g, '');

        if (parseFloat(currentBuyPrice) === 0 || parseFloat(currentQuantity) === 0) {
            alert('ë§¤ìˆ˜ ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì•¼ ê³„ì‚° ê¸°ë¡ì„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        if (name === '') {
            const date = new Date().toLocaleTimeString('ko-KR');
            name = `ë¯¸ì§€ì • ì €ì¥ (${date})`;
        }
        
        const dataToSave = {
            id: Date.now().toString(), 
            name: name,
            buyPrice: currentBuyPrice,
            quantity: currentQuantity,
            sellPrice: document.getElementById('pl_sellPrice').value.replace(/,/g, ''),
            feeRate: document.getElementById('pl_feeRateInput').value.replace(/,/g, ''),
            taxRate: document.getElementById('pl_taxRateInput').value.replace(/,/g, ''),
            timestamp: Date.now()
        };

        const histories = getHistoryData();
        histories.unshift(dataToSave); 
        setHistoryData(histories);

        alert(`'${name}' ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);

        saveNameInput.value = ''; 
        loadHistoryLocal(); 
    }

    /**
     * ì‹œìŠ¤í…œ confirm íŒì—…ì„ í†µí•´ ì‚­ì œë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
     */
    window.deleteCalculationLocal = function(docId, name) {
        if (confirm(`ì„ íƒí•˜ì‹  ê³„ì‚° ê¸°ë¡ '${name}'ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`)) {
            let histories = getHistoryData();
            
            histories = histories.filter(item => item.id !== docId);
            setHistoryData(histories);
            
            alert(`'${name}' ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            loadHistoryLocal(); 
        }
    }

    function loadHistoryLocal() {
        const historyList = document.getElementById('history-list');
        const noHistoryMessage = document.getElementById('no-history-message');
        const histories = getHistoryData();
        
        historyList.innerHTML = '';
        
        if (histories.length === 0) {
            noHistoryMessage.classList.remove('hidden');
            historyList.appendChild(noHistoryMessage);
            return;
        } 
        
        noHistoryMessage.classList.add('hidden');

        histories.forEach(item => {
            const dateStr = new Date(item.timestamp).toLocaleDateString('ko-KR', { 
                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
            }).replace(/\. /g, '.').replace(/\.$/, ''); 

            const itemDiv = document.createElement('div');
            itemDiv.className = 'history-item';
            itemDiv.innerHTML = `
                <span class="history-item-name" title="${item.name}">${item.name} <span class="text-xs font-normal text-gray-400">(${dateStr})</span></span>
                <div class="history-actions">
                    <button class="load-btn" onclick='loadCalculationLocal("${item.id}")'>ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="delete-btn" onclick='deleteCalculationLocal("${item.id}", "${item.name}")'>
                        <svg class="w-4 h-4 inline-block -mt-0.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `;
            historyList.appendChild(itemDiv);
        });
    }

    window.loadCalculationLocal = function(docId) {
        const histories = getHistoryData();
        const data = histories.find(item => item.id === docId);

        if (!data) {
            console.error("History data not found for ID:", docId);
            alert("ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const loadData = {
            buyPrice: data.buyPrice || '',
            quantity: data.quantity || '',
            sellPrice: data.sellPrice || '',
            feeRate: data.feeRate || DEFAULT_FEE_RATE,
            taxRate: data.taxRate || DEFAULT_TAX_RATE,
        };

        const inputs = [
            { id: 'pl_buyPrice', value: loadData.buyPrice, cookie: 'stockBuyPrice' },
            { id: 'pl_quantity', value: loadData.quantity, cookie: 'stockQuantity' },
            { id: 'pl_sellPrice', value: loadData.sellPrice, cookie: 'stockSellPrice' },
            { id: 'pl_feeRateInput', value: loadData.feeRate, cookie: 'stockFeeRate' },
            { id: 'pl_taxRateInput', value: loadData.taxRate, cookie: 'stockTaxRate' }
        ];

        inputs.forEach(item => {
            const input = document.getElementById(item.id);
            if (input.id.includes('Rate')) {
                input.value = item.value;
            } else {
                const rawValue = item.value;
                input.value = rawValue;
                window.formatCurrencyInput(input);
            }
            setCookie(item.cookie, item.value); 
        });

        calculateProfitLoss();
        alert(`'${data.name}' ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    }


    // --------------------------------------------------------------------------------
    // --- (Original) Utility Functions ---
    // --------------------------------------------------------------------------------

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0
