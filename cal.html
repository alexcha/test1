<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ê±°ë˜ ì†ìµë¥  ê³„ì‚°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        
        .calculator {
            max-width: 500px;
            margin: 0 auto;
            background: #ffffff;
            padding: 16px 12px; 
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
            display: block;
            margin-bottom: 0.25rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 32px;
            height: 32px;
            line-height: 1;
            font-size: 1.1rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.9em; 
            table-layout: fixed; 
        }
        .result-table th, .result-table td {
            padding: 10px 8px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            word-break: break-word; 
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            width: 60%;
        }
        .result-table td {
            width: 40%;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: bold;
        }
        
        /* ì†ìµë¥  ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ */
        .pl-deduction-color {
            color: #3498db;
            font-weight: bold;
        }
        .pl-net-proceeds-color {
            color: #6c5ce7;
            font-weight: 800;
            font-size: 1.05em; 
        }
        .pl-profit-text {
            color: #e74c3c; /* í•œêµ­ì‹ ë¹¨ê°• (ìˆ˜ìµ) */
            font-weight: bold;
        }
        .pl-loss-text {
            color: #3498db; /* í•œêµ­ì‹ íŒŒë‘ (ì†ì‹¤) */
            font-weight: bold;
        }
        .pl-neutral-text {
            color: #34495e; 
            font-weight: bold;
        }

        /* ê³µí†µ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #2ecc71;
            border-radius: 4px;
        }

        /* History List Styling */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 6px;
            background-color: #f8f8f8;
            border: 1px solid #eee;
        }
        .history-item-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9em;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        .history-actions button {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 5px;
        }
        .load-btn {
            background-color: #3498db;
            color: white;
        }
        .load-btn:hover {
            background-color: #2980b9;
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 300px;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ì‹¤ì‹œê°„ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

    <div id="tab-profit-loss" class="tab-content">

        <div class="input-group">
            <label for="pl_buyPrice">1. ë§¤ìˆ˜ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_buyPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'stockBuyPrice'); calculateProfitLoss();" inputmode="numeric" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_buyPrice', 'stockBuyPrice', '0', 'currency'); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <div class="input-group">
            <label for="pl_quantity">2. ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_quantity" value="" required oninput="handleCurrencyInputAndSave(this, 'stockQuantity'); calculateProfitLoss();" inputmode="numeric" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_quantity', 'stockQuantity', '0', 'currency'); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <!-- ì†ìµë¶„ê¸° ë§¤ë„ ë‹¨ê°€ (BEP) í‘œì‹œ ì˜ì—­ -->
        <div id="bep_display" class="mb-4 p-3 bg-red-50 border-2 border-red-500 rounded-lg" style="display: none;">
            <p class="text-sm text-red-700 font-semibold mb-1">ìˆœì†ìµ 0ì›ì´ ë˜ëŠ” ë§¤ë„ ë‹¨ê°€ (BEP)</p>
            <p id="bep_value" class="text-2xl text-red-700 font-extrabold text-right"></p>
        </div>
        <!-- BEP í‘œì‹œ ì˜ì—­ ë -->

        <div class="input-group">
            <label for="pl_sellPrice">3. ë§¤ë„ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_sellPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'stockSellPrice'); calculateProfitLoss();" inputmode="numeric" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_sellPrice', 'stockSellPrice', '0', 'currency'); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
        
        <div class="input-group">
            <label for="pl_feeRateInput">4. ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'stockFeeRate'); calculateProfitLoss();" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_feeRateInput', 'stockFeeRate', '0.015', 'rate'); calculateProfitLoss();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <div class="input-group">
            <label for="pl_taxRateInput">5. ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="pl_taxRateInput" value="0.15" required oninput="handleRateInputAndSave(this, 'stockTaxRate'); calculateProfitLoss();" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('pl_taxRateInput', 'stockTaxRate', '0.15', 'rate'); calculateProfitLoss();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
        
        <div id="pl_result" class="result mt-6 p-4 border-2 border-green-500 bg-green-50 rounded-lg" style="display: none;">
            <h3 class="text-xl font-semibold text-gray-700 text-center mb-3">ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
            <table id="pl_resultTable" class="result-table"></table>
        </div>
    </div>
    
    <!-- íˆìŠ¤í† ë¦¬ ì €ì¥ ë° ëª©ë¡ ì˜ì—­ -->
    <div class="mt-8 pt-4 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">â­ ê³„ì‚° ì €ì¥ ë° íˆìŠ¤í† ë¦¬</h2>
        
        <!-- ê³„ì‚° ì €ì¥í•˜ê¸° -->
        <div class="p-4 mb-6 bg-yellow-50 border border-yellow-300 rounded-lg">
            <label for="saveNameInput" class="font-bold text-yellow-800 mb-2 block">ì €ì¥ ì´ë¦„ ì…ë ¥:</label>
            <div class="flex space-x-2">
                <input type="text" id="saveNameInput" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì 1ì°¨ ë§¤ìˆ˜" class="w-full text-left p-2 border-yellow-400">
                <button onclick="saveCalculation()" class="bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-700 transition duration-150 flex-shrink-0">
                    ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- íˆìŠ¤í† ë¦¬ ëª©ë¡ -->
        <h3 class="text-xl font-semibold text-gray-700 mb-3 flex justify-between items-center">
            ì €ì¥ëœ ê³„ì‚° ëª©ë¡ <span id="loading-history" class="text-sm text-blue-500 hidden">...ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</span>
        </h3>
        <div id="history-list" class="space-y-2 min-h-[50px] p-2 bg-gray-50 rounded-lg border">
            <p id="no-history-message" class="text-gray-500 text-sm text-center">ì €ì¥ëœ ê³„ì‚° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <p class="text-sm text-gray-500 mt-2">ì‚¬ìš©ì ID: <span id="user-id-display"></span></p>
    </div>
    <!-- íˆìŠ¤í† ë¦¬ ì˜ì—­ ë -->
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="delete-modal-backdrop" class="modal-backdrop hidden" onclick="hideDeleteModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h4 class="text-lg font-bold mb-3 text-gray-800">ì‚­ì œ í™•ì¸</h4>
        <p id="delete-modal-message" class="mb-4 text-gray-600">ì´ ê³„ì‚° ê¸°ë¡ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div class="flex justify-end space-x-3">
            <button onclick="hideDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                ì·¨ì†Œ
            </button>
            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition" 
                    onclick="confirmDelete()">
                ì‚­ì œ
            </button>
        </div>
    </div>
</div>
<!-- ëª¨ë‹¬ ë -->


<script type="module">
    // --- Firebase & Global Configuration ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, Timestamp, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('error'); // FireStore Debugging

    // Global Variables provided by environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase instances
    let app;
    let db;
    let auth;
    let currentUserId = null;
    let isAuthReady = false;

    // History deletion state
    let docToDeleteId = null;

    // Constants
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.15;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %
    const COLLECTION_NAME = 'stock_history';

    // --- Firebase Initialization and Auth ---

    async function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Initial Authentication Check
            await new Promise((resolve) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        if (initialAuthToken) {
                            // Use custom token if provided
                            try {
                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                currentUserId = userCredential.user.uid;
                                console.log("Custom token sign-in successful.");
                            } catch (e) {
                                console.error("Custom token sign-in failed, falling back to anonymous.", e);
                                await signInAnonymously(auth);
                                currentUserId = auth.currentUser.uid;
                            }
                        } else {
                            // Fallback to anonymous sign-in
                            await signInAnonymously(auth);
                            currentUserId = auth.currentUser.uid;
                        }
                    } else {
                        currentUserId = user.uid;
                    }

                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = currentUserId;
                    unsubscribe(); // Stop listening after initial auth is resolved
                    resolve();
                });
            });

            // 2. Load History after Auth is Ready
            loadHistory(); 

        } catch (error) {
            console.error("Firebase initialization or authentication failed:", error);
            // Show error message to user if necessary
        }
    }

    /**
     * Firestore ì»¬ë ‰ì…˜ ê²½ë¡œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. (ê°œì¸ ë°ì´í„°)
     */
    function getHistoryCollectionRef() {
        if (!db || !currentUserId) return null;
        // Path: /artifacts/{appId}/users/{userId}/stock_history
        const userPath = `/artifacts/${appId}/users/${currentUserId}`;
        return collection(db, userPath, COLLECTION_NAME);
    }

    // --- History Modal Logic ---

    window.showDeleteModal = function(docId, name) {
        docToDeleteId = docId;
        document.getElementById('delete-modal-message').textContent = `'${name}' ê¸°ë¡ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
        document.getElementById('delete-modal-backdrop').classList.remove('hidden');
    }

    window.hideDeleteModal = function() {
        docToDeleteId = null;
        document.getElementById('delete-modal-backdrop').classList.add('hidden');
    }

    window.confirmDelete = async function() {
        if (docToDeleteId) {
            await deleteCalculation(docToDeleteId);
            hideDeleteModal();
        }
    }

    // --- History Data Operations ---

    /**
     * í˜„ì¬ ê³„ì‚° ìƒíƒœë¥¼ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.saveCalculation = async function() {
        const historyRef = getHistoryCollectionRef();
        if (!historyRef) return console.error("Firestore not ready.");

        const saveNameInput = document.getElementById('saveNameInput');
        let name = saveNameInput.value.trim();

        if (name === '') {
            name = prompt("ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: ì‚¼ì„±ì „ì 1ì°¨)");
            if (!name || name.trim() === '') {
                // Cannot use window.alert, use console error
                console.error("ì €ì¥ ì´ë¦„ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì €ì¥ ì·¨ì†Œ.");
                return;
            }
        }
        
        // ì…ë ¥ ê°’ (ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ì—¬ ì •ë°€ë„ ìœ ì§€)
        const dataToSave = {
            name: name,
            buyPrice: document.getElementById('pl_buyPrice').value.replace(/,/g, ''),
            quantity: document.getElementById('pl_quantity').value.replace(/,/g, ''),
            sellPrice: document.getElementById('pl_sellPrice').value.replace(/,/g, ''),
            feeRate: document.getElementById('pl_feeRateInput').value.replace(/,/g, ''),
            taxRate: document.getElementById('pl_taxRateInput').value.replace(/,/g, ''),
            timestamp: Timestamp.now()
        };

        try {
            await addDoc(historyRef, dataToSave);
            saveNameInput.value = ''; // ì €ì¥ ì„±ê³µ ì‹œ ì…ë ¥ì°½ ì´ˆê¸°í™”
            console.log("Calculation saved successfully with name:", name);
        } catch (e) {
            console.error("Error adding document: ", e);
        }
    }

    /**
     * Firestoreì—ì„œ ê³„ì‚° ê¸°ë¡ì„ ì‚­ì œí•©ë‹ˆë‹¤.
     */
    async function deleteCalculation(docId) {
        const historyRef = getHistoryCollectionRef();
        if (!historyRef) return console.error("Firestore not ready.");
        
        try {
            const docRef = doc(historyRef, docId);
            await deleteDoc(docRef);
            console.log("Calculation deleted successfully:", docId);
        } catch (e) {
            console.error("Error deleting document: ", e);
        }
    }


    /**
     * Firestoreì˜ ê³„ì‚° ê¸°ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
     */
    function loadHistory() {
        const historyRef = getHistoryCollectionRef();
        if (!historyRef) return;

        const loadingIndicator = document.getElementById('loading-history');
        const historyList = document.getElementById('history-list');
        const noHistoryMessage = document.getElementById('no-history-message');

        loadingIndicator.classList.remove('hidden');

        // Firestore onSnapshot (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ)
        onSnapshot(query(historyRef), (snapshot) => {
            historyList.innerHTML = '';
            const histories = [];
            
            snapshot.forEach((doc) => {
                histories.push({ id: doc.id, ...doc.data() });
            });

            histories.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            loadingIndicator.classList.add('hidden');

            if (histories.length === 0) {
                noHistoryMessage.classList.remove('hidden');
                historyList.appendChild(noHistoryMessage);
                return;
            } else {
                noHistoryMessage.classList.add('hidden');
            }

            histories.forEach(item => {
                const dateStr = item.timestamp.toDate().toLocaleDateString('ko-KR', { 
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
                });
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.innerHTML = `
                    <span class="history-item-name" title="${item.name}">${item.name} <span class="text-xs text-gray-400">(${dateStr})</span></span>
                    <div class="history-actions">
                        <button class="load-btn" onclick='loadCalculation("${item.id}", "${item.name}")'>ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button class="delete-btn" onclick='showDeleteModal("${item.id}", "${item.name}")'>ì‚­ì œ</button>
                    </div>
                `;
                historyList.appendChild(itemDiv);
            });
        }, (error) => {
            console.error("Error listening to history:", error);
            loadingIndicator.classList.add('hidden');
            historyList.innerHTML = '<p class="text-red-500 text-sm text-center">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        });
    }

    /**
     * ì„ íƒëœ ê³„ì‚° ê¸°ë¡ì„ ì…ë ¥ í•„ë“œì— ì ìš©í•˜ê³  ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.loadCalculation = async function(docId, name) {
        const historyRef = getHistoryCollectionRef();
        if (!historyRef) return;
        
        try {
            const docSnapshot = await getDocs(query(historyRef));
            const data = docSnapshot.docs.find(d => d.id === docId)?.data();

            if (!data) {
                console.error("Document not found.");
                return;
            }

            // 1. ë°ì´í„° íŒŒì‹±
            const loadData = {
                buyPrice: data.buyPrice || '',
                quantity: data.quantity || '',
                sellPrice: data.sellPrice || '',
                feeRate: data.feeRate || DEFAULT_FEE_RATE,
                taxRate: data.taxRate || DEFAULT_TAX_RATE,
            };

            // 2. ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
            const inputs = [
                { id: 'pl_buyPrice', value: loadData.buyPrice, cookie: 'stockBuyPrice' },
                { id: 'pl_quantity', value: loadData.quantity, cookie: 'stockQuantity' },
                { id: 'pl_sellPrice', value: loadData.sellPrice, cookie: 'stockSellPrice' },
                { id: 'pl_feeRateInput', value: loadData.feeRate, cookie: 'stockFeeRate' },
                { id: 'pl_taxRateInput', value: loadData.taxRate, cookie: 'stockTaxRate' }
            ];

            inputs.forEach(item => {
                const input = document.getElementById(item.id);
                if (input.id.includes('Rate')) {
                    // ë¹„ìœ¨ í•„ë“œëŠ” ê°’ë§Œ ì„¤ì •
                    input.value = item.value;
                } else {
                    // ê¸ˆì•¡ í•„ë“œëŠ” í¬ë§·íŒ… ë° ì¿ í‚¤ ì €ì¥
                    const rawValue = item.value;
                    input.value = rawValue;
                    window.formatCurrencyInput(input);
                }
                setCookie(item.cookie, item.value); 
            });

            // 3. ê³„ì‚° ì‹¤í–‰ ë° í”¼ë“œë°±
            calculateProfitLoss();
            console.log(`Calculation '${name}' loaded successfully.`);

        } catch (e) {
            console.error("Error loading document: ", e);
        }
    }


    // --------------------------------------------------------------------------------
    // --- (Original) Utility Functions ---
    // --------------------------------------------------------------------------------

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function setCookie(name, value) {
        const date = new Date();
        date.setTime(date.getTime() + (30*24*60*60*1000)); 
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
    }

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤.
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const absoluteAmount = Math.abs(amount);
        
        if (precision === 0) {
            // ì†ìµë¶„ê¸°ì , ì›ê¸ˆ, ìˆ˜ëŸ‰, ì†ìµê¸ˆì•¡ ë“± (ì •ìˆ˜)
            return Math.floor(absoluteAmount).toLocaleString('ko-KR', { maximumFractionDigits: 0 });
        }

        // ìˆœìˆ˜ í‰ê·  ë‹¨ê°€, ìˆ˜ìµë¥ , ë³€ë™ë¥  ë“± (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬)
        return absoluteAmount.toLocaleString('ko-KR', { minimumFractionDigits: precision, maximumFractionDigits: precision });
    }

    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. (ë¹ˆ ê°’ ì²˜ë¦¬ í¬í•¨)
     */
    window.formatCurrencyInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 

        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = ''; 
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
        
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë‹¨ê°€/ìˆ˜ëŸ‰)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë©°, ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.handleCurrencyInputAndSave = function(input, cookieName) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 
        
        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = '';
            if (cookieName) setCookie(cookieName, '');
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
            
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
        
        if (cookieName) setCookie(cookieName, rawValue);
    }

    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.handleRateInputAndSave = function(input, cookieName) {
        const rawValue = input.value.replace(/,/g, ''); 
        
        if (!isNaN(parseFloat(rawValue))) {
            setCookie(cookieName, rawValue);
        }
    }
    
    /**
     * ê°œë³„ ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
     */
    window.resetIndividualInput = function(inputId, cookieName, defaultValue, type) {
        const input = document.getElementById(inputId);
        
        if (type === 'currency') {
            input.value = ""; 
            setCookie(cookieName, ''); 
        } else { // rate
            input.value = defaultValue; 
            setCookie(cookieName, defaultValue);
        }
    };
    
    // --- Cost Calculation Helper (Shared Logic) ---
    function calculateTotalCosts(totalBuyCost, totalQuantity, sellPrice, feeRate, taxRate) {
        const F = feeRate / 100; 
        const T = taxRate / 100;   
        
        const buyFee = totalBuyCost * F;
        const grossSellAmount = sellPrice * totalQuantity;
        const sellFee = grossSellAmount * F;
        const salesTax = grossSellAmount * T;
        
        const totalFee = buyFee + sellFee;
        const totalTax = salesTax;
        const totalDeductions = totalFee + totalTax;

        return { buyFee, sellFee, salesTax, totalFee, totalTax, totalDeductions, grossSellAmount };
    }

    function calculateProfitStatus(totalCost, totalQuantity, marketPrice, feeRate, taxRate, prefix = 'pl') {
        if (totalCost === 0 || totalQuantity === 0 || marketPrice === 0) {
            return {
                netProfitLoss: 0, netProfitRate: 0, 
                profitLossText: '0 ì›', profitRateText: '0.00 %', 
                resultClass: `${prefix}-neutral-text`,
                costs: {}
            };
        }
        
        const costs = calculateTotalCosts(totalCost, totalQuantity, marketPrice, feeRate, taxRate);
        const netProfitLoss = costs.grossSellAmount - totalCost - costs.totalDeductions;
        const netProfitRate = (totalCost > 0) ? (netProfitLoss / totalCost) * 100 : (netProfitLoss > 0 ? Infinity : 0);

        let resultClass = `${prefix}-neutral-text`;
        let signPrefix = ''; 
        
        if (netProfitLoss > 0) {
            resultClass = `${prefix}-profit-text`;
            signPrefix = '+';
        } else if (netProfitLoss < 0) {
            resultClass = `${prefix}-loss-text`;
            signPrefix = '';
        }

        const profitLossText = signPrefix + formatCurrency(netProfitLoss, 0) + ' ì›'; 
        const profitRateText = signPrefix + (isFinite(netProfitRate) ? formatCurrency(netProfitRate, 2) : 'N/A') + ' %';
        
        return { netProfitLoss, netProfitRate, profitLossText, profitRateText, resultClass, costs };
    }


    // --- CALCULATION 1: Profit/Loss Calculator Logic ---

    window.calculateProfitLoss = function() {
        // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° (PL Calculator IDs)
        const buyPrice = parseFloat(document.getElementById('pl_buyPrice').value.replace(/,/g, '')) || 0;
        const quantity = parseFloat(document.getElementById('pl_quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('pl_sellPrice').value.replace(/,/g, '')) || 0;
        
        const feeRateInput = document.getElementById('pl_feeRateInput').value.replace(/,/g, '');
        const taxRateInput = document.getElementById('pl_taxRateInput').value.replace(/,/g, '');
        
        const feeRate = parseFloat(feeRateInput) || 0;
        const taxRate = parseFloat(taxRateInput) || 0;
        
        const totalBuyCost = buyPrice * quantity;
        const totalQuantity = quantity;

        if (totalBuyCost === 0 && totalQuantity === 0 && sellPrice === 0) {
            document.getElementById('pl_result').style.display = 'none';
            document.getElementById('bep_display').style.display = 'none'; // BEP ìˆ¨ê¸°ê¸°
            return;
        }

        // 1. Break-Even Price Calculation (ì†ìµë¶„ê¸° ë§¤ë„ ë‹¨ê°€)
        let breakEvenPrice = 0;
        if (totalQuantity > 0) {
            const F = feeRate / 100;
            const T = taxRate / 100;
            
            const totalInvestmentCost = totalBuyCost * (1 + F); 
            const denominator = 1 - F - T; 
            
            if (denominator > 0) {
                const totalBreakEvenSales = totalInvestmentCost / denominator;
                breakEvenPrice = totalBreakEvenSales / totalQuantity; 
            }
        }

        // BEP í‘œì‹œ ì˜ì—­ ì—…ë°ì´íŠ¸
        const bepDisplay = document.getElementById('bep_display');
        const bepValue = document.getElementById('bep_value');
        
        if (totalBuyCost > 0 && totalQuantity > 0 && breakEvenPrice > 0 && isFinite(breakEvenPrice)) {
            bepValue.innerHTML = `${formatCurrency(breakEvenPrice, 2)} ì›`;
            bepDisplay.style.display = 'block';
        } else {
            bepDisplay.style.display = 'none';
        }
        
        
        const { netProfitLoss, netProfitRate, profitRateText, resultClass, costs } = 
            calculateProfitStatus(totalBuyCost, totalQuantity, sellPrice, feeRate, taxRate, 'pl');
        
        // PL Calculator specific logic
        const grossSellAmount = costs.grossSellAmount;
        const totalDeductions = costs.totalDeductions;
        const totalFee = costs.totalFee;
        const totalTax = costs.totalTax;
        
        let rateClass = 'pl-neutral-text';
        if (netProfitLoss > 0) {
            rateClass = 'pl-profit-text';
        } else if (netProfitLoss < 0) {
            rateClass = 'pl-loss-text';
        }

        // ë§¤ë„ í›„ ìˆœíšŒìˆ˜ì•¡ (ë§¤ë„ ê¸ˆì•¡ - ë§¤ë„ ìˆ˜ìˆ˜ë£Œ - ê±°ë˜ì„¸)
        const netProceedsAfterSellDeductions = grossSellAmount - (costs.sellFee + costs.salesTax); 
        
        // ë‹¨ìˆœ ìˆ˜ìµë¥  (ì„¸ê¸ˆ/ìˆ˜ìˆ˜ë£Œ ë¯¸ë°˜ì˜)
        const simpleProfit = grossSellAmount - totalBuyCost;
        let simpleProfitRate = 0;
        if (totalBuyCost > 0) {
            simpleProfitRate = (simpleProfit / totalBuyCost) * 100;
        }
        
        let simpleProfitRateValue = isFinite(simpleProfitRate) ? formatCurrency(Math.abs(simpleProfitRate), 2) : 'N/A';
        let simpleProfitPrefix = '';
        
        if (simpleProfit > 0) {
            simpleProfitPrefix = '+';
        } else if (simpleProfit < 0) {
            simpleProfitPrefix = '-';
        }
        
        const simpleProfitRateText = simpleProfitRateValue + '%';

        // ê²°ê³¼ í…Œì´ë¸” HTML
        const tableHTML = `
            <thead>
                <tr>
                    <th colspan="2" class="text-center bg-blue-100 rounded-t-lg">ê±°ë˜ ìš”ì•½</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>ì´ ë§¤ìˆ˜ ë¹„ìš© (ì›ê¸ˆ)</th>
                    <td class="value-col">${formatCurrency(totalBuyCost, 0)} ì›</td>
                </tr>
                <tr>
                    <th>ì´ ë§¤ë„ ê¸ˆì•¡ (ì„¸ì „)</th>
                    <td class="value-col">${formatCurrency(grossSellAmount, 0)} ì›</td>
                </tr>
                <tr>
                    <th><span class="pl-deduction-color">ì´ ê³µì œì•¡</span></th>
                    <td class="value-col pl-deduction-color">- ${formatCurrency(totalDeductions, 0)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <th style="padding-left: 20px;">ã„´ ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œ</th>
                    <td class="value-col">- ${formatCurrency(totalFee, 0)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <th style="padding-left: 20px;">ã„´ ê±°ë˜ì„¸</th>
                    <td class="value-col">- ${formatCurrency(totalTax, 0)} ì›</td>
                </tr>
                
                <tr class="bg-indigo-50">
                    <th class="font-bold">ë§¤ë„ í›„ ìˆœíšŒìˆ˜ì•¡ (ì„¸í›„)</th>
                    <td class="value-col pl-net-proceeds-color">${formatCurrency(netProceedsAfterSellDeductions, 0)} ì›</td>
                </tr>

                <tr class="bg-gray-50">
                    <th>ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„)</th>
                    <td class="value-col">
                        <span class="${resultClass}">${netProfitLoss > 0 ? '+' : (netProfitLoss < 0 ? '-' : '')} ${formatCurrency(netProfitLoss, 0)} ì›</span>
                    </td>
                </tr>
                <tr class="font-bold text-lg bg-yellow-100">
                    <th><span class="text-blue-600">ìµœì¢… ì†ìµë¥  (ì„¸í›„)</span></th>
                    <td class="value-col">
                        <span class="${resultClass}">${netProfitLoss > 0 ? '+' : (netProfitLoss < 0 ? '-' : '')}${formatCurrency(netProfitRate, 2)} %</span>
                    </td>
                </tr>
                <tr>
                    <th>ì°¸ê³ : ë‹¨ìˆœ ìˆ˜ìµë¥  (ì„¸ì „)</th>
                    <td class="value-col">
                        <span class="${simpleProfit > 0 ? 'pl-profit-text' : simpleProfit < 0 ? 'pl-loss-text' : 'pl-neutral-text'}">${simpleProfitPrefix}${simpleProfitRateText}</span>
                    </td>
                </tr>
            </tbody>
        `;

        document.getElementById('pl_resultTable').innerHTML = tableHTML;
        document.getElementById('pl_result').style.display = 'block';
        
        // ê²°ê³¼ì°½ì˜ í…Œë‘ë¦¬ì™€ ë°°ê²½ìƒ‰ì„ ìˆœì†ìµì— ë”°ë¼ ë³€ê²½ (í•œêµ­ ì£¼ì‹ ìƒ‰ìƒ: ìˆ˜ìµ=ë¹¨ê°•, ì†ì‹¤=íŒŒë‘)
        const resultDiv = document.getElementById('pl_result');
        if (netProfitLoss > 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-red-500 bg-red-50 rounded-lg'; 
        } else if (netProfitLoss < 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-blue-500 bg-blue-50 rounded-lg'; 
        } else {
            resultDiv.className = 'result mt-6 p-4 border-2 border-gray-400 bg-gray-50 rounded-lg';
        }

    }

    /**
     * ì¿ í‚¤ì— ì €ì¥ëœ ëª¨ë“  ê°’ì„ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ìš°ê³  ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    function loadFromCookies() {
        
        // --- PL Calculator Fields ---
        const plCurrencyInputs = [
            { id: 'pl_buyPrice', cookie: 'stockBuyPrice' },
            { id: 'pl_quantity', cookie: 'stockQuantity' },
            { id: 'pl_sellPrice', cookie: 'stockSellPrice' }
        ];
        
        plCurrencyInputs.forEach(item => {
            const input = document.getElementById(item.id);
            const storedValue = getCookie(item.cookie);
            
            if (storedValue !== null && storedValue !== "" && parseFloat(storedValue) !== 0) {
                input.value = storedValue;
                window.formatCurrencyInput(input); 
            }
        });

        // --- Rate Fields (PL) ---
        const rateInputs = [
            { id: 'pl_feeRateInput', cookie: 'stockFeeRate', default: DEFAULT_FEE_RATE },
            { id: 'pl_taxRateInput', cookie: 'stockTaxRate', default: DEFAULT_TAX_RATE }
        ];
        
        rateInputs.forEach(item => {
            const storedValue = getCookie(item.cookie);
            const value = (storedValue !== null && storedValue !== "") ? storedValue : item.default;
            document.getElementById(item.id).value = value;
        });
        
        // ì´ˆê¸° ë¡œë“œ í›„ ê³„ì‚° ì‹¤í–‰
        calculateProfitLoss();
    }

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        // 1. ì¿ í‚¤ì—ì„œ ê¸°ì¡´ ê°’ ë¡œë“œ
        loadFromCookies(); 
        // 2. Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ì‹œì‘ (ì¸ì¦ ì™„ë£Œ í›„ íˆìŠ¤í† ë¦¬ ë¡œë“œ)
        initializeFirebase();
    });

</script>
</body>
</html>

