<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ì†ìµë¥  ê³„ì‚°ê¸° (ì„¸ê¸ˆ ìƒì„¸ ë‚´ì—­ í¬í•¨)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind CSS ì„¤ì • */
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        /* ì¶”ê°€ì ì¸ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .calculator {
            max-width: 500px;
            margin: 20px auto;
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
            display: block; /* ëª¨ë°”ì¼ì—ì„œ ë ˆì´ë¸”ì´ í•œ ì¤„ ì°¨ì§€í•˜ë„ë¡ */
            margin-bottom: 0.25rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        input[readonly] {
            background-color: #ecf0f1;
            color: #7f8c8d;
            cursor: default;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #calculateButton, #resetButton {
            padding: 10px 15px;
            font-weight: 600;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
            color: white;
            cursor: pointer;
            border: none;
            display: block; /* Full width for mobile */
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.95em;
        }
        .result-table th, .result-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: bold;
        }
        /* ê³µì œì•¡ ìƒì„¸ í‘œì‹œë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .deduction-detail th, .deduction-detail td {
            padding-top: 4px;
            padding-bottom: 4px;
            font-size: 0.9em;
            font-weight: normal;
        }
        .deduction-detail .value-col {
            color: #e74c3c;
            font-weight: 500;
        }


        /* ì†ìµë¥  í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .profit {
            color: #2ecc71; /* ìƒìŠ¹ (ì´ˆë¡) */
            font-size: 1.2em;
        }
        .loss {
            color: #e74c3c; /* í•˜ë½ (ë¹¨ê°•) */
            font-size: 1.2em;
        }
        .neutral {
            color: #34495e; /* ì¤‘ë¦½ (íšŒìƒ‰) */
            font-size: 1.2em;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    <h2 class="text-2xl font-bold text-center text-blue-800 border-b-4 border-blue-500 pb-3 mb-6">ğŸ“ˆ ì£¼ì‹ ê±°ë˜ ì†ìµë¥  ê³„ì‚°ê¸°</h2>

    <!-- ë§¤ìˆ˜ ì •ë³´ ì„¹ì…˜ (ì¿ í‚¤ ì €ì¥) -->
    <div class="input-group">
        <label for="buyPrice">1. ë§¤ìˆ˜ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
        <input type="text" id="buyPrice" value="10,000" required oninput="handleCurrencyInputAndSave(this, 'stockBuyPrice')" inputmode="numeric" class="w-full">
    </div>

    <div class="input-group">
        <label for="quantity">2. ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜)</label>
        <input type="text" id="quantity" value="100" required oninput="handleCurrencyInputAndSave(this, 'stockQuantity')" inputmode="numeric" class="w-full">
    </div>

    <!-- ë§¤ë„ ì •ë³´ ì„¹ì…˜ -->
    <div class="input-group">
        <label for="sellPrice">3. ë§¤ë„ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
        <input type="text" id="sellPrice" value="12,000" required oninput="parseAndFormatInput(this); updateFeeAndTaxFields();" inputmode="numeric" class="w-full">
    </div>
    
    <!-- 4. ìˆ˜ìˆ˜ë£Œìœ¨ ì…ë ¥ ë° ê³„ì‚° ê¸ˆì•¡ í‘œì‹œ -->
    <div class="input-group">
        <label for="feeRateInput">4. ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%) <span class="text-sm font-normal text-gray-500">(ì´ ë§¤ë„ ê¸ˆì•¡ ëŒ€ë¹„, ì˜ˆ: 0.015)</span></label>
        <input type="text" id="feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'stockFeeRate');" inputmode="decimal" class="w-full">
    </div>
    <div class="input-group">
        <label for="calculatedFeeAmount">4-1. ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡ (ì›)</label>
        <input type="text" id="calculatedFeeAmount" value="0" required readonly class="w-full">
    </div>

    <!-- 5. ê±°ë˜ì„¸ìœ¨ ì…ë ¥ ë° ê³„ì‚° ê¸ˆì•¡ í‘œì‹œ -->
    <div class="input-group">
        <label for="taxRateInput">5. ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%) <span class="text-sm font-normal text-gray-500">(ì´ ë§¤ë„ ê¸ˆì•¡ ëŒ€ë¹„, ì˜ˆ: 0.2)</span></label>
        <input type="text" id="taxRateInput" value="0.2" required oninput="handleRateInputAndSave(this, 'stockTaxRate');" inputmode="decimal" class="w-full">
    </div>
    <div class="input-group">
        <label for="calculatedTaxAmount">5-1. ê³„ì‚°ëœ ê±°ë˜ì„¸ ê¸ˆì•¡ (ì›)</label>
        <input type="text" id="calculatedTaxAmount" value="0" required readonly class="w-full">
    </div>
    
    <button id="calculateButton" class="bg-blue-600 hover:bg-blue-700 w-full mb-2">ì†ìµë¥  ê³„ì‚°í•˜ê¸°</button>
    <!-- ì´ˆê¸°í™” ë²„íŠ¼ -->
    <button id="resetButton" class="bg-red-500 hover:bg-red-600 w-full text-sm py-2">ì…ë ¥ê°’ ì´ˆê¸°í™”</button>

    <div id="result" class="result mt-6 p-4 border-2 border-green-500 bg-green-50 rounded-lg" style="display: none;">
        <h3 class="text-xl font-semibold text-gray-700 text-center mb-3">ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
        
        <table id="resultTable" class="result-table">
            <!-- Content filled by JavaScript -->
        </table>
    </div>

    <!-- ë°©ë¬¸ì ì¹´ìš´í„° -->
    <div class="visitor-counter text-sm text-gray-500 mt-4 text-center">
        ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜: <span id="visitorCount" class="font-semibold text-blue-600">0</span>ëª…
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, query, where, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug'); // Firestore ë””ë²„ê·¸ ë¡œê¹… í™œì„±í™”

    // Firestore ë° App ID ì„¤ì •
    let db;
    let auth;
    let appId;
    const DAILY_VISITORS_COLLECTION = "daily_visits";
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.2;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %


    // --- Cookie Helper Functions ---

    /**
     * ì¿ í‚¤ì—ì„œ ì§€ì •ëœ ì´ë¦„ì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
     * @param {string} name ì¿ í‚¤ ì´ë¦„
     * @returns {string|null} ì¿ í‚¤ ê°’ ë˜ëŠ” null
     */
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    /**
     * ì¿ í‚¤ì— ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤. (ë§Œë£Œì¼ 30ì¼ ì„¤ì •)
     * @param {string} name ì¿ í‚¤ ì´ë¦„
     * @param {string} value ì €ì¥í•  ê°’
     */
    function setCookie(name, value) {
        const date = new Date();
        date.setTime(date.getTime() + (30*24*60*60*1000)); // 30 days expiration
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
    }

    // --- Format & Input Handlers ---

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤. (ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ ì¶”ê°€)
     * @param {number} amount - ê¸ˆì•¡
     * @param {number} [precision=0] - ì†Œìˆ˜ì  ì´í•˜ ìë¦¿ìˆ˜ (ê¸°ë³¸ê°’: 0, ì •ìˆ˜)
     * @returns {string} í¬ë§·ëœ ë¬¸ìì—´
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const fixedAmount = amount.toFixed(precision);
        const parts = fixedAmount.split('.');
        const integerPart = parts[0];
        const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return formattedIntegerPart + decimalPart;
    }

    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ(,)ë¡œ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. (ë§¤ë„ ë‹¨ê°€ìš©)
     */
    window.parseAndFormatInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9]/g, ''); 

        if (rawValue === '') {
            input.value = '';
            return; 
        }

        const newValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;
        
        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë§¤ìˆ˜ ë‹¨ê°€/ìˆ˜ëŸ‰)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë©°, ìˆ˜ìˆ˜ë£Œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     * @param {string} cookieName ì €ì¥í•  ì¿ í‚¤ ì´ë¦„
     */
    window.handleCurrencyInputAndSave = function(input, cookieName) {
        // 1. í¬ë§·íŒ… ë° ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9]/g, ''); 

        if (rawValue === '') {
            input.value = '';
            setCookie(cookieName, '');
            updateFeeAndTaxFields();
            return; 
        }

        const newValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
        
        // 2. ì¿ í‚¤ ì €ì¥ (ì‰¼í‘œ ì—†ëŠ” ì›ì‹œ ê°’ì„ ì €ì¥)
        setCookie(cookieName, rawValue);

        // 3. ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì—…ë°ì´íŠ¸
        updateFeeAndTaxFields();
    }
    
    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ê³ , ìˆ˜ìˆ˜ë£Œ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     * @param {string} cookieName ì €ì¥í•  ì¿ í‚¤ ì´ë¦„
     */
    window.handleRateInputAndSave = function(input, cookieName) {
        // ì‰¼í‘œë§Œ ì œê±°í•˜ê³  ì‹¤ìˆ˜ ê·¸ëŒ€ë¡œ ì €ì¥
        const rawValue = input.value.replace(/,/g, ''); 
        
        // ìœ íš¨í•œ ìˆ«ìì¸ ê²½ìš°ë§Œ ì €ì¥
        if (!isNaN(parseFloat(rawValue))) {
            setCookie(cookieName, rawValue);
        }
        
        // ìˆ˜ìˆ˜ë£Œ í•„ë“œ ì—…ë°ì´íŠ¸
        updateFeeAndTaxFields();
    }


    // --- Calculation Logic ---

    /**
     * ì…ë ¥ëœ ë§¤ìˆ˜ ìˆ˜ëŸ‰, ë§¤ë„ ë‹¨ê°€, ì„¸ìœ¨ì„ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œì™€ ê±°ë˜ì„¸ ê¸ˆì•¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    window.updateFeeAndTaxFields = function() {
        const quantity = parseFloat(document.getElementById('quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('sellPrice').value.replace(/,/g, '')) || 0;

        const feeRateInput = document.getElementById('feeRateInput').value.replace(/,/g, '');
        const taxRateInput = document.getElementById('taxRateInput').value.replace(/,/g, '');
        
        const feeRate = parseFloat(feeRateInput) || 0;
        const taxRate = parseFloat(taxRateInput) || 0;
        
        const grossSellAmount = sellPrice * quantity;
        
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì€ í¼ì„¼íŠ¸(%)ì´ë¯€ë¡œ 100ìœ¼ë¡œ ë‚˜ëˆ”
        const calculatedFee = grossSellAmount * (feeRate / 100);
        const calculatedTax = grossSellAmount * (taxRate / 100);
        
        document.getElementById('calculatedFeeAmount').value = formatCurrency(calculatedFee);
        document.getElementById('calculatedTaxAmount').value = formatCurrency(calculatedTax);
    }

    /**
     * ì£¼ì‹ ê±°ë˜ì˜ ì†ìµë¥ ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
     */
    window.calculateProfitLoss = function() {
        updateFeeAndTaxFields(); // ìµœì‹  ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ê¸ˆì•¡ ê³„ì‚°

        const buyPrice = parseFloat(document.getElementById('buyPrice').value.replace(/,/g, '')) || 0;
        const quantity = parseFloat(document.getElementById('quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('sellPrice').value.replace(/,/g, '')) || 0;
        
        // ê³„ì‚°ëœ ìˆ˜ìˆ˜ë£Œì™€ ê±°ë˜ì„¸ ê¸ˆì•¡ì„ í¬ë§·ë˜ì§€ ì•Šì€ ìˆ«ìë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const totalFee = parseFloat(document.getElementById('calculatedFeeAmount').value.replace(/,/g, '')) || 0;
        const totalTax = parseFloat(document.getElementById('calculatedTaxAmount').value.replace(/,/g, '')) || 0;
        const totalDeductions = totalFee + totalTax; // ì´ ê³µì œì•¡

        const totalBuyCost = buyPrice * quantity;
        const totalQuantity = quantity;

        if (totalQuantity <= 0) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = "<h3 class='text-center text-red-600 font-bold'>ê²½ê³ </h3><p class='text-center text-red-600'>ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.</p>";
            resultDiv.style.display = 'block';
            return;
        }

        const grossSellAmount = sellPrice * totalQuantity; 
        const totalSell = grossSellAmount - totalDeductions; // ìˆœ íšŒìˆ˜ ê¸ˆì•¡ (ì„¸í›„)

        const netProfitLoss = totalSell - totalBuyCost; // ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„)
        
        let profitRate = 0;
        if (totalBuyCost > 0) {
            profitRate = (netProfitLoss / totalBuyCost) * 100;
        }

        // 5. ê²°ê³¼ ì¶œë ¥ (í…Œì´ë¸” í˜•ì‹)
        const profitRateText = profitRate.toFixed(2) + '%';
        let rateClass = 'neutral';
        if (netProfitLoss > 0) {
            rateClass = 'profit';
        } else if (netProfitLoss < 0) {
            rateClass = 'loss';
        }

        const tableHTML = `
            <thead>
                <tr>
                    <th colspan="2" class="text-center bg-blue-100 rounded-t-lg">ê±°ë˜ ìš”ì•½</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>ì´ ë§¤ìˆ˜ ë¹„ìš© (ì›ê¸ˆ)</th>
                    <td class="value-col">${formatCurrency(totalBuyCost)} ì›</td>
                </tr>
                <tr>
                    <th>ì´ ë§¤ë„ ê¸ˆì•¡ (ì„¸ì „)</th>
                    <td class="value-col">${formatCurrency(grossSellAmount)} ì›</td>
                </tr>
                <tr>
                    <th><span class="text-red-600">ì´ ê³µì œì•¡ (ìˆ˜ìˆ˜ë£Œ+ì„¸ê¸ˆ)</span></th>
                    <td class="value-col text-red-600 font-bold">- ${formatCurrency(totalDeductions)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <th style="padding-left: 20px;">ã„´ ì´ ìˆ˜ìˆ˜ë£Œ</th>
                    <td class="value-col">- ${formatCurrency(totalFee)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <th style="padding-left: 20px;">ã„´ ì´ ê±°ë˜ì„¸</th>
                    <td class="value-col">- ${formatCurrency(totalTax)} ì›</td>
                </tr>
                <tr class="bg-gray-50">
                    <th>ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„)</th>
                    <td class="value-col">${formatCurrency(netProfitLoss)} ì›</td>
                </tr>
                <tr class="font-bold text-lg bg-yellow-100">
                    <th><span class="text-blue-600">ìµœì¢… ì†ìµë¥ </span></th>
                    <td class="value-col">
                        <span class="${rateClass}">${profitRateText}</span>
                    </td>
                </tr>
            </tbody>
        `;

        document.getElementById('resultTable').innerHTML = tableHTML;
        document.getElementById('result').style.display = 'block';
    }
    
    /**
     * ì¿ í‚¤ì— ì €ì¥ëœ ëª¨ë“  ê°’ì„ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ì›ë‹ˆë‹¤.
     */
    function loadFromCookies() {
        // í†µí™” ê´€ë ¨ ì¿ í‚¤ ë¡œë“œ
        const buyPriceInput = document.getElementById('buyPrice');
        const quantityInput = document.getElementById('quantity');
        
        const storedPrice = getCookie('stockBuyPrice');
        const storedQuantity = getCookie('stockQuantity');
        
        if (storedPrice !== null && storedPrice !== "") {
            buyPriceInput.value = storedPrice;
            window.parseAndFormatInput(buyPriceInput); 
        }
        
        if (storedQuantity !== null && storedQuantity !== "") {
            quantityInput.value = storedQuantity;
            window.parseAndFormatInput(quantityInput);
        }
        
        // ì„¸ìœ¨ ê´€ë ¨ ì¿ í‚¤ ë¡œë“œ
        const feeRateInput = document.getElementById('feeRateInput');
        const taxRateInput = document.getElementById('taxRateInput');

        const storedFeeRate = getCookie('stockFeeRate');
        const storedTaxRate = getCookie('stockTaxRate');
        
        feeRateInput.value = (storedFeeRate !== null && storedFeeRate !== "") ? storedFeeRate : DEFAULT_FEE_RATE;
        taxRateInput.value = (storedTaxRate !== null && storedTaxRate !== "") ? storedTaxRate : DEFAULT_TAX_RATE;
        
        // ì¿ í‚¤ ë¡œë“œ í›„ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ í•„ë“œ ì—…ë°ì´íŠ¸ (ê¸ˆì•¡ ê³„ì‚°)
        updateFeeAndTaxFields();
    }

    /**
     * ëª¨ë“  ì…ë ¥ í•„ë“œì™€ ì¿ í‚¤ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
     */
    window.resetInputs = function() {
        // 1. ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        document.getElementById('buyPrice').value = formatCurrency(10000);
        document.getElementById('quantity').value = formatCurrency(100);
        document.getElementById('sellPrice').value = formatCurrency(12000);
        document.getElementById('feeRateInput').value = DEFAULT_FEE_RATE; 
        document.getElementById('taxRateInput').value = DEFAULT_TAX_RATE;
        
        // 2. ì¿ í‚¤ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì • (ì˜êµ¬ ì €ì¥ ì´ˆê¸°í™”)
        setCookie('stockBuyPrice', '10000');
        setCookie('stockQuantity', '100');
        setCookie('stockFeeRate', DEFAULT_FEE_RATE);
        setCookie('stockTaxRate', DEFAULT_TAX_RATE);
        
        // ì´ì „ ê²°ê³¼ ì¶œë ¥ í•„ë“œë„ ì´ˆê¸°í™”
        const calculatedFeeInput = document.getElementById('calculatedFeeAmount');
        const calculatedTaxInput = document.getElementById('calculatedTaxAmount');

        calculatedFeeInput.value = formatCurrency(0);
        calculatedTaxInput.value = formatCurrency(0);


        // 3. ê³„ì‚°ëœ í•„ë“œ ë° ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
        document.getElementById('result').style.display = 'none';

        // ì´ˆê¸°í™” í›„ ìˆ˜ìˆ˜ë£Œ í•„ë“œ ë‹¤ì‹œ ê³„ì‚° (í•„ìˆ˜)
        updateFeeAndTaxFields();
    };


    /**
     * Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê³  ì˜¤ëŠ˜ ì ‘ì†ì ì¹´ìš´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     */
    async function initializeFirebaseAndCounter() {
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing. Counter will not work.");
            return;
        }
        
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayDateKey = today.toISOString().split('T')[0];
        
        try {
            const userCredential = initialAuthToken 
                ? await signInWithCustomToken(auth, initialAuthToken) 
                : await signInAnonymously(auth);
            
            const userId = userCredential.user.uid;
            
            // ë°©ë¬¸ ê¸°ë¡ ì €ì¥ (userIdë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©í•˜ì—¬ ì˜¤ëŠ˜ì˜ ë°©ë¬¸ ê¸°ë¡ì„ í•œ ë²ˆë§Œ ì €ì¥)
            const visitRef = doc(db, `artifacts/${appId}/public/data/${DAILY_VISITORS_COLLECTION}`, userId);
            
            await setDoc(visitRef, {
                visitTime: serverTimestamp(),
                dateKey: todayDateKey, 
                userId: userId 
            }, { merge: true });

            // ì˜¤ëŠ˜ ì ‘ì†ì ìˆ˜ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œì˜ ê¸°ë¡ë§Œ í•„í„°ë§)
            const visitorsCollectionRef = collection(db, `artifacts/${appId}/public/data/${DAILY_VISITORS_COLLECTION}`);
            
            const q = query(
                visitorsCollectionRef, 
                where("dateKey", "==", todayDateKey)
            );

            onSnapshot(q, (snapshot) => {
                const uniqueDailyVisitors = snapshot.size;
                document.getElementById('visitorCount').textContent = formatCurrency(uniqueDailyVisitors);
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                document.getElementById('visitorCount').textContent = 'Error';
            });

        } catch (error) {
            console.error("Firebase Authentication Error:", error);
        }
    }

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        loadFromCookies(); // 1. ì¿ í‚¤ì—ì„œ ëª¨ë“  ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
        initializeFirebaseAndCounter(); // 2. Firebase ë° ì¹´ìš´í„° ì´ˆê¸°í™”

        document.getElementById('calculateButton').addEventListener('click', calculateProfitLoss);
        document.getElementById('resetButton').addEventListener('click', resetInputs);
    });

</script>
</body>
</html>

