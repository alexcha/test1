<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ê±°ë˜ ì†ìµë¥  ê³„ì‚°ê¸° ë° ê¸°ë¡ ì €ì¥ (ë¡œì»¬)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        
        .calculator {
            max-width: 900px;
            margin: 0 auto 20px auto; 
            padding: 16px 12px; 
        }
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
            display: block;
            margin-bottom: 0.25rem;
        }
        input[type="text"].w-full {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 32px;
            height: 32px;
            line-height: 1;
            font-size: 1.1rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.9em; 
            table-layout: fixed; 
        }
        .result-table th, .result-table td {
            padding: 10px 8px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            word-break: break-word; 
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            width: 60%;
        }
        .result-table td {
            width: 40%;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: bold;
        }
        
        /* ì†ìµë¥  ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ */
        .pl-deduction-color {
            color: #3498db;
            font-weight: bold;
        }
        .pl-net-proceeds-color {
            color: #6c5ce7;
            font-weight: 800;
            font-size: 1.05em; 
        }
        .pl-profit-text {
            color: #e74c3c; /* í•œêµ­ ì£¼ì‹ ì–‘ë´‰ìƒ‰ (ë¹¨ê°•) */
            font-weight: bold;
        }
        .pl-loss-text {
            color: #3498db; /* í•œêµ­ ì£¼ì‹ ìŒë´‰ìƒ‰ (íŒŒë‘) */
            font-weight: bold;
        }
        .pl-neutral-text {
            color: #34495e; 
            font-weight: bold;
        }

        /* ê³µí†µ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #2ecc71;
            border-radius: 4px;
        }

        /* ---------------------------------- */
        /* ì €ì¥ëœ ê¸°ë¡ ëª©ë¡ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ê¸°ë°˜ ìˆ˜ì • ë° ì˜¤ë¥˜ ìˆ˜ì •) */
        /* ---------------------------------- */
        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center; 
            padding: 12px 0; 
            margin: 0 16px; 
            border-bottom: 1px solid #f0f0f0;
        }
        .trade-item:last-child {
            border-bottom: none;
        }
        .trade-info-area {
            flex-grow: 1; 
            min-width: 0; 
            padding-right: 1rem;
        }
        .trade-actions {
            display: flex;
            flex-direction: column; 
            gap: 6px; 
            flex-shrink: 0;
            width: 55px; /* ë²„íŠ¼ ì˜ì—­ í™•ë³´ */
        }
        
        .load-trade-btn {
            background-color: #3498db; 
            color: white;
            font-size: 0.8rem;
            padding: 4px 0; 
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        .load-trade-btn:hover {
            background-color: #2980b9;
        }

        .trade-item-delete-btn {
            background-color: #ecf0f1; 
            color: #2c3e50; 
            font-size: 0.8rem;
            font-weight: 500;
            padding: 4px 0;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        .trade-item-delete-btn:hover {
            background-color: #bdc3c7;
        }
        /* ë¡œì»¬ ì €ì¥ì†Œ ì•Œë¦¼ */
        .local-storage-note {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.9em;
            margin-top: 20px; 
            font-weight: 500;
        }
        /* íˆìŠ¤í† ë¦¬ ìƒë‹¨ ì €ì¥ UI (ìˆ˜ì •ë¨) */
        .history-save-ui {
            padding: 16px;
            border-bottom: 1px solid #ddd;
        }
        .history-save-ui .input-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 0; 
        }
        .history-save-ui input {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1em;
            text-align: left;
            flex-grow: 1;
            min-width: 100px;
        }
        .history-save-ui button {
            background-color: #6c5ce7; 
            color: white;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
            flex-shrink: 0; /* ë²„íŠ¼ ê³ ì • */
            width: 60px; /* ë²„íŠ¼ ë„ˆë¹„ ëª…í™•íˆ ì§€ì • */
        }
        .history-save-ui button:hover {
            background-color: #5d50c9;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
            <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ì‹¤ì‹œê°„ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

            <div id="tab-profit-loss" class="tab-content">
                <div class="input-group">
                    <label for="pl_buyPrice">1. ë§¤ìˆ˜ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="pl_buyPrice" value="" required oninput="handleCurrencyInput(this); calculateProfitLoss();" inputmode="numeric" class="w-full">
                        <button type="button" onclick="resetIndividualInput('pl_buyPrice', ''); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                    </div>
                </div>

                <div class="input-group">
                    <label for="pl_quantity">2. ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="pl_quantity" value="" required oninput="handleCurrencyInput(this); calculateProfitLoss();" inputmode="numeric" class="w-full">
                        <button type="button" onclick="resetIndividualInput('pl_quantity', ''); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                    </div>
                </div>

                <div id="bep_display" class="mb-4 p-3 bg-red-50 border-2 border-red-500 rounded-lg" style="display: none;">
                    <p class="text-sm text-red-700 font-semibold mb-1">ìˆœì†ìµ 0ì›ì´ ë˜ëŠ” ë§¤ë„ ë‹¨ê°€ (BEP)</p>
                    <p id="bep_value" class="text-2xl text-red-700 font-extrabold text-right"></p>
                </div>
                <div class="input-group">
                    <label for="pl_sellPrice">3. ë§¤ë„ ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="pl_sellPrice" value="" required oninput="handleCurrencyInput(this); calculateProfitLoss();" inputmode="numeric" class="w-full">
                        <button type="button" onclick="resetIndividualInput('pl_sellPrice', ''); calculateProfitLoss();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="pl_feeRateInput">4. ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="pl_feeRateInput" value="0.015" required oninput="handleRateInput(this); calculateProfitLoss();" inputmode="decimal" class="w-full">
                        <button type="button" onclick="resetIndividualInput('pl_feeRateInput', '0.015'); calculateProfitLoss();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
                    </div>
                </div>

                <div class="input-group">
                    <label for="pl_taxRateInput">5. ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%)</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="pl_taxRateInput" value="0.15" required oninput="handleRateInput(this); calculateProfitLoss();" inputmode="decimal" class="w-full">
                        <button type="button" onclick="resetIndividualInput('pl_taxRateInput', '0.15'); calculateProfitLoss();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
                    </div>
                </div>
                
                <div id="pl_result" class="result mt-6 p-4 border-2 border-gray-400 bg-gray-50 rounded-lg" style="display: none;">
                    <h3 class="text-xl font-semibold text-gray-700 text-center mb-3">ğŸ“Š ê³„ì‚° ê²°ê³¼</h3>
                    <table id="pl_resultTable" class="result-table"></table>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200">
                     <p id="storageLimitNote" class="text-sm text-red-500 mt-2 text-center" style="display: none;">âš ï¸ ê¸°ë¡ì€ ìµœëŒ€ 6ê°œê¹Œì§€ë§Œ ì €ì¥ë©ë‹ˆë‹¤. (ê°€ì¥ ì˜¤ë˜ëœ ê¸°ë¡ë¶€í„° ìë™ ì‚­ì œ)</p>
                </div>

            </div>
        </div>

        <div class="lg:col-span-1 bg-white p-0 rounded-xl shadow-lg overflow-hidden">
            <div class="flex items-center p-4">
                <span class="text-xl font-extrabold text-gray-800 flex items-center">
                    <span class="mr-2 text-2xl">ğŸ“</span> íˆìŠ¤í† ë¦¬
                </span>
            </div>
            
            <div class="history-save-ui">
                <div class="input-container">
                    <input type="text" id="saveTradeName" placeholder="ê¸°ë¡í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" class="flex-grow">
                    <button onclick="saveCurrentTrade()">ì €ì¥</button>
                </div>
                </div>

            <div id="savedTradesList" class="min-h-64 pt-2">
                <div class="p-4 text-center text-gray-500">ë¡œì»¬ì— ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>
    
    <div class="local-storage-note text-center">âš ï¸ ì´ ê¸°ë¡ì€ ì‚¬ìš©í•˜ì‹œëŠ” ë¸Œë¼ìš°ì €ì˜ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ë©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ ë³€ê²½í•˜ê±°ë‚˜ ê¸°ë¡ì„ ì‚­ì œí•˜ë©´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
    </div>
</div>

<div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-transform duration-300 scale-95">
        <h3 class="text-xl font-bold text-red-600 mb-4">ì‚­ì œ í™•ì¸</h3>
        <p class="text-gray-700 mb-6">ì •ë§ë¡œ '<span id="tradeNameToDelete" class="font-bold"></span>' ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <div class="flex justify-end space-x-3">
            <button onclick="hideConfirmationModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">ì·¨ì†Œ</button>
            <button onclick="confirmDeletion()" id="confirmDeleteButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">ì‚­ì œ</button>
        </div>
    </div>
</div>

<script>
    // --- Global State & Configuration ---
    const DEFAULT_FEE_RATE = 0.015; 
    const DEFAULT_TAX_RATE = 0.15;   
    const STORAGE_KEY = 'stockTradeRecords'; 
    const MAX_TRADES = 6; 
    let tradeToDeleteId = null;

    // --- Local Storage Handlers (Trade Records) ---

    function getSavedTrades() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Error reading from localStorage:", e);
            return [];
        }
    }

    function saveTradesToLocal(trades) {
        // ìµœì‹ ìˆœ (ë‚´ë¦¼ì°¨ìˆœ) ì •ë ¬: b - a
        trades.sort((a, b) => b.timestamp - a.timestamp); 
        
        if (trades.length > MAX_TRADES) {
            // ì˜¤ë˜ëœ ê¸°ë¡ì„ ì œê±°í•˜ê¸° ìœ„í•´ ê¼¬ë¦¬(ë§ˆì§€ë§‰)ë¶€í„° ìë¦„
            trades.splice(MAX_TRADES); 
            
            const limitNote = document.getElementById('storageLimitNote');
            if (limitNote) limitNote.style.display = 'block';
        } else {
             const limitNote = document.getElementById('storageLimitNote');
             if (limitNote) limitNote.style.display = 'none';
        }

        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
            renderSavedTrades(trades); 
        } catch (e) {
            console.error("Error writing to localStorage:", e);
            alertUserMessage("ë¡œì»¬ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "red");
        }
    }

    function loadSavedTrades() {
        const trades = getSavedTrades();
        // ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ) ì •ë ¬: ê°€ì¥ ìµœê·¼ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê°€ì§„ ê¸°ë¡ì´ ìœ„ë¡œ ì˜¬ë¼ì˜µë‹ˆë‹¤.
        trades.sort((a, b) => b.timestamp - a.timestamp); 
        renderSavedTrades(trades);
        
        const limitNote = document.getElementById('storageLimitNote');
        if (limitNote) {
            if (trades.length >= MAX_TRADES) {
                limitNote.style.display = 'block';
            } else {
                limitNote.style.display = 'none';
            }
        }
    }

    // --- Create: Save Current Trade ---

    window.saveCurrentTrade = function() {
        const tradeNameInput = document.getElementById('saveTradeName');
        const tradeName = tradeNameInput.value.trim();

        if (tradeName.length < 2) {
            alertUserMessage("ì €ì¥ ì‹¤íŒ¨: ê¸°ë¡í•  ì´ë¦„ì„ ë‘ ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.", "red");
            return;
        }
        
        // UIì—ì„œ í¬ë§·íŒ…ì´ ì œê±°ëœ ì›ì‹œ ê°’(ìˆ«ì ë¬¸ìì—´)ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const currentBuyPriceRaw = document.getElementById('pl_buyPrice').value.replace(/,/g, '');
        const currentQuantityRaw = document.getElementById('pl_quantity').value.replace(/,/g, '');
        const currentSellPriceRaw = document.getElementById('pl_sellPrice').value.replace(/,/g, '');

        const currentBuyPrice = parseFloat(currentBuyPriceRaw) || 0;
        const currentQuantity = parseFloat(currentQuantityRaw) || 0;
        const currentSellPrice = parseFloat(currentSellPriceRaw) || 0;
        
        const tradeData = {
            id: Date.now().toString(), 
            name: tradeName,
            buyPrice: currentBuyPrice, // ì›ì‹œ ìˆ«ì ê°’ ì €ì¥
            quantity: currentQuantity, // ì›ì‹œ ìˆ«ì ê°’ ì €ì¥
            sellPrice: currentSellPrice, // ì›ì‹œ ìˆ«ì ê°’ ì €ì¥
            feeRate: parseFloat(document.getElementById('pl_feeRateInput').value.replace(/,/g, '')) || DEFAULT_FEE_RATE,
            taxRate: parseFloat(document.getElementById('pl_taxRateInput').value.replace(/,/g, '')) || DEFAULT_TAX_RATE,
            timestamp: Date.now() 
        };
        
        if (tradeData.buyPrice === 0 && tradeData.quantity === 0 && tradeData.sellPrice === 0) {
             alertUserMessage("ì €ì¥ ì‹¤íŒ¨: ë§¤ìˆ˜ë‹¨ê°€, ìˆ˜ëŸ‰, ë§¤ë„ë‹¨ê°€ ì¤‘ ìµœì†Œí•œ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.", "red");
            return;
        }

        const trades = getSavedTrades();
        trades.push(tradeData);
        
        // saveTradesToLocalì—ì„œ ì •ë ¬ ë° ë Œë”ë§ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        saveTradesToLocal(trades); 
        
        alertUserMessage(`'${tradeName}' ê¸°ë¡ì´ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, "green");
        tradeNameInput.value = ''; 
    }

    // --- Delete: Delete Trade ---
    
    window.deleteTrade = function(tradeId, tradeName) {
        tradeToDeleteId = tradeId;
        document.getElementById('tradeNameToDelete').textContent = tradeName;
        showConfirmationModal();
    }

    window.confirmDeletion = function() {
        if (!tradeToDeleteId) {
            hideConfirmationModal();
            return;
        }

        const currentTrades = getSavedTrades();
        const updatedTrades = currentTrades.filter(trade => trade.id !== tradeToDeleteId);

        saveTradesToLocal(updatedTrades);
        alertUserMessage("ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "green");
        
        tradeToDeleteId = null;
        hideConfirmationModal();
    }


    // --- UI/UX & Data Formatting ---

    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const absoluteAmount = Math.abs(amount);
        
        return absoluteAmount.toLocaleString('ko-KR', { 
            minimumFractionDigits: precision, 
            maximumFractionDigits: precision 
        });
    }

    window.handleCurrencyInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 

        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = ''; 
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
        
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);

        // ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ì‹¤ì‹œê°„ ê³„ì‚°
        calculateProfitLoss();
    }
    
    window.handleRateInput = function(input) {
        // ë¹„ìœ¨ ì…ë ¥ì€ í¬ë§·íŒ… ì—†ì´ ê°’ë§Œ ìœ ì§€
        calculateProfitLoss();
    }
    
    window.resetIndividualInput = function(inputId, defaultValue) {
        const input = document.getElementById(inputId);
        
        if (defaultValue === '') { 
            input.value = ""; 
        } else { 
            input.value = defaultValue; 
        }
        calculateProfitLoss();
    };
    
    /**
     * â­ï¸ ë¡œë“œ í•¨ìˆ˜ ìˆ˜ì •: ì €ì¥ëœ ì›ì‹œ ê°’ì„ ë„£ê³ , í¬ë§·íŒ…ì„ ìˆ˜ë™ í˜¸ì¶œ í›„ ê³„ì‚° â­ï¸
     */
    window.loadTrade = function(trade) {
        const buyPriceInput = document.getElementById('pl_buyPrice');
        const quantityInput = document.getElementById('pl_quantity');
        const sellPriceInput = document.getElementById('pl_sellPrice');
        const feeRateInput = document.getElementById('pl_feeRateInput');
        const taxRateInput = document.getElementById('pl_taxRateInput');

        // 1. ì €ì¥ëœ ì›ì‹œ ê°’(ìˆ«ì)ì„ ì…ë ¥ í•„ë“œì— ë¬¸ìì—´ë¡œ ì§ì ‘ ë„£ìŒ
        buyPriceInput.value = trade.buyPrice.toString();
        quantityInput.value = trade.quantity.toString();
        sellPriceInput.value = trade.sellPrice.toString();
        feeRateInput.value = trade.feeRate.toString();
        taxRateInput.value = trade.taxRate.toString();

        // 2. ì…ë ¥ í•„ë“œì— UI í¬ë§·íŒ…ì„ ìˆ˜ë™ ì ìš©
        // ì´ í•¨ìˆ˜ ë‚´ë¶€ì— calculateProfitLoss()ê°€ í˜¸ì¶œë˜ë¯€ë¡œ ê²°ê³¼ê°€ ìë™ ì—…ë°ì´íŠ¸ë¨
        window.handleCurrencyInput(buyPriceInput);
        window.handleCurrencyInput(quantityInput);
        window.handleCurrencyInput(sellPriceInput);
        
        // ë¹„ìœ¨ì€ í¬ë§·íŒ…ì€ í•„ìš” ì—†ìœ¼ë‚˜, ê³„ì‚°ì€ ì‹¤í–‰
        window.handleRateInput(feeRateInput); 
        window.handleRateInput(taxRateInput); 

        // calculateProfitLoss()ëŠ” ì´ë¯¸ handleCurrencyInput/handleRateInput ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ì§€ë§Œ, 
        // í™•ì‹¤í•˜ê²Œ í•œë²ˆ ë” í˜¸ì¶œí•´ ì¤ë‹ˆë‹¤.
        calculateProfitLoss(); 
        
        alertUserMessage(`'${trade.name}' ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, "blue");
    }

    /**
     * ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¨ ê¸°ë¡ ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤. (ìˆ˜ì •ëœ ë””ìì¸ ì ìš©)
     */
    function renderSavedTrades(trades) {
        const listDiv = document.getElementById('savedTradesList');
        listDiv.innerHTML = ''; 

        if (trades.length === 0) {
            listDiv.innerHTML = '<div class="p-4 text-center text-gray-500">ë¡œì»¬ì— ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        const tradesToRender = trades.slice(0, MAX_TRADES);

        tradesToRender.forEach(trade => {
            const date = new Date(trade.timestamp).toLocaleDateString('ko-KR');
            
            // ì´ë¯¸ì§€ì™€ ìœ ì‚¬í•œ ì‹œê°„ í¬ë§· (ì˜¤í›„ XX:XX)
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            const timeString = new Date(trade.timestamp).toLocaleTimeString('ko-KR', timeOptions);
            const formattedTime = timeString.replace('ì˜¤ì „', 'ì˜¤ì „').replace('ì˜¤í›„', 'ì˜¤í›„');


            const tradeElement = document.createElement('div');
            tradeElement.className = 'trade-item group';
            
            // trade ê°ì²´ ì „ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ onclick ì¸ìˆ˜ë¡œ ì „ë‹¬
            const tradeDataString = JSON.stringify(trade).replace(/"/g, '\'');
            
            // í‰ë‹¨ê°€ ì •ë³´
            const avgPrice = trade.buyPrice > 0 ? formatCurrency(trade.buyPrice, 0) : '0';
            const quantity = formatCurrency(trade.quantity, 0);

            tradeElement.innerHTML = `
                <div class="trade-info-area">
                    <p class="font-semibold text-gray-800 text-lg truncate">${trade.name}</p>
                    <div class="flex items-end justify-between text-sm mt-1">
                        <div class="text-gray-500 leading-snug">
                            <p class="text-xs">${date}</p>
                            <p class="text-xs">${formattedTime}</p>
                        </div>
                        <p class="text-gray-700 text-sm font-medium ml-4 whitespace-nowrap">${quantity} ì£¼ / í‰ë‹¨ ${avgPrice} ì›</p>
                    </div>
                </div>
                <div class="trade-actions">
                    <button 
                        onclick='loadTrade(${tradeDataString})' 
                        class="load-trade-btn"
                        title="ê³„ì‚°ê¸°ì— ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°"
                    >
                        ë¡œë“œ
                    </button>
                    <button 
                        onclick="deleteTrade('${trade.id}', '${trade.name}')" 
                        class="trade-item-delete-btn"
                        title="ê¸°ë¡ ì‚­ì œ"
                    >
                        ì‚­ì œ
                    </button>
                </div>
            `;
            listDiv.appendChild(tradeElement);
        });
    }

    // --- Modal Implementation (Custom Confirmation) ---

    function showConfirmationModal() {
        const modal = document.getElementById('confirmationModal');
        modal.classList.remove('opacity-0', 'pointer-events-none');
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }

    function hideConfirmationModal() {
        const modal = document.getElementById('confirmationModal');
        modal.querySelector('.transform').classList.remove('scale-100');
        modal.querySelector('.transform').classList.add('scale-95');
        modal.classList.add('opacity-0', 'pointer-events-none');
    }
    
    // --- Temporary User Message Alert (for feedback) ---
    function alertUserMessage(message, type = "gray") {
        const colorMap = {
            green: "bg-green-500",
            red: "bg-red-500",
            blue: "bg-blue-500",
            gray: "bg-gray-500"
        };
        const alertDiv = document.createElement('div');
        alertDiv.className = `fixed top-4 right-4 p-3 rounded-lg shadow-lg text-white font-semibold ${colorMap[type]} transition-opacity duration-300 z-50`;
        alertDiv.textContent = message;
        document.body.appendChild(alertDiv);
        setTimeout(() => {
            alertDiv.classList.add('opacity-0');
            alertDiv.addEventListener('transitionend', () => alertDiv.remove());
        }, 3000);
    }

    // --- Core Calculation Logic (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
    
    function calculateTotalCosts(totalBuyCost, totalQuantity, sellPrice, feeRate, taxRate) {
        const F = feeRate / 100; 
        const T = taxRate / 100;   
        
        const buyFee = totalBuyCost * F;
        const grossSellAmount = sellPrice * totalQuantity;
        const sellFee = grossSellAmount * F;
        const salesTax = grossSellAmount * T;
        
        const totalFee = buyFee + sellFee;
        const totalTax = salesTax;
        const totalDeductions = totalFee + totalTax;

        return { buyFee, sellFee, salesTax, totalFee, totalTax, totalDeductions, grossSellAmount };
    }

    function calculateProfitStatus(totalCost, totalQuantity, marketPrice, feeRate, taxRate, prefix = 'pl') {
        if (totalCost === 0 || totalQuantity === 0 || marketPrice === 0) {
            return {
                netProfitLoss: 0, netProfitRate: 0, 
                resultClass: `${prefix}-neutral-text`,
                costs: calculateTotalCosts(totalCost, totalQuantity, marketPrice, feeRate, taxRate)
            };
        }
        
        const costs = calculateTotalCosts(totalCost, totalQuantity, marketPrice, feeRate, taxRate);
        const netProfitLoss = costs.grossSellAmount - totalCost - costs.totalDeductions;
        const netProfitRate = (totalCost > 0) ? (netProfitLoss / totalCost) * 100 : (netProfitLoss > 0 ? Infinity : 0);

        let resultClass = `${prefix}-neutral-text`;
        
        if (netProfitLoss > 0) {
            resultClass = `${prefix}-profit-text`;
        } else if (netProfitLoss < 0) {
            resultClass = `${prefix}-loss-text`;
        }

        return { netProfitLoss, netProfitRate, resultClass, costs };
    }


    window.calculateProfitLoss = function() {
        const buyPrice = parseFloat(document.getElementById('pl_buyPrice').value.replace(/,/g, '')) || 0;
        const quantity = parseFloat(document.getElementById('pl_quantity').value.replace(/,/g, '')) || 0;
        const sellPrice = parseFloat(document.getElementById('pl_sellPrice').value.replace(/,/g, '')) || 0;
        
        const feeRate = parseFloat(document.getElementById('pl_feeRateInput').value.replace(/,/g, '')) || DEFAULT_FEE_RATE;
        const taxRate = parseFloat(document.getElementById('pl_taxRateInput').value.replace(/,/g, '')) || DEFAULT_TAX_RATE;
        
        const totalBuyCost = buyPrice * quantity;
        const totalQuantity = quantity;

        if (totalBuyCost === 0 && totalQuantity === 0 && sellPrice === 0) {
            document.getElementById('pl_result').style.display = 'none';
            document.getElementById('bep_display').style.display = 'none'; 
            return;
        }

        let breakEvenPrice = 0;
        if (totalQuantity > 0) {
            const F = feeRate / 100;
            const T = taxRate / 100;
            
            const totalInvestmentCost = totalBuyCost * (1 + F); 
            const denominator = 1 - F - T; 
            
            if (denominator > 0) {
                const totalBreakEvenSales = totalInvestmentCost / denominator;
                breakEvenPrice = totalBreakEvenSales / totalQuantity; 
            }
        }

        const bepDisplay = document.getElementById('bep_display');
        const bepValue = document.getElementById('bep_value');
        
        if (totalBuyCost > 0 && totalQuantity > 0 && breakEvenPrice > 0 && isFinite(breakEvenPrice)) {
            bepValue.innerHTML = `${formatCurrency(breakEvenPrice, 2)} ì›`;
            bepDisplay.style.display = 'block';
        } else {
            bepDisplay.style.display = 'none';
        }
        
        
        const { netProfitLoss, netProfitRate, resultClass, costs } = 
            calculateProfitStatus(totalBuyCost, totalQuantity, sellPrice, feeRate, taxRate, 'pl');
        
        const grossSellAmount = costs.grossSellAmount;
        const totalDeductions = costs.totalDeductions;
        const totalFee = costs.totalFee;
        const totalTax = costs.totalTax;
        
        const netProceedsAfterSellDeductions = grossSellAmount - (costs.sellFee + costs.salesTax); 
        
        const simpleProfit = grossSellAmount - totalBuyCost;
        let simpleProfitRate = 0;
        if (totalBuyCost > 0) {
            simpleProfitRate = (simpleProfit / totalBuyCost) * 100;
        }
        
        let simpleProfitPrefix = '';
        if (simpleProfit > 0) {
            simpleProfitPrefix = '+';
        } else if (simpleProfit < 0) {
            simpleProfitPrefix = '-';
        }
        
        const simpleProfitRateText = isFinite(simpleProfitRate) ? formatCurrency(Math.abs(simpleProfitRate), 2) + '%' : 'N/A';

        // ê²°ê³¼ í…Œì´ë¸” HTML
        const tableHTML = `
            <thead>
                <tr>
                    <th colspan="2" class="text-center bg-blue-100 rounded-t-lg">ê±°ë˜ ìš”ì•½</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>ì´ ë§¤ìˆ˜ ë¹„ìš© (ì›ê¸ˆ)</th>
                    <td class="value-col">${formatCurrency(totalBuyCost, 0)} ì›</td>
                </tr>
                <tr>
                    <th>ì´ ë§¤ë„ ê¸ˆì•¡ (ì„¸ì „)</th>
                    <td class="value-col">${formatCurrency(grossSellAmount, 0)} ì›</td>
                </tr>
                <tr>
                    <th><span class="pl-deduction-color">ì´ ê³µì œì•¡</span></th>
                    <td class="value-col pl-deduction-color">- ${formatCurrency(totalDeductions, 0)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <th style="padding-left: 20px;">ã„´ ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œ</th>
                    <td class="value-col">- ${formatCurrency(totalFee, 0)} ì›</td>
                </tr>
                <tr class="deduction-detail">
                    <th style="padding-left: 20px;">ã„´ ê±°ë˜ì„¸</th>
                    <td class="value-col">- ${formatCurrency(totalTax, 0)} ì›</td>
                </tr>
                
                <tr class="bg-indigo-50">
                    <th class="font-bold">ë§¤ë„ í›„ ìˆœíšŒìˆ˜ì•¡ (ì„¸í›„)</th>
                    <td class="value-col pl-net-proceeds-color">${formatCurrency(netProceedsAfterSellDeductions, 0)} ì›</td>
                </tr>

                <tr class="bg-gray-50">
                    <th>ìˆœì´ìµ/ì†ì‹¤ (ì„¸í›„)</th>
                    <td class="value-col">
                        <span class="${resultClass}">${netProfitLoss > 0 ? '+' : (netProfitLoss < 0 ? '-' : '')} ${formatCurrency(netProfitLoss, 0)} ì›</span>
                    </td>
                </tr>
                <tr class="font-bold text-lg bg-yellow-100">
                    <th><span class="text-blue-600">ìµœì¢… ì†ìµë¥  (ì„¸í›„)</span></th>
                    <td class="value-col">
                        <span class="${resultClass}">${netProfitLoss > 0 ? '+' : (netProfitLoss < 0 ? '-' : '')}${formatCurrency(netProfitRate, 2)} %</span>
                    </td>
                </tr>
                <tr>
                    <th>ì°¸ê³ : ë‹¨ìˆœ ìˆ˜ìµë¥  (ì„¸ì „)</th>
                    <td class="value-col">
                        <span class="${simpleProfit > 0 ? 'pl-profit-text' : simpleProfit < 0 ? 'pl-loss-text' : 'pl-neutral-text'}">${simpleProfitPrefix}${simpleProfitRateText}</span>
                    </td>
                </tr>
            </tbody>
        `;

        document.getElementById('pl_resultTable').innerHTML = tableHTML;
        document.getElementById('pl_result').style.display = 'block';
        
        const resultDiv = document.getElementById('pl_result');
        if (netProfitLoss > 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-red-500 bg-red-50 rounded-lg'; 
        } else if (netProfitLoss < 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-blue-500 bg-blue-50 rounded-lg'; 
        } else {
            resultDiv.className = 'result mt-6 p-4 border-2 border-gray-400 bg-gray-50 rounded-lg'; 
        }
    }


    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        loadSavedTrades(); 
        calculateProfitLoss(); 
    });

</script>
</body>
</html>
