<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ë¬¼íƒ€ê¸° ì†ìµ ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        
        body {
            background-color: #f3f4f6;
        }

        .calculator {
            max-width: 500px;
            margin: 0 auto; 
            background: #ffffff;
            padding: 20px; 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.95em;
            display: block;
            margin-bottom: 0.25rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 32px;
            height: 32px;
            line-height: 1;
            font-size: 1.1rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.9em; 
            table-layout: fixed; 
        }
        .result-table th, .result-table td {
            padding: 10px 8px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            word-break: break-word; 
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            width: 60%;
        }
        .result-table td {
            width: 40%;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: bold;
        }
        
        /* ìƒ‰ìƒ ë° í°íŠ¸ ê°•ì¡° */
        .dca-break-even-price-color {
            color: #2ecc71; 
            font-weight: 800;
            font-size: 1.25em;
        }
        .dca-profit-text {
            color: #e74c3c; /* ë¹¨ê°„ìƒ‰ (ìˆ˜ìµ) */
            font-weight: 800;
            font-size: 1.15em;
        }
        .dca-loss-text {
            color: #3498db; /* íŒŒë€ìƒ‰ (ì†ì‹¤) */
            font-weight: 800;
            font-size: 1.15em;
        }
        .dca-neutral-text {
            color: #34495e; 
            font-weight: 800;
            font-size: 1.15em;
        }

        /* ê³µí†µ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 15px;
            padding: 8px;
            border: 1px dashed #2ecc71;
            border-radius: 8px;
            text-align: center;
        }
        
        /* ë™ì  ì¶”ê°€ ë§¤ìˆ˜ í•­ëª© ìŠ¤íƒ€ì¼ */
        .purchase-entry {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-bottom: 12px;
            padding: 8px;
            background: #f0fff4; 
            border-radius: 8px;
            border: 1px solid #d1fae5; 
        }
        .purchase-entry .input-col {
            flex-grow: 1;
            width: 50%;
        }

        .purchase-entry .input-col input {
             padding: 0.4rem 0.75rem; 
        }
        
        .delete-btn {
            width: 32px;
            height: 32px;
            background: #fecaca; 
            color: #b91c1c; 
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .delete-btn:hover {
            background-color: #fca5a5;
        }
        
        /* Modal for Alert/Confirm */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            text-align: center;
        }

    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

<!-- Alert/Confirm Modal Function Overrides -->
<script>
    // NOTE: alert() ë° confirm() ì‚¬ìš© ê¸ˆì§€ ê·œì •ì— ë”°ë¼ ì»¤ìŠ¤í…€ Modal í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    window.alert = function(message) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <p class="text-lg font-semibold mb-4 text-gray-800">${message}</p>
                <button onclick="this.parentNode.parentNode.remove()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">í™•ì¸</button>
            </div>
        `;
        document.body.appendChild(modal);
    };

    window.confirm = function(message) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <p class="text-lg font-semibold mb-4 text-gray-800">${message}</p>
                    <div class="flex justify-center space-x-3">
                        <button id="confirm-yes" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">ì˜ˆ</button>
                        <button id="confirm-no" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition">ì•„ë‹ˆìš”</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('confirm-yes').onclick = () => {
                modal.remove();
                resolve(true);
            };
            document.getElementById('confirm-no').onclick = () => {
                modal.remove();
                resolve(false);
            };
        });
    };
</script>


<div class="calculator w-full">
    <h1 class="text-2xl font-extrabold text-gray-800 text-center mb-6">ì£¼ì‹ ë¬¼íƒ€ê¸° ì†ìµ ì‹œë®¬ë ˆì´í„°</h1>
    
    <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ì‹¤ì‹œê°„ ìë™ ê³„ì‚°ë˜ë©°, ë°ì´í„°ëŠ” ë¡œì»¬ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</div>

    <div id="tab-dca-simulator" class="tab-content">

        <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-indigo-800 mb-4">1. í˜„ì¬ ì‹œì¥ ê°€ê²©</h3>
            <div class="input-group">
                <label for="dca_currentMarketPrice">í˜„ì¬ ì£¼ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_currentMarketPrice" value="" required oninput="handleCurrencyInputAndSave(this, LS_KEYS.marketPrice); calculateAllResults();" inputmode="numeric" class="w-full text-lg font-bold text-indigo-700">
                    <button type="button" onclick="resetIndividualInput('dca_currentMarketPrice', LS_KEYS.marketPrice, '0', 'currency'); calculateAllResults();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
        </div>

        <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-blue-800 mb-4">2. í˜„ì¬ ë³´ìœ  ì •ë³´</h3>
            <div class="input-group">
                <label for="dca_currentPrice">í˜„ì¬ í‰ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_currentPrice" value="" required oninput="handleCurrencyInputAndSave(this, LS_KEYS.currentPrice); calculateAllResults();" inputmode="numeric" class="w-full text-lg">
                    <button type="button" onclick="resetIndividualInput('dca_currentPrice', LS_KEYS.currentPrice, '0', 'currency'); calculateAllResults();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
            <div class="input-group">
                <label for="dca_currentQuantity">í˜„ì¬ ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜, ì£¼)</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_currentQuantity" value="" required oninput="handleCurrencyInputAndSave(this, LS_KEYS.currentQuantity); calculateAllResults();" inputmode="numeric" class="w-full text-lg">
                    <button type="button" onclick="resetIndividualInput('dca_currentQuantity', LS_KEYS.currentQuantity, '0', 'currency'); calculateAllResults();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
            
            <div id="dca_currentTotalCostContainer" class="p-2 mt-2 border-t border-gray-200 text-center hidden">
                <span class="text-gray-600 font-semibold text-sm">ì´ ë§¤ìˆ˜ ì›ê¸ˆ:</span>
                <span id="dca_currentTotalCostDisplay" class="text-lg font-extrabold text-blue-800">0 ì›</span>
            </div>
            
            <div id="dca_preDcaResult" class="pre-dca-result hidden p-2 mt-3 bg-blue-100 rounded-lg">
                <div class="text-gray-700 font-semibold mb-2 text-sm border-b border-blue-200 pb-1">ë¬¼íƒ€ê¸° ì „ í˜„ì¬ ì˜ˆìƒ ì†ìµ</div>
                <div class="flex justify-between items-center text-base">
                    <span class="text-gray-600">ìˆœì´ìµ/ì†ì‹¤:</span>
                    <span id="dca_preDcaProfitLoss" class="value dca-loss-text">- 0 ì›</span>
                </div>
                <div class="flex justify-between items-center text-sm mt-1">
                    <span class="text-gray-600">ìˆœìˆ˜ìµë¥ :</span>
                    <span id="dca_preDcaProfitRate" class="value dca-loss-text">- 0.00 %</span>
                </div>
            </div>
        </div>

        <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-green-800 mb-4">3. ë¬¼íƒ€ê¸° ë§¤ìˆ˜ ì •ë³´ ì…ë ¥</h3>
            
            <div id="dca_purchaseEntriesContainer"></div>

            <div class="p-2 mt-4 mb-4 bg-green-100 rounded-lg text-sm font-semibold text-green-800 flex justify-between">
                <span>ì´ ì¶”ê°€ ë§¤ìˆ˜ ìˆ˜ëŸ‰ / ê¸ˆì•¡:</span>
                <span id="dca_totalNewPurchase" class="text-right">0 ì£¼ / 0 ì›</span>
            </div>
            
            <button type="button" onclick="addPurchaseEntry()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
                + ë§¤ìˆ˜ í•­ëª© ì¶”ê°€
            </button>
        </div>
        
        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-yellow-800 mb-4">4. ê±°ë˜ ë¹„ìš© ì„¤ì • (%)</h3>
            
            <div class="input-group">
                <label for="dca_feeRateInput">ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%) 
                    <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.015% â†’ 0.015 ì…ë ¥)</span>
                </label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, LS_KEYS.feeRate); calculateAllResults();" inputmode="decimal" class="w-full">
                    <button type="button" onclick="resetIndividualInput('dca_feeRateInput', LS_KEYS.feeRate, '0.015', 'rate'); calculateAllResults();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>

            <div class="input-group">
                <label for="dca_taxRateInput">ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%) 
                    <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.15% â†’ 0.15 ì…ë ¥)</span>
                </label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_taxRateInput" value="0.15" required oninput="handleRateInputAndSave(this, LS_KEYS.taxRate); calculateAllResults();" inputmode="decimal" class="w-full">
                    <button type="button" onclick="resetIndividualInput('dca_taxRateInput', LS_KEYS.taxRate, '0.15', 'rate'); calculateAllResults();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
        </div>
        
        <!-- ìƒˆë¡œìš´ í”„ë¦¬ì…‹ ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="p-4 bg-purple-50 border-l-4 border-purple-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-purple-800 mb-4">5. í”„ë¦¬ì…‹ ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° (ìµœëŒ€ 5ê°œ)</h3>
            
            <div class="input-group">
                <label for="presetNameInput">ì €ì¥í•  ì´ë¦„</label>
                <input type="text" id="presetNameInput" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì ë¬¼íƒ€ê¸° ê³„íš" class="w-full text-lg py-2 px-3 border-purple-300" oninput="checkSaveButtonStatus()">
            </div>
            
            <button type="button" onclick="savePreset()" id="savePresetBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md mb-4 disabled:opacity-50" disabled>
                í˜„ì¬ ì„¤ì • ì €ì¥ (ì´ 0/5ê°œ ì €ì¥ë¨)
            </button>
            
            <div id="presetsListContainer" class="space-y-2 mt-4">
                <!-- Presets will be dynamically loaded here -->
            </div>
        </div>
        
        
        <div id="dca_result" class="result mt-6 p-4 border-2 border-indigo-500 bg-indigo-50 rounded-lg" style="display: none;">
            <h3 class="text-xl font-semibold text-gray-700 text-center mb-3">âœ… ë¬¼íƒ€ê¸° í›„ ìµœì¢… ë¶„ì„ ê²°ê³¼</h3>
            
            <table id="dca_resultTable" class="result-table"></table>
        </div>
    </div>
</div>

<script type="module">
    // --- Global State & Configuration ---
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.15;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %
    let purchaseEntryIdCounter = 0; 

    // --- Local Storage Keys ---
    const PRESETS_LIST_KEY = 'DCA_PRESETS_LIST'; // Master list of saved presets
    const MAX_PRESETS = 5;

    const LS_KEYS = {
        currentPrice: 'DCA_CURRENT_PRICE',
        currentQuantity: 'DCA_CURRENT_QTY',
        marketPrice: 'DCA_MARKET_PRICE',
        feeRate: 'DCA_FEE_RATE',
        taxRate: 'DCA_TAX_RATE',
        entries: 'DCA_ENTRIES' // Dynamic purchase entries array
    };

    // --- Local Storage Helper Functions (Replacing Cookies) ---

    function getLocalStorage(key) {
        return localStorage.getItem(key);
    }

    function setLocalStorage(key, value) {
        localStorage.setItem(key, value);
    }

    function removeLocalStorage(key) {
        localStorage.removeItem(key);
    }
    
    // --- Format & Input Handlers ---

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤.
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const absoluteAmount = Math.abs(amount);
        
        if (precision === 0) {
            return Math.floor(absoluteAmount).toLocaleString('ko-KR', { maximumFractionDigits: 0 });
        }

        return absoluteAmount.toLocaleString('ko-KR', { minimumFractionDigits: precision, maximumFractionDigits: precision });
    }

    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
     */
    window.formatCurrencyInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 

        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = ''; 
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
        
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë‹¨ê°€/ìˆ˜ëŸ‰)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ LocalStorageì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.handleCurrencyInputAndSave = function(input, storageKey) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 
        
        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = '';
            if (storageKey) setLocalStorage(storageKey, '');
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
            
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
        
        if (storageKey) setLocalStorage(storageKey, rawValue);
    }

    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ LocalStorageì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.handleRateInputAndSave = function(input, storageKey) {
        const rawValue = input.value.replace(/,/g, ''); 
        
        if (!isNaN(parseFloat(rawValue))) {
            setLocalStorage(storageKey, rawValue);
        }
    }
    
    /**
     * ê°œë³„ ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
     */
    window.resetIndividualInput = function(inputId, storageKey, defaultValue, type) {
        const input = document.getElementById(inputId);
        
        if (type === 'currency') {
            input.value = ""; 
            removeLocalStorage(storageKey); 
        } else { // rate
            input.value = defaultValue; 
            setLocalStorage(storageKey, defaultValue);
        }
    };


    // --- Dynamic Purchase Entry Persistence ---

    function saveDcaEntries() {
        const entriesData = [];
        const entries = document.querySelectorAll('#dca_purchaseEntriesContainer .purchase-entry');
        
        entries.forEach(entry => {
            const id = entry.dataset.id;
            const priceInput = document.getElementById(`dca_price-${id}`);
            const qtyInput = document.getElementById(`dca_qty-${id}`);
            
            // Save raw (unformatted) values
            const price = priceInput.value.replace(/[^0-9.]/g, ''); 
            const quantity = qtyInput.value.replace(/[^0-9]/g, ''); 

            // ìœ íš¨í•œ ë°ì´í„°ê°€ ìˆëŠ” í•­ëª©ë§Œ ì €ì¥
            if (price || quantity) {
                entriesData.push({ price: price, quantity: quantity });
            }
        });

        setLocalStorage(LS_KEYS.entries, JSON.stringify(entriesData));
    }

    function loadDcaEntries() {
        const container = document.getElementById('dca_purchaseEntriesContainer');
        container.innerHTML = ''; // ê¸°ì¡´ í•­ëª© ì´ˆê¸°í™”
        purchaseEntryIdCounter = 0; // ID ì¹´ìš´í„° ì´ˆê¸°í™”

        const storedData = getLocalStorage(LS_KEYS.entries);
        let loadedEntries = [];
        
        if (storedData) {
            try {
                loadedEntries = JSON.parse(storedData);
            } catch (e) {
                console.error("Error parsing DCA entries cookie:", e);
            }
        }

        if (loadedEntries.length === 0) {
            addPurchaseEntry();
        } else {
            loadedEntries.forEach(data => {
                addPurchaseEntry(data.price, data.quantity); 
            });
        }
    }


    // --- Dynamic Purchase Entry Handlers (DCA only) ---

    /**
     * ë™ì  ë§¤ìˆ˜ í•­ëª©ì„ ì¶”ê°€í•©ë‹ˆë‹¤. (ë¡œë“œ ì‹œ ì´ˆê¸°ê°’ ì ìš© ê°€ëŠ¥)
     */
    window.addPurchaseEntry = function(initialPrice = '', initialQuantity = '') {
        const container = document.getElementById('dca_purchaseEntriesContainer');
        const id = purchaseEntryIdCounter++;
        
        const entryDiv = document.createElement('div');
        entryDiv.className = 'purchase-entry';
        entryDiv.dataset.id = id;
        
        entryDiv.innerHTML += `
            <div class="input-col">
                <label for="dca_price-${id}">ë‹¨ê°€ (ì›)</label>
                <input type="text" id="dca_price-${id}" value="${initialPrice}" required oninput="handleCurrencyInputAndSave(this, null); calculateAllResults();" inputmode="numeric" class="w-full text-sm">
            </div>
            <div class="input-col">
                <label for="dca_qty-${id}">ìˆ˜ëŸ‰ (ì£¼)</label>
                <input type="text" id="dca_qty-${id}" value="${initialQuantity}" required oninput="handleCurrencyInputAndSave(this, null); calculateAllResults();" inputmode="numeric" class="w-full text-sm">
            </div>
            <button type="button" onclick="removePurchaseEntry(${id})" class="delete-btn" title="í•­ëª© ì‚­ì œ">Ã—</button>
        `;
        
        container.appendChild(entryDiv);

        const priceInput = document.getElementById(`dca_price-${id}`);
        const qtyInput = document.getElementById(`dca_qty-${id}`);
        
        // ë¡œë“œëœ ì´ˆê¸°ê°’ì´ ìˆìœ¼ë©´ í¬ë§·íŒ… ì ìš©
        if (initialPrice) window.formatCurrencyInput(priceInput);
        if (initialQuantity) window.formatCurrencyInput(qtyInput);

        calculateAllResults();
    };

    window.removePurchaseEntry = function(id) {
        const entry = document.querySelector(`#dca_purchaseEntriesContainer .purchase-entry[data-id="${id}"]`);
        if (entry) {
            entry.remove();
            calculateAllResults();
        }
    };

    function aggregateDCAValues() {
        let totalNewCost = 0;
        let totalNewQuantity = 0;
        
        const entries = document.querySelectorAll('#dca_purchaseEntriesContainer .purchase-entry');
        
        entries.forEach(entry => {
            const id = entry.dataset.id;
            const priceInput = document.getElementById(`dca_price-${id}`);
            const qtyInput = document.getElementById(`dca_qty-${id}`);
            
            const price = parseFloat(priceInput.value.replace(/,/g, '')) || 0;
            const quantity = Math.floor(parseFloat(qtyInput.value.replace(/,/g, '')) || 0);

            if (quantity > 0) {
                totalNewQuantity += quantity;
                totalNewCost += price * quantity;
            }
        });

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('dca_totalNewPurchase').innerText = 
            `${formatCurrency(totalNewQuantity, 0)} ì£¼ / ${formatCurrency(totalNewCost, 0)} ì›`;
        
        return { totalNewCost, totalNewQuantity };
    }
    
    // --- Cost Calculation Helper (Shared Logic) ---
    function calculateTotalCosts(totalBuyCost, totalQuantity, sellPrice, feeRate, taxRate) {
        const F = feeRate / 100; 
        const T = taxRate / 100;   
        
        const buyFee = totalBuyCost * F;
        const grossSellAmount = sellPrice * totalQuantity;
        const sellFee = grossSellAmount * F;
        const salesTax = grossSellAmount * T;
        
        const totalFee = buyFee + sellFee;
        const totalTax = salesTax;
        const totalDeductions = totalFee + totalTax;

        return { buyFee, sellFee, salesTax, totalFee, totalTax, totalDeductions, grossSellAmount };
    }

    function calculateProfitStatus(totalCost, totalQuantity, marketPrice, feeRate, taxRate, prefix = 'dca') {
        if (totalCost === 0 || totalQuantity === 0 || marketPrice === 0) {
            return {
                netProfitLoss: 0, netProfitRate: 0, 
                profitLossText: '0 ì›', profitRateText: '0.00 %', 
                resultClass: `${prefix}-neutral-text`,
                costs: {}
            };
        }
        
        const costs = calculateTotalCosts(totalCost, totalQuantity, marketPrice, feeRate, taxRate);
        const netProfitLoss = costs.grossSellAmount - totalCost - costs.totalDeductions;
        const netProfitRate = (totalCost > 0) ? (netProfitLoss / totalCost) * 100 : (netProfitLoss > 0 ? Infinity : 0);

        let resultClass = `${prefix}-neutral-text`;
        let signPrefix = ''; 
        
        if (netProfitLoss > 0) {
            resultClass = `${prefix}-profit-text`;
            signPrefix = '+';
        } else if (netProfitLoss < 0) {
            resultClass = `${prefix}-loss-text`;
            signPrefix = ''; // ì†ì‹¤ì€ í•œêµ­ ì£¼ì‹ UIì—ì„œ ë³´í†µ ë§ˆì´ë„ˆìŠ¤ ê¸°í˜¸ë¥¼ ìƒëµí•˜ê±°ë‚˜ ê´„í˜¸ ì²˜ë¦¬í•¨. ì—¬ê¸°ì„  '-'ëŠ” í¬ë§· í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ë¹„ì›Œë‘ .
        }

        const profitLossText = (netProfitLoss < 0 ? '-' : signPrefix) + formatCurrency(netProfitLoss, 0) + ' ì›'; 
        const profitRateText = (netProfitRate < 0 ? '-' : signPrefix) + (isFinite(netProfitRate) ? formatCurrency(netProfitRate, 2) : 'N/A') + ' %';
        
        return { netProfitLoss, netProfitRate, profitLossText, profitRateText, resultClass, costs };
    }


    // --- CALCULATION 2: DCA Simulator Logic ---

    window.calculateAllResults = function() {
        // ë¬¼íƒ€ê¸° í•­ëª©ì„ LocalStorageì— ì €ì¥ (ì‹¤ì‹œê°„ ë³€ê²½ ì‚¬í•­ ë°˜ì˜)
        saveDcaEntries();
        
        // 1. ì •ì  ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
        const currentPrice = parseFloat(document.getElementById('dca_currentPrice').value.replace(/,/g, '')) || 0;
        const currentQuantity = parseFloat(document.getElementById('dca_currentQuantity').value.replace(/,/g, '')) || 0;
        const currentMarketPrice = parseFloat(document.getElementById('dca_currentMarketPrice').value.replace(/,/g, '')) || 0;
        
        const feeRate = parseFloat(document.getElementById('dca_feeRateInput').value.replace(/,/g, '')) || 0;
        const taxRate = parseFloat(document.getElementById('dca_taxRateInput').value.replace(/,/g, '')) || 0;

        // 2. ë™ì  ë§¤ìˆ˜ ê°’ ì§‘ê³„
        const dcaValues = aggregateDCAValues();
        const newTotalCost = dcaValues.totalNewCost;
        const newQuantity = dcaValues.totalNewQuantity;

        // 3. ê¸°ë³¸ê°’ ê³„ì‚° (í•©ì‚° í›„)
        const currentTotalCost = currentPrice * currentQuantity;
        
        // í˜„ì¬ ë³´ìœ  ì´ ì›ê¸ˆ í‘œì‹œ ì—…ë°ì´íŠ¸
        const costContainer = document.getElementById('dca_currentTotalCostContainer');
        const costDisplay = document.getElementById('dca_currentTotalCostDisplay');
        
        if (currentTotalCost > 0) {
            costDisplay.innerText = formatCurrency(currentTotalCost, 0) + ' ì›';
            costContainer.classList.remove('hidden');
        } else {
            costContainer.classList.add('hidden');
        }
        
        const totalCostDCA = currentTotalCost + newTotalCost; 
        const totalQuantityDCA = currentQuantity + newQuantity; 
        
        // 4. ë¬¼íƒ€ê¸° ì „ ìƒíƒœ ë¶„ì„ (Pre-DCA)
        const preDcaStatus = calculateProfitStatus(currentTotalCost, currentQuantity, currentMarketPrice, feeRate, taxRate, 'dca');
        const preDcaDiv = document.getElementById('dca_preDcaResult');
        
        if (currentTotalCost > 0 && currentMarketPrice > 0) {
            document.getElementById('dca_preDcaProfitLoss').innerText = preDcaStatus.profitLossText;
            document.getElementById('dca_preDcaProfitLoss').className = 'value ' + preDcaStatus.resultClass;
            document.getElementById('dca_preDcaProfitRate').innerText = preDcaStatus.profitRateText;
            document.getElementById('dca_preDcaProfitRate').className = 'value ' + preDcaStatus.resultClass;
            preDcaDiv.classList.remove('hidden');
        } else {
            preDcaDiv.classList.add('hidden');
        }

        // 5. ê²°ê³¼ ìˆ¨ê¹€ ì²˜ë¦¬
        if (totalQuantityDCA === 0 || totalCostDCA === 0) {
            document.getElementById('dca_result').style.display = 'none';
            return;
        }
        
        // 6. ìˆœìˆ˜ í‰ê·  ë‹¨ê°€ ê³„ì‚° (ë¹„ìš© ë¯¸ë°˜ì˜)
        const newAveragePrice = totalCostDCA / totalQuantityDCA;
        
        // 7. ì†ìµë¶„ê¸°ì  ë§¤ë„ ë‹¨ê°€ (Break-Even Price) ê³„ì‚°
        const F = feeRate / 100; 
        const T = taxRate / 100;   
        
        let breakEvenPrice = 0;
        
        const numerator = totalCostDCA * (1 + F); 
        const denominator = totalQuantityDCA * (1 - F - T); 
        
        if (denominator > 0) {
            breakEvenPrice = numerator / denominator;
        } else {
             breakEvenPrice = Infinity;
        }
        
        // 8. ë¬¼íƒ€ê¸° í›„ í˜„ì¬ ì£¼ê°€ ê¸°ì¤€ ì˜ˆìƒ ì†ìµ ë¶„ì„ (Post-DCA)
        const postDcaStatus = calculateProfitStatus(totalCostDCA, totalQuantityDCA, currentMarketPrice, feeRate, taxRate, 'dca');
        
        // 9. í‰ë‹¨ê°€ ë³€ë™ë¥  ê³„ì‚°
        let priceReductionRate = 0;
        if (currentPrice > 0) {
             priceReductionRate = ((currentPrice - newAveragePrice) / currentPrice) * 100;
        }

        // í‰ë‹¨ê°€ ë³€ë™ë¥  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²°ì •
        let rateClass = 'text-gray-700';
        let ratePrefix = '';
        if (priceReductionRate > 0) {
            rateClass = 'text-red-600 font-bold'; // ê°ì†Œ (í‰ë‹¨ê°€ê°€ ë‚®ì•„ì§ = ë¹¨ê°„ìƒ‰)
            ratePrefix = 'â†“ ';
        } else if (priceReductionRate < 0) {
            rateClass = 'text-blue-600 font-bold'; // ì¦ê°€ (í‰ë‹¨ê°€ê°€ ë†’ì•„ì§ = íŒŒë€ìƒ‰)
            ratePrefix = 'â†‘ ';
            priceReductionRate = Math.abs(priceReductionRate);
        }
        
        // 10. ë¹„ìš© ìƒì„¸ ê³„ì‚° (í˜„ì¬ ì£¼ê°€ ê¸°ì¤€)
        const marketCosts = calculateTotalCosts(totalCostDCA, totalQuantityDCA, currentMarketPrice, feeRate, taxRate);


        // 11. ê²°ê³¼ ì¶œë ¥ (í…Œì´ë¸” í˜•ì‹)
        const tableHTML = `
            <thead>
                <tr>
                    <th colspan="2" class="text-center bg-indigo-100 rounded-t-lg">í•©ì‚° ê²°ê³¼ ìš”ì•½</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>ì´ ìˆ˜ëŸ‰</th>
                    <td class="value-col">${formatCurrency(totalQuantityDCA, 0)} ì£¼</td>
                </tr>
                <tr>
                    <th>ì´ í•©ì‚° ë§¤ìˆ˜ ì›ê¸ˆ</th>
                    <td class="value-col">${formatCurrency(totalCostDCA, 0)} ì›</td>
                </tr>
                
                <tr class="bg-yellow-100">
                    <th class="font-bold">ìˆœìˆ˜ í‰ê·  ë‹¨ê°€ (ë¹„ìš© ì œì™¸)</th>
                    <td class="value-col text-indigo-700 font-extrabold">${formatCurrency(newAveragePrice, 2)} ì›</td>
                </tr>
                <tr>
                    <th><span class="text-gray-700">í‰ë‹¨ê°€ ë³€ë™ë¥ </span></th>
                    <td class="value-col">
                        <span class="${rateClass}">${ratePrefix}${isFinite(priceReductionRate) ? formatCurrency(priceReductionRate, 2) : 'N/A'} %</span>
                    </td>
                </tr>
                
                <tr class="font-bold text-lg bg-green-100 border-t-2 border-green-500">
                    <th><span class="text-green-800">ì†ìµë¶„ê¸°ì  ë§¤ë„ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ ë°˜ì˜)</span></th>
                    <td class="value-col dca-break-even-price-color">${isFinite(breakEvenPrice) ? formatCurrency(Math.floor(breakEvenPrice), 0) : 'ë¶ˆê°€ëŠ¥'} ì›</td>
                </tr>
                
                <tr>
                    <th colspan="2" class="text-center bg-indigo-200 border-t mt-4 py-2 font-bold text-base">
                        <span class="text-indigo-800">ë¬¼íƒ€ê¸° í›„: ì£¼ê°€ ${formatCurrency(currentMarketPrice, 0)}ì› ê¸°ì¤€ ì†ìµ ë¶„ì„</span>
                    </th>
                </tr>
                <tr>
                    <th><span class="text-gray-700">ì˜ˆìƒ ìˆœì´ìµ/ì†ì‹¤</span></th>
                    <td class="value-col">
                        <span class="${postDcaStatus.resultClass}">${postDcaStatus.profitLossText}</span>
                    </td>
                </tr>
                <tr>
                    <th><span class="text-gray-700">ì˜ˆìƒ ìˆœìˆ˜ìµë¥ </span></th>
                    <td class="value-col">
                        <span class="${postDcaStatus.resultClass}">${postDcaStatus.profitRateText}</span>
                    </td>
                </tr>

                <tr>
                    <th colspan="2" class="text-center bg-gray-50 border-t pt-4 font-bold text-sm">
                        <span class="text-gray-600">ì´ ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ í•©ê³„ (ì…ë ¥ê°’ ê¸°ì¤€)</span>
                    </th>
                </tr>
                <tr>
                    <th><span class="cost-color">ì´ ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ í•©ê³„</span></th>
                    <td class="value-col cost-color">${formatCurrency(marketCosts.totalDeductions, 0)} ì›</td>
                </tr>
                
            </tbody>
        `;

        document.getElementById('dca_resultTable').innerHTML = tableHTML;
        document.getElementById('dca_result').style.display = 'block';

        // ê²°ê³¼ì°½ì˜ í…Œë‘ë¦¬ì™€ ë°°ê²½ìƒ‰ì„ ìˆœì†ìµì— ë”°ë¼ ë³€ê²½
        const resultDiv = document.getElementById('dca_result');
        if (postDcaStatus.netProfitLoss > 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-red-500 bg-red-50 rounded-lg'; // ìˆ˜ìµì€ ë¹¨ê°„ìƒ‰
        } else if (postDcaStatus.netProfitLoss < 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-blue-500 bg-blue-50 rounded-lg'; // ì†ì‹¤ì€ íŒŒë€ìƒ‰
        } else {
            resultDiv.className = 'result mt-6 p-4 border-2 border-gray-400 bg-gray-50 rounded-lg';
        }

        // í”„ë¦¬ì…‹ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        checkSaveButtonStatus();
    }
    
    // --- Preset Management Logic ---

    /**
     * í˜„ì¬ ì…ë ¥ëœ ëª¨ë“  ê°’ì„ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ëª¨ìë‹ˆë‹¤.
     */
    function getCurrentState() {
        const currentState = {};
        
        // 1. Get static inputs (raw unformatted value)
        currentState.currentPrice = document.getElementById('dca_currentPrice').value.replace(/,/g, '');
        currentState.currentQuantity = document.getElementById('dca_currentQuantity').value.replace(/,/g, '');
        currentState.marketPrice = document.getElementById('dca_currentMarketPrice').value.replace(/,/g, '');
        currentState.feeRate = document.getElementById('dca_feeRateInput').value.replace(/,/g, '');
        currentState.taxRate = document.getElementById('dca_taxRateInput').value.replace(/,/g, '');
        
        // 2. Get dynamic entries
        const entriesData = [];
        const entries = document.querySelectorAll('#dca_purchaseEntriesContainer .purchase-entry');
        entries.forEach(entry => {
            const id = entry.dataset.id;
            const priceInput = document.getElementById(`dca_price-${id}`);
            const qtyInput = document.getElementById(`dca_qty-${id}`);
            entriesData.push({ 
                price: priceInput.value.replace(/[^0-9.]/g, ''), 
                quantity: qtyInput.value.replace(/[^0-9]/g, '') 
            });
        });
        currentState.entries = entriesData;
        
        return currentState;
    }

    /**
     * ëª¨ë“  ê°’ì„ ì…ë ¥ í•„ë“œì— ì ìš©í•˜ê³  í˜„ì¬ ìƒíƒœë¡œ ì €ì¥í•©ë‹ˆë‹¤.
     */
    function applyState(state) {
        if (!state) return;
        
        // 1. Static inputs
        const staticInputs = [
            { id: 'dca_currentPrice', key: 'currentPrice' },
            { id: 'dca_currentQuantity', key: 'currentQuantity' },
            { id: 'dca_currentMarketPrice', key: 'marketPrice' },
            { id: 'dca_feeRateInput', key: 'feeRate' },
            { id: 'dca_taxRateInput', key: 'taxRate' }
        ];
        
        staticInputs.forEach(item => {
            const input = document.getElementById(item.id);
            const value = state[item.key] || '';
            input.value = value;
            // Apply formatting for currency fields
            if (item.key.includes('Price') || item.key.includes('Quantity')) {
                window.formatCurrencyInput(input);
            }
            // Save to current state in localStorage
            setLocalStorage(LS_KEYS[item.key], value);
        });

        // 2. Dynamic entries
        const container = document.getElementById('dca_purchaseEntriesContainer');
        container.innerHTML = '';
        purchaseEntryIdCounter = 0;
        
        const loadedEntries = state.entries || [];
        if (loadedEntries.length === 0) {
             addPurchaseEntry();
        } else {
            loadedEntries.forEach(data => {
                addPurchaseEntry(data.price, data.quantity); 
            });
        }
        
        // 3. Save dynamic entries to current state
        saveDcaEntries(); 

        // 4. Calculate results
        calculateAllResults();
    }


    /**
     * í”„ë¦¬ì…‹ ëª©ë¡ì„ LocalStorageì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
     */
    function getPresetsList() {
        try {
            const listJson = getLocalStorage(PRESETS_LIST_KEY);
            return listJson ? JSON.parse(listJson) : [];
        } catch (e) {
            console.error("Failed to load presets list:", e);
            return [];
        }
    }

    /**
     * í”„ë¦¬ì…‹ ëª©ë¡ì„ LocalStorageì— ì €ì¥í•©ë‹ˆë‹¤.
     */
    function setPresetsList(list) {
        setLocalStorage(PRESETS_LIST_KEY, JSON.stringify(list));
    }

    /**
     * í˜„ì¬ ìƒíƒœë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.savePreset = async function() {
        const presetNameInput = document.getElementById('presetNameInput');
        const name = presetNameInput.value.trim();
        if (!name) {
            alert("í”„ë¦¬ì…‹ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }
        
        let list = getPresetsList();
        const currentState = getCurrentState();
        const uniqueKey = `DCA_PRESET_${Date.now()}`;
        
        // 1. ìµœëŒ€ ê°œìˆ˜ (5ê°œ) ì´ˆê³¼ ì‹œ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ(ê°€ì¥ ì²˜ìŒì˜ ê²ƒ) ì‚­ì œ
        if (list.length >= MAX_PRESETS) {
            const oldest = list.shift(); // ì²« ë²ˆì§¸ í•­ëª© ì œê±°
            removeLocalStorage(oldest.key); // LocalStorageì—ì„œë„ ì‚­ì œ
            console.log(`Max presets reached. Deleting oldest preset: ${oldest.name}`);
        }
        
        // 2. ìƒˆ í”„ë¦¬ì…‹ ë°ì´í„° ì €ì¥
        setLocalStorage(uniqueKey, JSON.stringify(currentState));
        
        // 3. ëª©ë¡ì— ì¶”ê°€
        list.push({ name: name, key: uniqueKey });
        setPresetsList(list);
        
        // 4. UI ì—…ë°ì´íŠ¸
        renderPresetsList();
        presetNameInput.value = '';
        await alert(`í”„ë¦¬ì…‹ "${name}"ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ${list.length}/${MAX_PRESETS}ê°œ)`);
    }

    /**
     * ì €ì¥ëœ í”„ë¦¬ì…‹ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
     */
    window.loadPreset = async function(key) {
        const result = await confirm("í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šê³  ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (!result) return;
        
        const presetDataJson = getLocalStorage(key);
        if (!presetDataJson) {
            alert("ì„ íƒí•˜ì‹  í”„ë¦¬ì…‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        try {
            const presetData = JSON.parse(presetDataJson);
            applyState(presetData);
            await alert("í”„ë¦¬ì…‹ì´ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤.");
        } catch (e) {
            console.error("Error loading preset:", e);
            await alert("í”„ë¦¬ì…‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    /**
     * í”„ë¦¬ì…‹ì„ ì‚­ì œí•©ë‹ˆë‹¤.
     */
    window.deletePreset = async function(key) {
        const result = await confirm("ì •ë§ë¡œ ì´ í”„ë¦¬ì…‹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (!result) return;

        let list = getPresetsList();
        
        // 1. ëª©ë¡ì—ì„œ ì œê±°
        const initialLength = list.length;
        list = list.filter(item => item.key !== key);
        
        if (list.length < initialLength) {
            // 2. LocalStorageì—ì„œ ë°ì´í„° ì œê±°
            removeLocalStorage(key);
            setPresetsList(list);
            
            // 3. UI ì—…ë°ì´íŠ¸
            renderPresetsList();
            await alert("í”„ë¦¬ì…‹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            await alert("ì‚­ì œí•  í”„ë¦¬ì…‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    /**
     * ì €ì¥ëœ í”„ë¦¬ì…‹ ëª©ë¡ì„ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function renderPresetsList() {
        const container = document.getElementById('presetsListContainer');
        const list = getPresetsList();
        
        container.innerHTML = '';
        
        if (list.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 text-center p-2 bg-gray-50 rounded-lg">ì €ì¥ëœ í”„ë¦¬ì…‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            list.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex flex-col sm:flex-row items-stretch sm:items-center justify-between p-3 bg-white rounded-lg border border-gray-200 shadow-sm';
                itemDiv.innerHTML = `
                    <span class="text-gray-700 font-medium truncate mb-2 sm:mb-0">${item.name}</span>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button 
                            onclick="loadPreset('${item.key}')" 
                            class="flex-1 px-3 py-1 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition"
                            title="ë¶ˆëŸ¬ì˜¤ê¸°"
                        >
                            ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button 
                            onclick="deletePreset('${item.key}')" 
                            class="flex-1 px-3 py-1 text-sm bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition"
                            title="ì‚­ì œ"
                        >
                            ì‚­ì œ (Ã—)
                        </button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        checkSaveButtonStatus();
    }

    /**
     * ì €ì¥ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ë° ìµœëŒ€ ê°œìˆ˜ í‘œì‹œ
     */
    window.checkSaveButtonStatus = function() {
        const list = getPresetsList();
        const saveBtn = document.getElementById('savePresetBtn');
        const presetNameInput = document.getElementById('presetNameInput');
        
        if (list.length >= MAX_PRESETS) {
            saveBtn.innerText = `í˜„ì¬ ì„¤ì • ì €ì¥ (ìµœëŒ€ ${MAX_PRESETS}ê°œ ë„ë‹¬, ì €ì¥ ì‹œ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ)`;
        } else {
             saveBtn.innerText = `í˜„ì¬ ì„¤ì • ì €ì¥ (ì´ ${list.length}/${MAX_PRESETS}ê°œ ì €ì¥ë¨)`;
        }

        // ì´ë¦„ì´ ì…ë ¥ë˜ë©´ ë²„íŠ¼ í™œì„±í™”
        saveBtn.disabled = presetNameInput.value.trim() === '';
    }

    /**
     * LocalStorageì— ì €ì¥ëœ ëª¨ë“  ê°’ì„ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ìš°ê³  ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    function loadFromLocalStorage() {
        // 1. Load current working state
        const dcaCurrencyInputs = [
            { id: 'dca_currentPrice', key: LS_KEYS.currentPrice },
            { id: 'dca_currentQuantity', key: LS_KEYS.currentQuantity },
            { id: 'dca_currentMarketPrice', key: LS_KEYS.marketPrice }
        ];

        dcaCurrencyInputs.forEach(item => {
            const input = document.getElementById(item.id);
            const storedValue = getLocalStorage(item.key);
            
            if (storedValue !== null && storedValue !== "" && parseFloat(storedValue) !== 0) {
                input.value = storedValue;
                window.formatCurrencyInput(input); 
            } 
        });

        // 2. Load Rate Fields
        const rateInputs = [
            { id: 'dca_feeRateInput', key: LS_KEYS.feeRate, default: DEFAULT_FEE_RATE },
            { id: 'dca_taxRateInput', key: LS_KEYS.taxRate, default: DEFAULT_TAX_RATE }
        ];
        
        rateInputs.forEach(item => {
            const storedValue = getLocalStorage(item.key);
            const value = (storedValue !== null && storedValue !== "") ? storedValue : item.default;
            document.getElementById(item.id).value = value;
        });
        
        // 3. Load dynamic DCA entries
        loadDcaEntries(); 
        
        // 4. Render preset list
        renderPresetsList();

        // ì´ˆê¸° ë¡œë“œ í›„ ê³„ì‚° ì‹¤í–‰
        calculateAllResults();
    }

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        loadFromLocalStorage(); 
    });

</script>
</body>
</html>

