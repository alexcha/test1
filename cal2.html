<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ë¬¼íƒ€ê¸° ì†ìµ ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        
        .calculator {
            max-width: 500px;
            margin: 0 auto 20px auto; 
            background: #ffffff;
            padding: 16px 12px; 
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
            display: block;
            margin-bottom: 0.25rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 32px;
            height: 32px;
            line-height: 1;
            font-size: 1.1rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ê³µí†µ) */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.9em; 
            table-layout: fixed; 
        }
        .result-table th, .result-table td {
            padding: 10px 8px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            word-break: break-word; 
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            width: 60%;
        }
        .result-table td {
            width: 40%;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: bold;
        }
        
        /* ìƒ‰ìƒ ë° í°íŠ¸ ê°•ì¡° (ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼) */
        .dca-break-even-price-color {
            color: #2ecc71; 
            font-weight: 800;
            font-size: 1.25em;
        }
        .dca-profit-text {
            color: #e74c3c; 
            font-weight: 800;
            font-size: 1.15em;
        }
        .dca-loss-text {
            color: #3498db; 
            font-weight: 800;
            font-size: 1.15em;
        }
        .dca-neutral-text {
            color: #34495e; 
            font-weight: 800;
            font-size: 1.15em;
        }

        /* ê³µí†µ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 0px; 
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #2ecc71;
            border-radius: 4px;
        }
        
        /* ë™ì  ì¶”ê°€ ë§¤ìˆ˜ í•­ëª© ìŠ¤íƒ€ì¼ (DCA ì „ìš©) */
        .purchase-entry {
            /* flex-colë¡œ ë³€ê²½í•˜ì—¬ ì…ë ¥ê³¼ ê²°ê³¼ë¥¼ ì„¸ë¡œë¡œ ë°°ì¹˜ */
            display: flex; 
            flex-direction: column;
            gap: 8px; 
            align-items: flex-start; 
            margin-bottom: 12px;
            padding: 8px;
            background: #f0fff4; 
            border-radius: 8px;
            border: 1px solid #d1fae5; 
        }
        
        /* ì…ë ¥ í•„ë“œ í–‰ì„ ê°ì‹¸ëŠ” divì— flex ì ìš© */
        .purchase-entry > div:first-child { 
            display: flex;
            width: 100%;
            gap: 8px;
            align-items: flex-end;
        }

        .purchase-entry .input-col {
             /* ë‹¨ê°€/ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œ ë„ˆë¹„ ì¡°ì ˆ */
            flex-grow: 1;
            width: 50%;
        }

        .purchase-entry .input-col input {
             padding: 0.4rem 0.75rem; /* í•­ëª© ë‚´ë¶€ ì…ë ¥ í•„ë“œ íŒ¨ë”© ì¡°ì • */
        }
        
        .delete-btn {
            width: 32px;
            height: 32px;
            background: #fecaca; 
            color: #b91c1c; 
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .delete-btn:hover {
            background-color: #fca5a5;
        }
        
        /* History Styles */
        .history-entry {
            transition: background-color 0.2s;
        }
        .history-entry:hover {
            background-color: #f7f7f7;
        }
        .history-action-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* â­ï¸ ì…ë ¥ í•„ë“œ ë„ˆë¹„ ì¡°ì • (ìˆ˜ì •ëœ ë¶€ë¶„) â­ï¸ */
        .history-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .history-input-group input {
            flex-grow: 1;
            /* ì‘ì€ í™”ë©´ì—ì„œ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            max-width: calc(100% - 70px); 
        }
        
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    
    <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ ê°’ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ìë™ ê³„ì‚°ë˜ë©°, ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥ ë©ë‹ˆë‹¤.</div>

    <div id="tab-dca-simulator" class="tab-content">

        <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-indigo-800 mb-4">1. í˜„ì¬ ì‹œì¥ ê°€ê²©</h3>
            <div class="input-group">
                <label for="dca_currentMarketPrice">í˜„ì¬ ì£¼ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_currentMarketPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaMarketPrice'); calculateAllResults();" inputmode="numeric" class="w-full text-lg font-bold text-indigo-700">
                    <button type="button" onclick="resetIndividualInput('dca_currentMarketPrice', 'dcaMarketPrice', '0', 'currency'); calculateAllResults();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
        </div>

        <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-blue-800 mb-4">2. í˜„ì¬ ë³´ìœ  ì •ë³´</h3>
            <div class="input-group">
                <label for="dca_currentPrice">í˜„ì¬ í‰ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_currentPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaCurrentPrice'); calculateAllResults();" inputmode="numeric" class="w-full text-lg">
                    <button type="button" onclick="resetIndividualInput('dca_currentPrice', 'dcaCurrentPrice', '0', 'currency'); calculateAllResults();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
            <div class="input-group">
                <label for="dca_currentQuantity">í˜„ì¬ ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜, ì£¼)</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_currentQuantity" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaCurrentQuantity'); calculateAllResults();" inputmode="numeric" class="w-full text-lg">
                    <button type="button" onclick="resetIndividualInput('dca_currentQuantity', 'dcaCurrentQuantity', '0', 'currency'); calculateAllResults();" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
            
            <div id="dca_currentTotalCostContainer" class="p-2 mt-2 border-t border-gray-200 text-center hidden">
                <span class="text-gray-600 font-semibold text-sm">ì´ ë§¤ìˆ˜ ì›ê¸ˆ:</span>
                <span id="dca_currentTotalCostDisplay" class="text-lg font-extrabold text-blue-800">0 ì›</span>
            </div>
            
            <div id="dca_preDcaResult" class="pre-dca-result hidden">
                <div class="text-gray-700 font-semibold mb-2">ë¬¼íƒ€ê¸° ì „ í˜„ì¬ ì˜ˆìƒ ì†ìµ</div>
                <div class="flex justify-between items-center text-base">
                    <span class="text-gray-600">ìˆœì´ìµ/ì†ì‹¤:</span>
                    <span id="dca_preDcaProfitLoss" class="value dca-loss-text">- 0 ì›</span>
                </div>
                <div class="flex justify-between items-center text-sm mt-1">
                    <span class="text-gray-600">ìˆœìˆ˜ìµë¥ :</span>
                    <span id="dca_preDcaProfitRate" class="value dca-loss-text">- 0.00 %</span>
                </div>
            </div>
        </div>

        <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-green-800 mb-4">3. ë¬¼íƒ€ê¸° ë§¤ìˆ˜ ì •ë³´ ì…ë ¥ (ê°œë³„ ëˆ„ì  ê²°ê³¼ í™•ì¸ ê°€ëŠ¥)</h3>
            
            <div id="dca_purchaseEntriesContainer"></div>

            <div class="p-2 mt-4 mb-4 bg-green-100 rounded-lg text-sm font-semibold text-green-800 flex justify-between">
                <span>ì´ ì¶”ê°€ ë§¤ìˆ˜ ìˆ˜ëŸ‰ / ê¸ˆì•¡:</span>
                <span id="dca_totalNewPurchase" class="text-right">0 ì£¼ / 0 ì›</span>
            </div>
            
            <button type="button" onclick="addPurchaseEntry()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
                + ë§¤ìˆ˜ í•­ëª© ì¶”ê°€
            </button>
        </div>
        
        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-yellow-800 mb-4">4. ê±°ë˜ ë¹„ìš© ì„¤ì • (%)</h3>
            
            <div class="input-group">
                <label for="dca_feeRateInput">ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%) 
                    <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.015% â†’ 0.015 ì…ë ¥)</span>
                </label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'dcaFeeRate'); calculateAllResults();" inputmode="decimal" class="w-full">
                    <button type="button" onclick="resetIndividualInput('dca_feeRateInput', 'dcaFeeRate', '0.015', 'rate'); calculateAllResults();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>

            <div class="input-group">
                <label for="dca_taxRateInput">ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%) 
                    <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.15% â†’ 0.15 ì…ë ¥)</span>
                </label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dca_taxRateInput" value="0.15" required oninput="handleRateInputAndSave(this, 'dcaTaxRate'); calculateAllResults();" inputmode="decimal" class="w-full">
                    <button type="button" onclick="resetIndividualInput('dca_taxRateInput', 'dcaTaxRate', '0.15', 'rate'); calculateAllResults();" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
                </div>
            </div>
        </div>
        
        <div id="dca_result" class="result mt-6 p-4 border-2 border-indigo-500 bg-indigo-50 rounded-lg" style="display: none;">
            <h3 class="text-xl font-semibold text-gray-700 text-center mb-3">âœ… ë¬¼íƒ€ê¸° í›„ ìµœì¢… ë¶„ì„ ê²°ê³¼</h3>
            
            <table id="dca_resultTable" class="result-table"></table>
        </div>
    </div>
</div>

<div class="calculator w-full mt-6">
    <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ íˆìŠ¤í† ë¦¬</h3>
        
        <div class="history-input-group mb-6">
            <input type="text" id="history-name-input" placeholder="ê¸°ë¡í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1ì°¨ í…ŒìŠ¬ë¼ ê³„íš)" 
                   class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            <button type="button" onclick="saveCurrentStateToHistory()" class="flex-shrink-0 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
                ì €ì¥
            </button>
        </div>

        <h4 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">ì €ì¥ëœ ì‹œë®¬ë ˆì´ì…˜ ëª©ë¡</h4>
        <div id="history-list-container">
            <table class="w-full text-sm text-left text-gray-600">
                <tbody id="history-list-body">
                    </tbody>
            </table>
            <p id="history-empty-message" class="text-center py-4 text-gray-500 italic hidden">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        
        <div id="history-message-box" class="mt-4 text-center p-3 text-sm rounded-lg hidden" role="alert"></div>

    </div>
</div>

<script type="module">
    // --- Global State & Configuration ---
    // ê¸°ë³¸ê°’ ì„¤ì •
    const DEFAULT_FEE_RATE = 0.015;
    const DEFAULT_TAX_RATE = 0.15;
    let purchaseEntryIdCounter = 0; 
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ ì •ì˜ (ë©”ì¸ ìƒíƒœ ë° íˆìŠ¤í† ë¦¬)
    const DCA_STATE_KEY = 'dcaCalculatorState'; 
    const DCA_HISTORY_KEY = 'dcaHistory';
    
    // --- Local Storage Helper Functions ---

    function getLocal(name) {
        try {
            return localStorage.getItem(name);
        } catch (e) {
            console.error("Local storage read error:", e);
            return null;
        }
    }

    function setLocal(name, value) {
        try {
            localStorage.setItem(name, value);
        } catch (e) {
            console.error("Local storage write error:", e);
        }
    }

    // --- Format & Input Handlers ---

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤.
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const absoluteAmount = Math.abs(amount);
        
        if (precision === 0) {
            return Math.floor(absoluteAmount).toLocaleString('ko-KR', { maximumFractionDigits: 0 });
        }

        return absoluteAmount.toLocaleString('ko-KR', { minimumFractionDigits: precision, maximumFractionDigits: precision });
    }

    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. (ë¹ˆ ê°’ ì²˜ë¦¬ í¬í•¨)
     */
    window.formatCurrencyInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 

        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = ''; 
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
        
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë‹¨ê°€/ìˆ˜ëŸ‰)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ ë¡œì»¬ì— ì„ì‹œ ì €ì¥í•˜ë©°, ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.handleCurrencyInputAndSave = function(input, stateName) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 
        
        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = '';
            if (stateName) saveDcaState({ [stateName]: '' });
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
            
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                newCursorStart = cursorStart + 1;
            }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
        
        if (stateName) saveDcaState({ [stateName]: rawValue });
    }

    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ ë¡œì»¬ì— ì„ì‹œ ì €ì¥í•©ë‹ˆë‹¤.
     */
    window.handleRateInputAndSave = function(input, stateName) {
        const rawValue = input.value.replace(/,/g, ''); 
        if (!isNaN(parseFloat(rawValue))) {
            saveDcaState({ [stateName]: rawValue });
        }
    }
    
    /**
     * ê°œë³„ ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
     */
    window.resetIndividualInput = function(inputId, stateName, defaultValue, type) {
        const input = document.getElementById(inputId);
        
        if (type === 'currency') {
            input.value = ""; 
            saveDcaState({ [stateName]: '' });
        } else { // rate
            input.value = defaultValue; 
            saveDcaState({ [stateName]: defaultValue });
        }
    };
    
    // ë©”ì‹œì§€ ë°•ìŠ¤ í‘œì‹œ (íˆìŠ¤í† ë¦¬ ì„¹ì…˜)
    function showHistoryMessage(text, className) {
        const box = document.getElementById('history-message-box');
        box.textContent = text;
        box.className = `mt-4 text-center p-3 text-sm rounded-lg ${className}`;
        box.classList.remove('hidden');
        setTimeout(() => {
            box.classList.add('hidden');
        }, 3000);
    }
    

    // --- Main Calculator State Persistence (Local Storage) ---

    // ì •ì  ì…ë ¥ í•„ë“œ IDì™€ ìƒíƒœ ì´ë¦„ ë§¤í•‘
    const STATIC_INPUT_MAP = {
        'dca_currentPrice': 'dcaCurrentPrice',
        'dca_currentQuantity': 'dcaCurrentQuantity',
        'dca_currentMarketPrice': 'dcaMarketPrice',
        'dca_feeRateInput': 'dcaFeeRate',
        'dca_taxRateInput': 'dcaTaxRate'
    };
    
    /**
     * í˜„ì¬ ê³„ì‚°ê¸° ìƒíƒœë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì„ì‹œ ì €ì¥í•©ë‹ˆë‹¤.
     * @param {Object} [updates={}] - ì—…ë°ì´íŠ¸í•  íŠ¹ì • í•„ë“œì™€ ê°’ (ì„ íƒ ì‚¬í•­)
     */
    function saveDcaState(updates = {}) {
        let state = {};
        
        // 1. ê¸°ì¡´ ìƒíƒœ ë¡œë“œ ë˜ëŠ” ì´ˆê¸°í™”
        const storedState = getLocal(DCA_STATE_KEY);
        if (storedState) {
            try {
                state = JSON.parse(storedState);
            } catch (e) { /* silent fail */ }
        }

        // 2. ì •ì  ì…ë ¥ í•„ë“œ ê°’ ì—…ë°ì´íŠ¸ (ì—…ë°ì´íŠ¸ê°€ ì—†ì„ ê²½ìš° ì „ì²´ í•„ë“œë¥¼ ì½ìŒ)
        if (Object.keys(updates).length === 0) {
            Object.keys(STATIC_INPUT_MAP).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    state[STATIC_INPUT_MAP[id]] = input.value.replace(/,/g, '');
                }
            });
        } else {
            Object.assign(state, updates);
        }

        // 3. ë™ì  ë§¤ìˆ˜ í•­ëª© ì €ì¥
        state.dcaEntries = [];
        const entries = document.querySelectorAll('#dca_purchaseEntriesContainer .purchase-entry');
        entries.forEach(entry => {
            const id = entry.dataset.id;
            const price = document.getElementById(`dca_price-${id}`)?.value.replace(/,/g, '') || '';
            const quantity = document.getElementById(`dca_qty-${id}`)?.value.replace(/,/g, '') || '';
            
            if (price || quantity) {
                state.dcaEntries.push({ price, quantity });
            }
        });

        setLocal(DCA_STATE_KEY, JSON.stringify(state));
    }

    /**
     * ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ì›ë‹ˆë‹¤.
     * @param {Object} [stateToLoad] - ë¡œë“œí•  ìƒíƒœ ê°ì²´ (íˆìŠ¤í† ë¦¬ì—ì„œ ë¡œë“œ ì‹œ ì‚¬ìš©)
     */
    function loadDcaState(stateToLoad) {
        let state = {};

        if (stateToLoad) {
            state = stateToLoad;
        } else {
            const storedState = getLocal(DCA_STATE_KEY);
            if (storedState) {
                try {
                    state = JSON.parse(storedState);
                } catch (e) { 
                    console.error("Failed to parse main state from LocalStorage:", e);
                    return;
                }
            }
            // ì €ì¥ëœ ìƒíƒœê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’(ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ)ì„ ì„¤ì •
            if (!state.dcaFeeRate) state.dcaFeeRate = DEFAULT_FEE_RATE;
            if (!state.dcaTaxRate) state.dcaTaxRate = DEFAULT_TAX_RATE;
        }
        
        // 1. ì •ì  ì…ë ¥ í•„ë“œ ë³µì›
        Object.keys(STATIC_INPUT_MAP).forEach(id => {
            const input = document.getElementById(id);
            const stateName = STATIC_INPUT_MAP[id];
            const value = state[stateName] || '';
            
            if (input) {
                input.value = value;
                if (stateName.includes('Price') || stateName.includes('Quantity')) {
                    // ê¸ˆì•¡/ìˆ˜ëŸ‰ í•„ë“œë§Œ í¬ë§·íŒ… ì¬ì ìš©
                    window.formatCurrencyInput(input);
                }
            }
        });
        
        // 2. ë™ì  ë§¤ìˆ˜ í•­ëª© ë³µì›
        const entries = state.dcaEntries || [];
        const container = document.getElementById('dca_purchaseEntriesContainer');
        container.innerHTML = '';
        purchaseEntryIdCounter = 0; // ì¹´ìš´í„° ì´ˆê¸°í™”
        
        if (entries.length === 0) {
            addPurchaseEntry(); // ìµœì†Œ 1ê°œëŠ” ìœ ì§€
        } else {
            entries.forEach(data => {
                addPurchaseEntry(data.price, data.quantity, false); // í¬ë§·ë˜ì§€ ì•Šì€ ê°’ ì „ë‹¬, ê³„ì‚°ì€ ìµœì¢…ì ìœ¼ë¡œ í•œ ë²ˆë§Œ
            });
        }
        
        // 3. ì„ì‹œ ì €ì¥ ìƒíƒœë„ ì—…ë°ì´íŠ¸ (íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹œ)
        if (stateToLoad) {
             setLocal(DCA_STATE_KEY, JSON.stringify(stateToLoad));
        }

        calculateAllResults();
    }
    
    // --- Dynamic Purchase Entry Handlers (DCA only) ---

    /**
     * ë™ì  ë§¤ìˆ˜ í•­ëª©ì„ ì¶”ê°€í•©ë‹ˆë‹¤. (ë¡œë“œ ì‹œ ì´ˆê¸°ê°’ ì ìš© ê°€ëŠ¥)
     */
    window.addPurchaseEntry = function(initialPrice = '', initialQuantity = '', runCalculation = true) {
        const container = document.getElementById('dca_purchaseEntriesContainer');
        const id = purchaseEntryIdCounter++;
        
        const entryDiv = document.createElement('div');
        // purchase-entry í´ë˜ìŠ¤ë¥¼ ìˆ˜ì •í•˜ì—¬ flex-colë¡œ ë³€ê²½
        entryDiv.className = 'purchase-entry'; 
        entryDiv.dataset.id = id;
        
        // ì…ë ¥ í•„ë“œì™€ ì‚­ì œ ë²„íŠ¼ì„ ë‹´ì„ í–‰ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€)
        const inputRow = document.createElement('div');
        // inputRowì— flexë¥¼ ì£¼ì–´ ë‹¨ê°€/ìˆ˜ëŸ‰/ì‚­ì œ ë²„íŠ¼ì´ ê°€ë¡œë¡œ ë‚˜ì—´ë˜ë„ë¡ í•¨
        inputRow.className = 'flex gap-8 items-end w-full';

        // ì´ˆê¸°ê°’ì€ í¬ë§·ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ì„¤ì •
        inputRow.innerHTML = `
            <div class="input-col">
                <label for="dca_price-${id}">ë‹¨ê°€ (ì›)</label>
                <input type="text" id="dca_price-${id}" value="${initialPrice}" required 
                       oninput="handleCurrencyInputAndSave(this, null); calculateAllResults();" 
                       inputmode="numeric" class="w-full text-sm">
            </div>
            <div class="input-col">
                <label for="dca_qty-${id}">ìˆ˜ëŸ‰ (ì£¼)</label>
                <input type="text" id="dca_qty-${id}" value="${initialQuantity}" required 
                       oninput="handleCurrencyInputAndSave(this, null); calculateAllResults();" 
                       inputmode="numeric" class="w-full text-sm">
            </div>
            <button type="button" onclick="removePurchaseEntry(${id})" class="delete-btn" title="í•­ëª© ì‚­ì œ">Ã—</button>
        `;
        
        entryDiv.appendChild(inputRow);

        // ** ê°œë³„ ëˆ„ì  ê³„ì‚° ê²°ê³¼ í‘œì‹œ ì˜ì—­ ì¶”ê°€ **
        const resultDiv = document.createElement('div');
        resultDiv.id = `dca_result-${id}`;
        resultDiv.className = 'p-3 mt-2 bg-white border border-green-200 rounded-lg w-full hidden';
        entryDiv.appendChild(resultDiv);
        
        container.appendChild(entryDiv);

        const priceInput = document.getElementById(`dca_price-${id}`);
        const qtyInput = document.getElementById(`dca_qty-${id}`);
        
        // ë¡œë“œëœ ì´ˆê¸°ê°’ì´ ìˆìœ¼ë©´ í¬ë§·íŒ… ì ìš©
        if (initialPrice) window.formatCurrencyInput(priceInput);
        if (initialQuantity) window.formatCurrencyInput(qtyInput);

        if (runCalculation) {
            calculateAllResults();
        }
    };

    window.removePurchaseEntry = function(id) {
        const entry = document.querySelector(`#dca_purchaseEntriesContainer .purchase-entry[data-id="${id}"]`);
        if (entry) {
            entry.remove();
            calculateAllResults(); // ê³„ì‚° ë° ì„ì‹œ ì €ì¥ ì‹¤í–‰
        }
    };
    
    // ì´ í•¨ìˆ˜ëŠ” ìµœì¢… í•©ê³„ë§Œ ì—…ë°ì´íŠ¸í•˜ë„ë¡ calculateDcaEntryDetails ë‚´ë¡œ í†µí•©ë¨
    /*
    function aggregateDCAValues() {
        // ... ê¸°ì¡´ ë¡œì§ ...
    }
    */
    
    // --- Cost Calculation Helper (Shared Logic) ---
    function calculateTotalCosts(totalBuyCost, totalQuantity, sellPrice, feeRate, taxRate) {
        const F = feeRate / 100; 
        const T = taxRate / 100;   
        
        const buyFee = totalBuyCost * F;
        const grossSellAmount = sellPrice * totalQuantity;
        const sellFee = grossSellAmount * F;
        const salesTax = grossSellAmount * T;
        
        const totalFee = buyFee + sellFee;
        const totalTax = salesTax;
        const totalDeductions = totalFee + totalTax;

        return { buyFee, sellFee, salesTax, totalFee, totalTax, totalDeductions, grossSellAmount };
    }

    function calculateProfitStatus(totalCost, totalQuantity, marketPrice, feeRate, taxRate, prefix = 'dca') {
        if (totalCost === 0 || totalQuantity === 0 || marketPrice === 0) {
            return {
                netProfitLoss: 0, netProfitRate: 0, 
                profitLossText: '0 ì›', profitRateText: '0.00 %', 
                resultClass: `${prefix}-neutral-text`,
                costs: {}
            };
        }
        
        const costs = calculateTotalCosts(totalCost, totalQuantity, marketPrice, feeRate, taxRate);
        const netProfitLoss = costs.grossSellAmount - totalCost - costs.totalDeductions;
        const netProfitRate = (totalCost > 0) ? (netProfitLoss / totalCost) * 100 : (netProfitLoss > 0 ? Infinity : 0);

        let resultClass = `${prefix}-neutral-text`;
        let signPrefix = ''; 
        
        if (netProfitLoss > 0) {
            resultClass = `${prefix}-profit-text`;
            signPrefix = '+';
        } else if (netProfitLoss < 0) {
            resultClass = `${prefix}-loss-text`;
            signPrefix = '-';
        }

        const profitLossText = signPrefix + formatCurrency(netProfitLoss, 0) + ' ì›'; 
        const profitRateText = signPrefix + (isFinite(netProfitRate) ? formatCurrency(netProfitRate, 2) : 'N/A') + ' %';
        
        return { netProfitLoss, netProfitRate, profitLossText, profitRateText, resultClass, costs };
    }


    // --- CALCULATION: DCA Entry Details (New Function) ---
    /**
     * ë™ì  ë§¤ìˆ˜ í•­ëª©ë³„ ëˆ„ì  ê°’ì„ ê³„ì‚°í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @returns {{ totalNewCost: number, totalNewQuantity: number }} ìµœì¢… í•©ì‚° ê°’
     */
    function calculateDcaEntryDetails() {
        // 1. ì´ˆê¸°ê°’ ì„¤ì • (í˜„ì¬ ë³´ìœ  ì •ë³´)
        const currentPrice = parseFloat(document.getElementById('dca_currentPrice').value.replace(/,/g, '')) || 0;
        const currentQuantity = parseFloat(document.getElementById('dca_currentQuantity').value.replace(/,/g, '')) || 0;
        const feeRate = parseFloat(document.getElementById('dca_feeRateInput').value.replace(/,/g, '')) || DEFAULT_FEE_RATE;
        const taxRate = parseFloat(document.getElementById('dca_taxRateInput').value.replace(/,/g, '')) || DEFAULT_TAX_RATE;

        let cumulativeCost = currentPrice * currentQuantity;
        let cumulativeQuantity = currentQuantity;
        
        let totalNewCost = 0;
        let totalNewQuantity = 0;

        const entries = document.querySelectorAll('#dca_purchaseEntriesContainer .purchase-entry');
        
        entries.forEach((entry, index) => {
            const id = entry.dataset.id;
            const priceInput = document.getElementById(`dca_price-${id}`);
            const qtyInput = document.getElementById(`dca_qty-${id}`);
            
            const price = parseFloat(priceInput.value.replace(/,/g, '')) || 0;
            const quantity = Math.floor(parseFloat(qtyInput.value.replace(/,/g, '')) || 0);
            
            const entryCost = price * quantity;

            // ëˆ„ì  ì—…ë°ì´íŠ¸ (í˜„ì¬ í•­ëª©ê¹Œì§€)
            cumulativeCost += entryCost;
            cumulativeQuantity += quantity;
            
            totalNewCost += entryCost;
            totalNewQuantity += quantity;

            const entryTitle = `${index + 1}ì°¨ ë§¤ìˆ˜`;
            const entryAvgPrice = cumulativeQuantity > 0 ? (cumulativeCost / cumulativeQuantity) : 0;
            
            // ìˆœìˆ˜ í‰ê·  ë‹¨ê°€ ë³€ë™ë¥  ê³„ì‚° (ë¬¼íƒ€ê¸° ì „ í‰ë‹¨ê°€ ê¸°ì¤€)
            let priceReductionRate = 0;
            if (currentPrice > 0) {
                 priceReductionRate = ((currentPrice - entryAvgPrice) / currentPrice) * 100;
            }


            // ì†ìµë¶„ê¸°ì  ë§¤ë„ ë‹¨ê°€ (Break-Even Price) ê³„ì‚° (í˜„ì¬ í•­ëª©ê¹Œì§€)
            let breakEvenPrice = Infinity;
            const F = feeRate / 100; 
            const T = taxRate / 100;   
            
            const numerator = cumulativeCost * (1 + F); 
            const denominator = cumulativeQuantity * (1 - F - T); 
            
            if (denominator > 0) {
                breakEvenPrice = numerator / denominator;
            }

            // UI ì—…ë°ì´íŠ¸
            const resultContainer = document.getElementById(`dca_result-${id}`);
            if (resultContainer) {
                if (cumulativeQuantity > 0) {
                    
                    // ë¬¼íƒ€ê¸° ì „ í‰ë‹¨ ëŒ€ë¹„ ì–¼ë§ˆë‚˜ ë‚®ì•„ì¡ŒëŠ”ì§€ í‘œì‹œ
                    let rateClass = 'text-gray-700';
                    let ratePrefix = '';
                    let rateDisplay = formatCurrency(Math.abs(priceReductionRate), 2) + ' %';
                    
                    if (currentPrice > 0 && priceReductionRate > 0) {
                        rateClass = 'text-red-600 font-bold'; // ê°ì†Œ (ë¬¼íƒ€ê¸° ëª©í‘œ)
                        ratePrefix = 'â†“ ';
                    } else if (currentPrice > 0 && priceReductionRate < 0) {
                        rateClass = 'text-blue-600 font-bold'; // ì¦ê°€ (í‰ë‹¨ì´ ë†’ì•„ì§)
                        ratePrefix = 'â†‘ ';
                    } else if (currentPrice === 0) {
                        rateClass = 'text-gray-500';
                        rateDisplay = 'N/A';
                    }

                    resultContainer.innerHTML = `
                        <div class="text-sm font-semibold text-green-700 mt-0 mb-1">${entryTitle} í›„ ëˆ„ì  ê²°ê³¼</div>
                        <ul class="list-disc list-inside space-y-1 text-xs pl-2">
                            <li>ì´ ìˆ˜ëŸ‰: <span class="font-bold">${formatCurrency(cumulativeQuantity, 0)} ì£¼</span></li>
                            <li>ì´ ì›ê¸ˆ: <span class="font-bold">${formatCurrency(cumulativeCost, 0)} ì›</span></li>
                            <li>**ëˆ„ì  í‰ë‹¨ê°€**: <span class="text-indigo-700 font-extrabold">${formatCurrency(entryAvgPrice, 2)} ì›</span></li>
                            <li>í‰ë‹¨ ê°ì†Œìœ¨: <span class="${rateClass}">${ratePrefix}${rateDisplay}</span> (ë¬¼íƒ€ê¸° ì „ í‰ë‹¨ ëŒ€ë¹„)</li>
                            <li>**ì†ìµë¶„ê¸°ì **: <span class="text-green-800 font-extrabold">${isFinite(breakEvenPrice) ? formatCurrency(Math.floor(breakEvenPrice), 0) : 'ë¶ˆê°€ëŠ¥'} ì›</span></li>
                        </ul>
                    `;
                    resultContainer.classList.remove('hidden');
                } else {
                     resultContainer.classList.add('hidden');
                }
            }
        });

        // ìµœì¢… í•©ê³„ UI ì—…ë°ì´íŠ¸
        document.getElementById('dca_totalNewPurchase').innerText = 
            `${formatCurrency(totalNewQuantity, 0)} ì£¼ / ${formatCurrency(totalNewCost, 0)} ì›`;
            
        return { totalNewCost, totalNewQuantity };
    }


    window.calculateAllResults = function() {
        // 1. ì •ì  ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
        const currentPrice = parseFloat(document.getElementById('dca_currentPrice').value.replace(/,/g, '')) || 0;
        const currentQuantity = parseFloat(document.getElementById('dca_currentQuantity').value.replace(/,/g, '')) || 0;
        const currentMarketPrice = parseFloat(document.getElementById('dca_currentMarketPrice').value.replace(/,/g, '')) || 0;
        
        // ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš© (ì´ˆê¸° ë¡œë“œ ì‹œ)
        const feeRate = parseFloat(document.getElementById('dca_feeRateInput').value.replace(/,/g, '')) || DEFAULT_FEE_RATE;
        const taxRate = parseFloat(document.getElementById('dca_taxRateInput').value.replace(/,/g, '')) || DEFAULT_TAX_RATE;

        // 2. ë™ì  ë§¤ìˆ˜ ê°’ ì§‘ê³„ ë° ê°œë³„ ëˆ„ì  ê³„ì‚°/UI ì—…ë°ì´íŠ¸ **(ìˆ˜ì •ëœ ë¶€ë¶„)**
        const dcaValues = calculateDcaEntryDetails(); 
        const newTotalCost = dcaValues.totalNewCost;
        const newQuantity = dcaValues.totalNewQuantity;
        
        // ** ëª¨ë“  ì…ë ¥ ë³€í™” ì‹œ ì„ì‹œ ìƒíƒœ ì €ì¥ **
        saveDcaState({}); 

        // 3. ê¸°ë³¸ê°’ ê³„ì‚° (í•©ì‚° í›„)
        const currentTotalCost = currentPrice * currentQuantity;
        
        // í˜„ì¬ ë³´ìœ  ì´ ì›ê¸ˆ í‘œì‹œ ì—…ë°ì´íŠ¸
        const costContainer = document.getElementById('dca_currentTotalCostContainer');
        const costDisplay = document.getElementById('dca_currentTotalCostDisplay');
        
        if (currentTotalCost > 0) {
            costDisplay.innerText = formatCurrency(currentTotalCost, 0) + ' ì›';
            costContainer.classList.remove('hidden');
        } else {
            costContainer.classList.add('hidden');
        }
        
        const totalCostDCA = currentTotalCost + newTotalCost; 
        const totalQuantityDCA = currentQuantity + newQuantity; 
        
        // 4. ë¬¼íƒ€ê¸° ì „ ìƒíƒœ ë¶„ì„ (Pre-DCA)
        const preDcaStatus = calculateProfitStatus(currentTotalCost, currentQuantity, currentMarketPrice, feeRate, taxRate, 'dca');
        const preDcaDiv = document.getElementById('dca_preDcaResult');
        
        if (currentTotalCost > 0 && currentMarketPrice > 0) {
            document.getElementById('dca_preDcaProfitLoss').innerText = preDcaStatus.profitLossText;
            document.getElementById('dca_preDcaProfitLoss').className = 'value ' + preDcaStatus.resultClass;
            document.getElementById('dca_preDcaProfitRate').innerText = preDcaStatus.profitRateText;
            document.getElementById('dca_preDcaProfitRate').className = 'value ' + preDcaStatus.resultClass;
            preDcaDiv.classList.remove('hidden');
        } else {
            preDcaDiv.classList.add('hidden');
        }

        // 5. ê²°ê³¼ ìˆ¨ê¹€ ì²˜ë¦¬
        if (totalQuantityDCA === 0 || totalCostDCA === 0) {
            document.getElementById('dca_result').style.display = 'none';
            return;
        }
        
        // 6. ìˆœìˆ˜ í‰ê·  ë‹¨ê°€ ê³„ì‚° (ë¹„ìš© ë¯¸ë°˜ì˜)
        const newAveragePrice = totalCostDCA / totalQuantityDCA;
        
        // 7. ì†ìµë¶„ê¸°ì  ë§¤ë„ ë‹¨ê°€ (Break-Even Price) ê³„ì‚°
        const F = feeRate / 100; 
        const T = taxRate / 100;   
        
        let breakEvenPrice = 0;
        
        const numerator = totalCostDCA * (1 + F); 
        const denominator = totalQuantityDCA * (1 - F - T); 
        
        if (denominator > 0) {
            breakEvenPrice = numerator / denominator;
        } else {
             breakEvenPrice = Infinity;
        }
        
        // 8. ë¬¼íƒ€ê¸° í›„ í˜„ì¬ ì£¼ê°€ ê¸°ì¤€ ì˜ˆìƒ ì†ìµ ë¶„ì„ (Post-DCA)
        const postDcaStatus = calculateProfitStatus(totalCostDCA, totalQuantityDCA, currentMarketPrice, feeRate, taxRate, 'dca');
        
        // 9. í‰ë‹¨ê°€ ë³€ë™ë¥  ê³„ì‚°
        let priceReductionRate = 0;
        if (currentPrice > 0) {
             priceReductionRate = ((currentPrice - newAveragePrice) / currentPrice) * 100;
        }

        // í‰ë‹¨ê°€ ë³€ë™ë¥  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²°ì •
        let rateClass = 'text-gray-700';
        let ratePrefix = '';
        if (priceReductionRate > 0) {
            rateClass = 'text-red-600 font-bold'; // ê°ì†Œ (ë¹¨ê°„ìƒ‰)
            ratePrefix = 'â†“ ';
        } else if (priceReductionRate < 0) {
            rateClass = 'text-blue-600 font-bold'; // ì¦ê°€ (íŒŒë€ìƒ‰)
            ratePrefix = 'â†‘ ';
            priceReductionRate = Math.abs(priceReductionRate);
        }
        
        // 10. ë¹„ìš© ìƒì„¸ ê³„ì‚° (í˜„ì¬ ì£¼ê°€ ê¸°ì¤€)
        const marketCosts = calculateTotalCosts(totalCostDCA, totalQuantityDCA, currentMarketPrice, feeRate, taxRate);


        // 11. ê²°ê³¼ ì¶œë ¥ (í…Œì´ë¸” í˜•ì‹)
        const tableHTML = `
            <thead>
                <tr>
                    <th colspan="2" class="text-center bg-indigo-100 rounded-t-lg">í•©ì‚° ê²°ê³¼ ìš”ì•½</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>ì´ ìˆ˜ëŸ‰</th>
                    <td class="value-col">${formatCurrency(totalQuantityDCA, 0)} ì£¼</td>
                </tr>
                <tr>
                    <th>ì´ í•©ì‚° ë§¤ìˆ˜ ì›ê¸ˆ</th>
                    <td class="value-col">${formatCurrency(totalCostDCA, 0)} ì›</td>
                </tr>
                
                <tr class="bg-yellow-100">
                    <th class="font-bold">ìˆœìˆ˜ í‰ê·  ë‹¨ê°€ (ë¹„ìš© ì œì™¸)</th>
                    <td class="value-col text-indigo-700 font-extrabold">${formatCurrency(newAveragePrice, 2)} ì›</td>
                </tr>
                <tr>
                    <th><span class="text-gray-700">í‰ë‹¨ê°€ ë³€ë™ë¥ </span></th>
                    <td class="value-col">
                        <span class="${rateClass}">${ratePrefix}${isFinite(priceReductionRate) ? formatCurrency(priceReductionRate, 2) : 'N/A'} %</span>
                    </td>
                </tr>
                
                <tr class="font-bold text-lg bg-green-100 border-t-2 border-green-500">
                    <th><span class="text-green-800">ì†ìµë¶„ê¸°ì  ë§¤ë„ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ ë°˜ì˜)</span></th>
                    <td class="value-col dca-break-even-price-color">${isFinite(breakEvenPrice) ? formatCurrency(Math.floor(breakEvenPrice), 0) : 'ë¶ˆê°€ëŠ¥'} ì›</td>
                </tr>
                
                <tr>
                    <th colspan="2" class="text-center bg-indigo-200 border-t mt-4 py-2 font-bold text-base">
                        <span class="text-indigo-800">ë¬¼íƒ€ê¸° í›„: ì£¼ê°€ ${formatCurrency(currentMarketPrice, 0)}ì› ê¸°ì¤€ ì†ìµ ë¶„ì„</span>
                    </th>
                </tr>
                <tr>
                    <th><span class="text-gray-700">ì˜ˆìƒ ìˆœì´ìµ/ì†ì‹¤</span></th>
                    <td class="value-col">
                        <span class="${postDcaStatus.resultClass}">${postDcaStatus.profitLossText}</span>
                    </td>
                </tr>
                <tr>
                    <th><span class="text-gray-700">ì˜ˆìƒ ìˆœìˆ˜ìµë¥ </span></th>
                    <td class="value-col">
                        <span class="${postDcaStatus.resultClass}">${postDcaStatus.profitRateText}</span>
                    </td>
                </tr>

                <tr>
                    <th colspan="2" class="text-center bg-gray-50 border-t pt-4 font-bold text-sm">
                        <span class="text-gray-600">ì´ ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ í•©ê³„ (ì…ë ¥ê°’ ê¸°ì¤€)</span>
                    </th>
                </tr>
                <tr>
                    <th><span class="cost-color">ì´ ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ í•©ê³„</span></th>
                    <td class="value-col cost-color">${formatCurrency(marketCosts.totalDeductions, 0)} ì›</td>
                </tr>
                
            </tbody>
        `;

        document.getElementById('dca_resultTable').innerHTML = tableHTML;
        document.getElementById('dca_result').style.display = 'block';

        // ê²°ê³¼ì°½ì˜ í…Œë‘ë¦¬ì™€ ë°°ê²½ìƒ‰ì„ ìˆœì†ìµì— ë”°ë¼ ë³€ê²½
        const resultDiv = document.getElementById('dca_result');
        if (postDcaStatus.netProfitLoss > 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-red-500 bg-red-50 rounded-lg'; // ìˆ˜ìµì€ ë¹¨ê°„ìƒ‰
        } else if (postDcaStatus.netProfitLoss < 0) {
            resultDiv.className = 'result mt-6 p-4 border-2 border-blue-500 bg-blue-50 rounded-lg'; // ì†ì‹¤ì€ íŒŒë€ìƒ‰
        } else {
            resultDiv.className = 'result mt-6 p-4 border-2 border-gray-400 bg-gray-50 rounded-lg';
        }
    }
    
    // --- History Management Logic ---

    /**
     * ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ëª¨ë“  íˆìŠ¤í† ë¦¬ í•­ëª©ì„ ë¡œë“œí•©ë‹ˆë‹¤.
     */
    function loadHistory() {
        const storedHistory = getLocal(DCA_HISTORY_KEY);
        if (storedHistory) {
            try {
                return JSON.parse(storedHistory);
            } catch (e) {
                console.error("Failed to parse history from LocalStorage:", e);
                return [];
            }
        }
        return [];
    }

    /**
     * íˆìŠ¤í† ë¦¬ ë°°ì—´ì„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {Array} historyArray - ì €ì¥í•  íˆìŠ¤í† ë¦¬ ë°°ì—´
     */
    function saveHistoryToLocal(historyArray) {
        setLocal(DCA_HISTORY_KEY, JSON.stringify(historyArray));
        renderHistory();
    }
    
    /**
     * í˜„ì¬ ê³„ì‚°ê¸° ìƒíƒœë¥¼ ê°€ì ¸ì™€ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€í•©ë‹ˆë‹¤.
     */
    window.saveCurrentStateToHistory = function() {
        const nameInput = document.getElementById('history-name-input');
        const historyName = nameInput.value.trim();

        if (!historyName) {
            showHistoryMessage("ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "bg-yellow-100 text-yellow-800");
            return;
        }

        // í˜„ì¬ ì„ì‹œ ì €ì¥ëœ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (saveDcaStateê°€ ì´ë¯¸ ìµœì‹  ìƒíƒœë¥¼ ì €ì¥í–ˆìŒ)
        const storedState = getLocal(DCA_STATE_KEY);
        if (!storedState) {
            showHistoryMessage("ì €ì¥í•  ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "bg-yellow-100 text-yellow-800");
            return;
        }
        
        const history = loadHistory();
        
        const newEntry = {
            id: Date.now(), // Unique ID
            name: historyName,
            date: new Date().toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
            state: JSON.parse(storedState) // í˜„ì¬ ìƒíƒœ ê°ì²´ë¥¼ ì €ì¥
        };

        history.unshift(newEntry); // ìµœì‹  í•­ëª©ì„ ë§¨ ì•ì— ì¶”ê°€
        saveHistoryToLocal(history);
        nameInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        showHistoryMessage(`'${historyName}' ì‹œë®¬ë ˆì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, "bg-green-100 text-green-800");
    }
    
    /**
     * íˆìŠ¤í† ë¦¬ í•­ëª©ì„ ì‚­ì œí•©ë‹ˆë‹¤.
     * â­ï¸ ìˆ˜ì •ëœ ë¶€ë¶„: ì‚­ì œ ì „ ì‚¬ìš©ìì—ê²Œ í™•ì¸ì„ ìš”ì²­í•©ë‹ˆë‹¤. â­ï¸
     */
    window.deleteHistory = function(id, name) {
        if (!confirm(`íˆìŠ¤í† ë¦¬ "${name}" ê¸°ë¡ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        let history = loadHistory();
        const initialLength = history.length;
        history = history.filter(entry => entry.id !== id);
        
        if (history.length < initialLength) {
            saveHistoryToLocal(history);
            showHistoryMessage("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "bg-red-100 text-red-800");
        }
    }
    
    /**
     * íˆìŠ¤í† ë¦¬ í•­ëª©ì„ ê³„ì‚°ê¸°ì— ë¡œë“œí•©ë‹ˆë‹¤.
     */
    window.loadHistoryState = function(id) {
        const history = loadHistory();
        const entry = history.find(e => e.id === id);
        
        if (entry) {
            loadDcaState(entry.state); // ë¡œë“œ í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©
            showHistoryMessage(`'${entry.name}' ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, "bg-blue-100 text-blue-800");
        } else {
            showHistoryMessage("ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "bg-red-100 text-red-800");
        }
    }

    /**
     * íˆìŠ¤í† ë¦¬ ëª©ë¡ì„ UIì— ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function renderHistory() {
        const history = loadHistory();
        const tbody = document.getElementById('history-list-body');
        const emptyMsg = document.getElementById('history-empty-message');
        tbody.innerHTML = '';

        if (history.length === 0) {
            emptyMsg.classList.remove('hidden');
            return;
        }
        emptyMsg.classList.add('hidden');

        history.forEach(entry => {
            const row = document.createElement('tr');
            row.className = 'history-entry border-b border-gray-100';
            
            // ì´ ìˆ˜ëŸ‰ ë° í‰ê·  ë‹¨ê°€ ê³„ì‚° (ì •ë³´ í‘œì‹œìš©)
            const state = entry.state;
            const currentQty = parseFloat(state.dcaCurrentQuantity || 0);
            const currentCost = parseFloat(state.dcaCurrentPrice || 0) * currentQty;
            
            let totalNewCost = 0;
            let totalNewQuantity = 0;

            if (state.dcaEntries && Array.isArray(state.dcaEntries)) {
                state.dcaEntries.forEach(item => {
                    const price = parseFloat(item.price || 0);
                    const quantity = parseFloat(item.quantity || 0);
                    totalNewCost += price * quantity;
                    totalNewQuantity += quantity;
                });
            }

            const totalCostDCA = currentCost + totalNewCost;
            const totalQuantityDCA = currentQty + totalNewQuantity;
            
            const averagePrice = totalQuantityDCA > 0 ? (totalCostDCA / totalQuantityDCA) : 0;
            
            const summaryText = totalQuantityDCA > 0 
                ? `${formatCurrency(totalQuantityDCA, 0)} ì£¼ / í‰ë‹¨ ${formatCurrency(averagePrice, 0)} ì›`
                : 'ë°ì´í„° ì—†ìŒ';


            row.innerHTML = `
                <td class="py-3 px-1 font-medium text-gray-800 break-words w-1/3">
                    ${entry.name}
                    <div class="text-xs text-gray-500 mt-1">${entry.date.split(',')[0]}</div>
                </td>
                <td class="py-3 px-1 text-xs text-gray-600 w-1/3">
                    ${summaryText}
                </td>
                <td class="py-3 px-1 text-right space-x-2 w-1/3">
                    <button onclick="loadHistoryState(${entry.id})" class="history-action-btn bg-blue-500 hover:bg-blue-600 text-white rounded-md transition duration-150">
                        ë¡œë“œ
                    </button>
                    <button onclick="deleteHistory(${entry.id}, '${entry.name.replace(/'/g, "\\'")}')" class="history-action-btn bg-gray-300 hover:bg-red-500 hover:text-white text-gray-700 rounded-md transition duration-150">
                        ì‚­ì œ
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    /**
     * ì´ˆê¸°í™” í•¨ìˆ˜: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ê³  íˆìŠ¤í† ë¦¬ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
     */
    function initializeApp() {
        // 1. ë©”ì¸ ê³„ì‚°ê¸° ìƒíƒœ ë¡œë“œ (ì„ì‹œ ì €ì¥ ìƒíƒœ)
        loadDcaState(); 
        
        // 2. íˆìŠ¤í† ë¦¬ ëª©ë¡ ë Œë”ë§
        renderHistory();
    }

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });

</script>
</body>
</html>
