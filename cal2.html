<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ë¬¼íƒ€ê¸° ì†ìµ ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            font-family: 'Inter', Arial, sans-serif;
        }
        
        .calculator {
            max-width: 500px;
            margin: 20px auto;
            background: #ffffff;
            padding: 16px 12px; 
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .input-group {
             margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.95em;
            display: block;
            margin-bottom: 0.25rem;
        }
        input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            text-align: right;
            transition: border-color 0.3s;
            padding: 0.5rem 0.75rem;
        }
        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* ê°œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-individual-btn {
            width: 32px;
            height: 32px;
            line-height: 1;
            font-size: 1.1rem;
            color: #95a5a6;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reset-individual-btn:hover {
            background-color: #bdc3c7;
            color: #2c3e50;
        }
        
        /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            font-size: 0.9em; 
            table-layout: fixed; 
        }
        .result-table th, .result-table td {
            padding: 10px 8px; 
            border-bottom: 1px solid #ecf0f1;
            text-align: left;
            word-break: break-word; 
        }
        .result-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            width: 60%;
        }
        .result-table td {
            width: 40%;
        }
        .result-table tr:last-child td {
            border-bottom: none;
        }
        .result-table .value-col {
            text-align: right;
            font-weight: bold;
        }
        
        /* ë¹„ìš© í•­ëª© ìƒ‰ìƒ (íŒŒë€ìƒ‰ ê³„ì—´) */
        .cost-color {
            color: #3498db; 
            font-weight: 500;
        }
        
        /* ì†ìµë¶„ê¸°ì  ë‹¨ê°€ ê°•ì¡° (ë…¹ìƒ‰ ê³„ì—´) */
        .break-even-price-color {
            color: #2ecc71; /* ì—ë©”ë„ë“œ ê·¸ë¦° */
            font-weight: 800;
            font-size: 1.25em;
        }
        
        /* í˜„ì¬ ì†ìµ ê²°ê³¼ ìƒ‰ìƒ */
        .profit-text {
            color: #e74c3c; /* ìˆ˜ìµ (ë¹¨ê°„ìƒ‰) */
            font-weight: 800;
            font-size: 1.15em;
        }
        .loss-text {
            color: #3498db; /* ì†ì‹¤ (íŒŒë€ìƒ‰) */
            font-weight: 800;
            font-size: 1.15em;
        }
        .neutral-text {
            color: #34495e; /* ì¤‘ë¦½ (íšŒìƒ‰) */
            font-weight: 800;
            font-size: 1.15em;
        }
        
        /* ë¬¼íƒ€ê¸° ì´ì „ ì†ìµ (ì„¹ì…˜ 1 ë‚´ë¶€) */
        .pre-dca-result {
            margin-top: 10px;
            padding: 10px;
            border-top: 2px dashed #a0aec0;
            font-size: 0.9em;
            text-align: center;
        }
        .pre-dca-result .value {
            font-weight: bold;
            font-size: 1.05em;
        }

        /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í”¼ë“œë°± */
        .realtime-note {
            color: #27ae60;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            padding: 5px;
            border: 1px dashed #2ecc71;
            border-radius: 4px;
        }
        
        /* ë™ì  ì¶”ê°€ ë§¤ìˆ˜ í•­ëª© ìŠ¤íƒ€ì¼ */
        .purchase-entry {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-bottom: 12px;
            padding: 8px;
            background: #f0fff4; /* green-50 */
            border-radius: 8px;
            border: 1px solid #d1fae5; /* green-100 */
        }
        .purchase-entry .input-col {
            flex: 1 1 50%; /* ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ì´ 50%ì”© ì°¨ì§€ */
            min-width: 0;
        }
        .purchase-entry .input-col label {
            font-weight: normal;
            font-size: 0.85em;
            color: #065f46; /* green-900 */
        }
        .purchase-entry .input-col input {
            padding: 0.35rem 0.5rem;
            font-size: 0.9em;
        }
        .delete-btn {
            width: 32px;
            height: 32px;
            background: #fecaca; /* red-200 */
            color: #b91c1c; /* red-700 */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .delete-btn:hover {
            background-color: #fca5a5; /* red-300 */
        }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="calculator w-full">
    <h2 class="text-2xl font-bold text-center text-indigo-800 border-b-4 border-indigo-500 pb-3 mb-6">ğŸ’° ì£¼ì‹ ë¬¼íƒ€ê¸° ì†ìµ ì‹œë®¬ë ˆì´í„°</h2>
    <div class="realtime-note">ğŸ’¡ ëª¨ë“  ì…ë ¥ í•„ë“œ ìˆ˜ì • ì‹œ ì‹¤ì‹œê°„ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</div>

    
    <!-- 1. í˜„ì¬ ì‹œì¥ ê°€ê²© ì„¹ì…˜ -->
    <div class="p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg mb-6">
        <h3 class="text-xl font-semibold text-indigo-800 mb-4">1. í˜„ì¬ ì‹œì¥ ê°€ê²©</h3>
        
        <!-- í˜„ì¬ ì£¼ê°€ -->
        <div class="input-group">
            <label for="currentMarketPrice">í˜„ì¬ ì£¼ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="currentMarketPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaMarketPrice')" inputmode="numeric" class="w-full text-lg font-bold text-indigo-700">
                <button type="button" onclick="resetIndividualInput('currentMarketPrice', 'dcaMarketPrice', '0', 'currency')" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
    </div>

    <!-- 2. í˜„ì¬ ë³´ìœ  ì •ë³´ ì„¹ì…˜ -->
    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg mb-6">
        <h3 class="text-xl font-semibold text-blue-800 mb-4">2. í˜„ì¬ ë³´ìœ  ì •ë³´</h3>
        
        <!-- í˜„ì¬ í‰ë‹¨ê°€ -->
        <div class="input-group">
            <label for="currentPrice">í˜„ì¬ í‰ë‹¨ê°€ (1ì£¼ë‹¹ ê°€ê²©, ì›)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="currentPrice" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaCurrentPrice')" inputmode="numeric" class="w-full text-lg">
                <button type="button" onclick="resetIndividualInput('currentPrice', 'dcaCurrentPrice', '0', 'currency')" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
    
        <!-- í˜„ì¬ ìˆ˜ëŸ‰ -->
        <div class="input-group">
            <label for="currentQuantity">í˜„ì¬ ìˆ˜ëŸ‰ (ì´ ì£¼ì‹ ìˆ˜, ì£¼)</label>
            <div class="flex items-center space-x-2">
                <input type="text" id="currentQuantity" value="" required oninput="handleCurrencyInputAndSave(this, 'dcaCurrentQuantity')" inputmode="numeric" class="w-full text-lg">
                <button type="button" onclick="resetIndividualInput('currentQuantity', 'dcaCurrentQuantity', '0', 'currency')" class="reset-individual-btn" title="ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
        
        <!-- í˜„ì¬ ë³´ìœ  ì´ ì›ê¸ˆ (NEW) -->
        <div id="currentTotalCostContainer" class="p-2 mt-2 border-t border-gray-200 text-center hidden">
            <span class="text-gray-600 font-semibold text-sm">ì´ ë§¤ìˆ˜ ì›ê¸ˆ:</span>
            <span id="currentTotalCostDisplay" class="text-lg font-extrabold text-blue-800">0 ì›</span>
        </div>
        
        <!-- ë¬¼íƒ€ê¸° ì „ í˜„ì¬ ì£¼ê°€ ê¸°ì¤€ ì†ìµ -->
        <div id="preDcaResult" class="pre-dca-result hidden">
            <div class="text-gray-700 font-semibold mb-2">ë¬¼íƒ€ê¸° ì „ í˜„ì¬ ì˜ˆìƒ ì†ìµ</div>
            <div class="flex justify-between items-center text-base">
                <span class="text-gray-600">ìˆœì´ìµ/ì†ì‹¤:</span>
                <span id="preDcaProfitLoss" class="value loss-text">- 0 ì›</span>
            </div>
            <div class="flex justify-between items-center text-sm mt-1">
                <span class="text-gray-600">ìˆœìˆ˜ìµë¥ :</span>
                <span id="preDcaProfitRate" class="value loss-text">- 0.00 %</span>
            </div>
        </div>
    </div>


    <!-- 3. ì¶”ê°€ ë§¤ìˆ˜ ì •ë³´ ì„¹ì…˜ (ë‹¤ì¤‘ ì…ë ¥) -->
    <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded-lg mb-6">
        <h3 class="text-xl font-semibold text-green-800 mb-4">3. ì¶”ê°€ ë§¤ìˆ˜ ì •ë³´ (ë‹¤ì¤‘ ì…ë ¥)</h3>
        
        <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ë§¤ìˆ˜ í•­ëª© ì»¨í…Œì´ë„ˆ -->
        <div id="purchaseEntriesContainer">
            <!-- ì´ˆê¸° í•­ëª©ì€ JSì—ì„œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ì´ ì¶”ê°€ ë§¤ìˆ˜ í•©ì‚° ê¸ˆì•¡ -->
        <div class="p-2 mt-4 mb-4 bg-green-100 rounded-lg text-sm font-semibold text-green-800 flex justify-between">
            <span>ì´ ì¶”ê°€ ë§¤ìˆ˜ ìˆ˜ëŸ‰ / ê¸ˆì•¡:</span>
            <span id="totalNewPurchase" class="text-right">0 ì£¼ / 0 ì›</span>
        </div>
        
        <!-- í•­ëª© ì¶”ê°€ ë²„íŠ¼ -->
        <button type="button" onclick="addPurchaseEntry()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md">
            + ë§¤ìˆ˜ í•­ëª© ì¶”ê°€
        </button>
        
    </div>
    
    <!-- 4. ê±°ë˜ ë¹„ìš© ì„¤ì • ì„¹ì…˜ -->
    <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg mb-6">
        <h3 class="text-xl font-semibold text-yellow-800 mb-4">4. ê±°ë˜ ë¹„ìš© ì„¤ì • (%)</h3>
        
        <!-- ì´ ë§¤ë§¤ ìˆ˜ìˆ˜ë£Œìœ¨ -->
        <div class="input-group">
            <label for="feeRateInput">ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%) 
                <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.015% â†’ 0.015 ì…ë ¥)</span>
            </label>
            <div class="flex items-center space-x-2">
                <input type="text" id="feeRateInput" value="0.015" required oninput="handleRateInputAndSave(this, 'dcaFeeRate');" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('feeRateInput', 'dcaFeeRate', '0.015', 'rate')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.015%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>

        <!-- ë§¤ë„ ê±°ë˜ì„¸ìœ¨ -->
        <div class="input-group">
            <label for="taxRateInput">ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%) 
                <span class="text-gray-500 font-normal text-sm block"> (ì˜ˆ: 0.15% â†’ 0.15 ì…ë ¥)</span>
            </label>
            <div class="flex items-center space-x-2">
                <input type="text" id="taxRateInput" value="0.15" required oninput="handleRateInputAndSave(this, 'dcaTaxRate');" inputmode="decimal" class="w-full">
                <button type="button" onclick="resetIndividualInput('taxRateInput', 'dcaTaxRate', '0.15', 'rate')" class="reset-individual-btn" title="ê¸°ë³¸ê°’ (0.15%)ìœ¼ë¡œ ì´ˆê¸°í™”">â†º</button>
            </div>
        </div>
    </div>
    
    
    <div id="result" class="result mt-6 p-4 border-2 border-indigo-500 bg-indigo-50 rounded-lg" style="display: none;">
        <h3 class="text-xl font-semibold text-gray-700 text-center mb-3">âœ… ë¬¼íƒ€ê¸° í›„ ìµœì¢… ë¶„ì„ ê²°ê³¼</h3>
        
        <table id="resultTable" class="result-table">
            <!-- Content filled by JavaScript -->
        </table>
    </div>
</div>

<script type="module">
    // --- Global State & Configuration ---
    const DEFAULT_FEE_RATE = 0.015; // ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ %
    const DEFAULT_TAX_RATE = 0.15;   // ê¸°ë³¸ ê±°ë˜ì„¸ìœ¨ %
    let purchaseEntryIdCounter = 0; // ë™ì  í•­ëª© ê³ ìœ  ID ìƒì„±ìš© ì¹´ìš´í„°


    // --- Cookie Helper Functions ---

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function setCookie(name, value) {
        const date = new Date();
        date.setTime(date.getTime() + (30*24*60*60*1000)); // 30 days expiration
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
    }

    // --- Format & Input Handlers ---

    /**
     * ê¸ˆì•¡ì„ í•œêµ­ í†µí™” í˜•ì‹ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤. (ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ ì¶”ê°€)
     * @param {number} amount - ê¸ˆì•¡
     * @param {number} [precision=0] - ì†Œìˆ˜ì  ì´í•˜ ìë¦¿ìˆ˜. 0ì´ë©´ ì •ìˆ˜, 2ë©´ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€.
     * @returns {string} í¬ë§·ëœ ë¬¸ìì—´
     */
    function formatCurrency(amount, precision = 0) {
        if (typeof amount !== 'number' || isNaN(amount)) {
            amount = 0;
        }
        const absoluteAmount = Math.abs(amount);
        
        // ì •ë°€ë„ 0ì¸ ê²½ìš° (ì •ìˆ˜)
        if (precision === 0) {
            return Math.floor(absoluteAmount).toLocaleString('ko-KR', { maximumFractionDigits: 0 });
        }

        // ì •ë°€ë„ > 0 ì¸ ê²½ìš° (ì†Œìˆ˜ì  ì´í•˜)
        return absoluteAmount.toLocaleString('ko-KR', { minimumFractionDigits: precision, maximumFractionDigits: precision });
    }


    /**
     * ì…ë ¥ í•„ë“œì˜ ìˆ«ìë¥¼ í¬ë§·í•˜ê³  ì»¤ì„œ ìœ„ì¹˜ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤. 
     * @param {HTMLInputElement} input ì…ë ¥ ìš”ì†Œ
     */
    window.formatCurrencyInput = function(input) {
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 

        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '' || parseFloat(rawValue) === 0) {
            input.value = ''; // 0ì´ê±°ë‚˜ ë¹ˆê°’ì´ë©´ ë¹ˆ ë¬¸ìì—´ í‘œì‹œ
            return; 
        }
        
        const [integerPart, decimalPart] = rawValue.split('.');
        const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
        
        input.value = newValue;

        const diff = newValue.length - oldValue.length;
        let newCursorStart = cursorStart + diff;

        if (newValue.length > oldValue.length) {
            if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
        }
        
        newCursorStart = Math.min(newCursorStart, newValue.length);
        input.setSelectionRange(newCursorStart, newCursorStart);
    }
    
    /**
     * ê¸ˆì•¡ ì…ë ¥(ë‹¨ê°€/ìˆ˜ëŸ‰/ê¸ˆì•¡)ì„ í¬ë§·í•˜ê³ , í•´ë‹¹ ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë©°, ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.handleCurrencyInputAndSave = function(input, cookieName) {
        // 1. í¬ë§·íŒ… ë° ì»¤ì„œ ìœ„ì¹˜ ìœ ì§€
        const cursorStart = input.selectionStart;
        const oldValue = input.value;
        let rawValue = oldValue.replace(/[^0-9.]/g, ''); 
        
        const parts = rawValue.split('.');
        rawValue = parts.shift() + (parts.length > 0 ? '.' + parts.join('') : '');

        if (rawValue === '') {
            input.value = '';
            // ì •ì  ì…ë ¥ í•„ë“œë§Œ ì¿ í‚¤ ì €ì¥
            if (cookieName) setCookie(cookieName, '');
            calculateAllResults();
            return; 
        }
        
        // 0 ì…ë ¥ ì‹œ ë¹ˆ ë¬¸ìì—´ë¡œ í‘œì‹œ
        if (parseFloat(rawValue) === 0) {
            input.value = '';
        } else {
            const [integerPart, decimalPart] = rawValue.split('.');
            const formattedIntegerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const newValue = decimalPart !== undefined ? `${formattedIntegerPart}.${decimalPart}` : formattedIntegerPart;
            
            input.value = newValue;

            const diff = newValue.length - oldValue.length;
            let newCursorStart = cursorStart + diff;

            if (newValue.length > oldValue.length) {
                if (newValue.charAt(cursorStart) === ',' && cursorStart === newCursorStart - 1) {
                    newCursorStart = cursorStart + 1;
                }
            }
            
            newCursorStart = Math.min(newCursorStart, newValue.length);
            input.setSelectionRange(newCursorStart, newCursorStart);
        }
        
        // 2. ì¿ í‚¤ ì €ì¥ (ì •ì  ì…ë ¥ í•„ë“œë§Œ)
        if (cookieName) setCookie(cookieName, rawValue);

        // 3. ìë™ ê³„ì‚° ì‹¤í–‰
        calculateAllResults(); 
    }

    /**
     * ë¹„ìœ¨ ì…ë ¥(ìˆ˜ìˆ˜ë£Œìœ¨/ê±°ë˜ì„¸ìœ¨) ê°’ì„ ì¿ í‚¤ì— ì €ì¥í•˜ê³ , ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.handleRateInputAndSave = function(input, cookieName) {
        const rawValue = input.value.replace(/,/g, ''); 
        
        if (!isNaN(parseFloat(rawValue))) {
            setCookie(cookieName, rawValue);
        }
        
        calculateAllResults(); 
    }
    
    /**
     * ê°œë³„ ì…ë ¥ í•„ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ê³  ì¿ í‚¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ , ê³„ì‚°ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
     */
    window.resetIndividualInput = function(inputId, cookieName, defaultValue, type) {
        const input = document.getElementById(inputId);
        
        if (type === 'currency') {
            // í†µí™”/ìˆ˜ëŸ‰ ì…ë ¥ì€ 0ì¼ ë•Œ ë¹ˆ ë¬¸ìì—´ë¡œ í‘œì‹œ
            input.value = ""; 
            setCookie(cookieName, defaultValue); 
        } else { // rate
            input.value = defaultValue; 
            setCookie(cookieName, defaultValue);
        }
        
        calculateAllResults();
    };


    // --- Dynamic Purchase Entry Handlers ---

    /**
     * ë™ì  ë§¤ìˆ˜ í•­ëª©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
     */
    window.addPurchaseEntry = function() {
        const container = document.getElementById('purchaseEntriesContainer');
        const id = purchaseEntryIdCounter++;
        
        const entryDiv = document.createElement('div');
        entryDiv.className = 'purchase-entry';
        entryDiv.dataset.id = id;
        
        // ë‹¨ê°€ ì…ë ¥ í•„ë“œ
        entryDiv.innerHTML += `
            <div class="input-col">
                <label for="price-${id}">ë‹¨ê°€ (ì›)</label>
                <input type="text" id="price-${id}" value="" required oninput="handleCurrencyInputAndSave(this, null)" inputmode="numeric" class="w-full text-sm">
            </div>
            <div class="input-col">
                <label for="qty-${id}">ìˆ˜ëŸ‰ (ì£¼)</label>
                <input type="text" id="qty-${id}" value="" required oninput="handleCurrencyInputAndSave(this, null)" inputmode="numeric" class="w-full text-sm">
            </div>
            <button type="button" onclick="removePurchaseEntry(${id})" class="delete-btn" title="í•­ëª© ì‚­ì œ">Ã—</button>
        `;
        
        container.appendChild(entryDiv);

        calculateAllResults();
    };

    /**
     * ë™ì  ë§¤ìˆ˜ í•­ëª©ì„ ì œê±°í•©ë‹ˆë‹¤.
     */
    window.removePurchaseEntry = function(id) {
        const entry = document.querySelector(`.purchase-entry[data-id="${id}"]`);
        if (entry) {
            entry.remove();
            calculateAllResults();
        }
    };


    // --- Calculation Logic ---

    /**
     * ì´ ê±°ë˜ ë¹„ìš© (ìˆ˜ìˆ˜ë£Œ, ê±°ë˜ì„¸)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
     * @param {number} totalBuyCost - ì´ ë§¤ìˆ˜ ì›ê¸ˆ
     * @param {number} totalQuantity - ì´ ìˆ˜ëŸ‰
     * @param {number} sellPrice - ë§¤ë„ ë‹¨ê°€ (ë˜ëŠ” ì‹œì¥ ê°€ê²©)
     * @param {number} feeRate - ë§¤ìˆ˜/ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%)
     * @param {number} taxRate - ë§¤ë„ ê±°ë˜ì„¸ìœ¨ (%)
     */
    function calculateTotalCosts(totalBuyCost, totalQuantity, sellPrice, feeRate, taxRate) {
        const F = feeRate / 100; // ìˆ˜ìˆ˜ë£Œìœ¨ (ì†Œìˆ˜)
        const T = taxRate / 100;   // ê±°ë˜ì„¸ìœ¨ (ì†Œìˆ˜)
        
        // 1. ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ (ì´ ë§¤ìˆ˜ ë¹„ìš©ì— ì ìš©)
        const buyFee = totalBuyCost * F;
        
        // 2. ì´ ë§¤ë„ ê¸ˆì•¡ (ë§¤ë„ ì‹œ ë‹¨ê°€ ê¸°ì¤€)
        const grossSellAmount = sellPrice * totalQuantity;
        
        // 3. ë§¤ë„ ìˆ˜ìˆ˜ë£Œ (ë§¤ë„ ê¸ˆì•¡ì— ì ìš©)
        const sellFee = grossSellAmount * F;
        
        // 4. ê±°ë˜ì„¸ (ë§¤ë„ ê¸ˆì•¡ì— ì ìš©)
        const salesTax = grossSellAmount * T;
        
        const totalFee = buyFee + sellFee;
        const totalTax = salesTax;
        const totalDeductions = totalFee + totalTax;

        return { buyFee, sellFee, salesTax, totalFee, totalTax, totalDeductions, grossSellAmount };
    }
    
    /**
     * ì†ìµ ê¸ˆì•¡ê³¼ ìˆ˜ìµë¥ ì„ ê³„ì‚°í•˜ê³  í¬ë§·í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    function calculateProfitStatus(totalCost, totalQuantity, marketPrice, feeRate, taxRate) {
        if (totalCost === 0 || totalQuantity === 0 || marketPrice === 0) {
            return {
                netProfitLoss: 0, netProfitRate: 0, 
                profitLossText: '0 ì›', profitRateText: '0.00 %', 
                resultClass: 'neutral-text'
            };
        }
        
        // 1. í˜„ì¬ ì£¼ê°€ë¡œ ë§¤ë„í–ˆì„ ë•Œì˜ ë¹„ìš© ê³„ì‚°
        const costs = calculateTotalCosts(totalCost, totalQuantity, marketPrice, feeRate, taxRate);
        
        // 2. ìˆœì´ìµ/ì†ì‹¤ = (ì´ ë§¤ë„ ê¸ˆì•¡) - (ì´ ë§¤ìˆ˜ ì›ê¸ˆ) - (ì´ ê±°ë˜ ë¹„ìš©)
        const netProfitLoss = costs.grossSellAmount - totalCost - costs.totalDeductions;
        
        // 3. ìˆœìˆ˜ìµë¥  = (ìˆœì´ìµ/ì†ì‹¤ / ì´ ë§¤ìˆ˜ ì›ê¸ˆ) * 100
        const netProfitRate = (netProfitLoss / totalCost) * 100;

        // 4. ìŠ¤íƒ€ì¼ ë° ë¶€í˜¸ ê²°ì •
        let resultClass = 'neutral-text';
        let signPrefix = ''; 
        
        if (netProfitLoss > 0) {
            resultClass = 'profit-text';
            signPrefix = '+ ';
        } else if (netProfitLoss < 0) {
            resultClass = 'loss-text';
            signPrefix = '- ';
        }

        // ì†ìµê¸ˆì•¡ (ì •ìˆ˜, ì‰¼í‘œ)
        const profitLossText = signPrefix + formatCurrency(netProfitLoss, 0) + ' ì›'; 
        // ìˆ˜ìµë¥  (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬)
        const profitRateText = signPrefix + (isFinite(netProfitRate) ? formatCurrency(netProfitRate, 2) : 'N/A') + ' %';
        
        return { netProfitLoss, netProfitRate, profitLossText, profitRateText, resultClass };
    }
    
    /**
     * ë™ì  ë§¤ìˆ˜ í•­ëª©ë“¤ì˜ ì´í•©ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
     * @returns {{ totalNewCost: number, totalNewQuantity: number }}
     */
    function aggregateDCAValues() {
        let totalNewCost = 0;
        let totalNewQuantity = 0;
        
        const entries = document.querySelectorAll('#purchaseEntriesContainer .purchase-entry');
        
        entries.forEach(entry => {
            const id = entry.dataset.id;
            const priceInput = document.getElementById(`price-${id}`);
            const qtyInput = document.getElementById(`qty-${id}`);
            
            const price = parseFloat(priceInput.value.replace(/,/g, '')) || 0;
            // ìˆ˜ëŸ‰ì€ ì •ìˆ˜ë§Œ ìœ íš¨í•˜ë„ë¡ ì²˜ë¦¬
            const quantity = Math.floor(parseFloat(qtyInput.value.replace(/,/g, '')) || 0);

            if (quantity > 0) {
                totalNewQuantity += quantity;
                totalNewCost += price * quantity;
            }
        });

        // UI ì—…ë°ì´íŠ¸
        document.getElementById('totalNewPurchase').innerText = 
            `${formatCurrency(totalNewQuantity, 0)} ì£¼ / ${formatCurrency(totalNewCost, 0)} ì›`;
        
        return { totalNewCost, totalNewQuantity };
    }


    /**
     * ë¬¼íƒ€ê¸° í›„ ëª¨ë“  ê²°ê³¼ë¥¼ ê³„ì‚°í•˜ê³  í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
     */
    window.calculateAllResults = function() {
        // 1. ì •ì  ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸° ë° íŒŒì‹±
        const currentPrice = parseFloat(document.getElementById('currentPrice').value.replace(/,/g, '')) || 0;
        const currentQuantity = parseFloat(document.getElementById('currentQuantity').value.replace(/,/g, '')) || 0;
        const currentMarketPrice = parseFloat(document.getElementById('currentMarketPrice').value.replace(/,/g, '')) || 0;
        
        // ì„¹ì…˜ 4ì—ì„œ ë¹„ìš© ê°’ ê°€ì ¸ì˜¤ê¸°
        const feeRate = parseFloat(document.getElementById('feeRateInput').value.replace(/,/g, '')) || 0;
        const taxRate = parseFloat(document.getElementById('taxRateInput').value.replace(/,/g, '')) || 0;

        // 2. ë™ì  ë§¤ìˆ˜ ê°’ ì§‘ê³„
        const dcaValues = aggregateDCAValues();
        const newTotalCost = dcaValues.totalNewCost;
        const newQuantity = dcaValues.totalNewQuantity;

        // 3. ê¸°ë³¸ê°’ ê³„ì‚° (í•©ì‚° í›„)
        const currentTotalCost = currentPrice * currentQuantity;
        
        // Update Current Total Cost Display
        const costContainer = document.getElementById('currentTotalCostContainer');
        const costDisplay = document.getElementById('currentTotalCostDisplay');
        
        if (currentTotalCost > 0) {
            costDisplay.innerText = formatCurrency(currentTotalCost, 0) + ' ì›';
            costContainer.classList.remove('hidden');
        } else {
            costContainer.classList.add('hidden');
        }
        
        const totalCostDCA = currentTotalCost + newTotalCost; // ì´ íˆ¬ì ì›ê¸ˆ (í•©ì‚° í›„)
        const totalQuantityDCA = currentQuantity + newQuantity; // ì´ ìˆ˜ëŸ‰ (í•©ì‚° í›„)
        
        // 4. ë¬¼íƒ€ê¸° ì „ ìƒíƒœ ë¶„ì„ (Pre-DCA) - ë¹„ìš© ë°˜ì˜
        const preDcaStatus = calculateProfitStatus(currentTotalCost, currentQuantity, currentMarketPrice, feeRate, taxRate);
        const preDcaDiv = document.getElementById('preDcaResult');
        
        if (currentTotalCost > 0 && currentMarketPrice > 0) {
            document.getElementById('preDcaProfitLoss').innerText = preDcaStatus.profitLossText;
            document.getElementById('preDcaProfitLoss').className = 'value ' + preDcaStatus.resultClass;
            document.getElementById('preDcaProfitRate').innerText = preDcaStatus.profitRateText;
            document.getElementById('preDcaProfitRate').className = 'value ' + preDcaStatus.resultClass;
            preDcaDiv.classList.remove('hidden');
        } else {
            preDcaDiv.classList.add('hidden');
        }

        // 5. ê²°ê³¼ ìˆ¨ê¹€ ì²˜ë¦¬ (í•©ì‚° í›„ ì´ ìˆ˜ëŸ‰ ë˜ëŠ” ì´ ì›ê¸ˆì´ 0ì´ë©´ ê³„ì‚° ì˜ë¯¸ ì—†ìŒ)
        if (totalQuantityDCA === 0 || totalCostDCA === 0) {
            document.getElementById('result').style.display = 'none';
            return;
        }
        
        // 6. ìˆœìˆ˜ í‰ê·  ë‹¨ê°€ ê³„ì‚° (í•©ì‚° í›„, ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ë¯¸ë°˜ì˜)
        const newAveragePrice = totalCostDCA / totalQuantityDCA;
        
        // 7. ì†ìµë¶„ê¸°ì  ë§¤ë„ ë‹¨ê°€ (Break-Even Price) ê³„ì‚°
        const F = feeRate / 100; 
        const T = taxRate / 100;   
        
        let breakEvenPrice = 0;
        
        const numerator = totalCostDCA * (1 + F); // ì´ ë§¤ìˆ˜ ì›ê¸ˆ + ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ
        const denominator = totalQuantityDCA * (1 - F - T); // ì´ ìˆ˜ëŸ‰ * (1 - ë§¤ë„ìˆ˜ìˆ˜ë£Œìœ¨ - ê±°ë˜ì„¸ìœ¨)
        
        if (denominator > 0) {
            breakEvenPrice = numerator / denominator;
        } else {
             breakEvenPrice = Infinity;
        }
        
        // 8. ë¬¼íƒ€ê¸° í›„ í˜„ì¬ ì£¼ê°€ ê¸°ì¤€ ì˜ˆìƒ ì†ìµ ë¶„ì„ (Post-DCA) - ë¹„ìš© ë°˜ì˜
        const postDcaStatus = calculateProfitStatus(totalCostDCA, totalQuantityDCA, currentMarketPrice, feeRate, taxRate);
        
        // 9. í‰ë‹¨ê°€ ë³€ë™ë¥  ê³„ì‚° (ìˆœìˆ˜ í‰ë‹¨ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ)
        let priceReductionRate = 0;
        if (currentPrice > 0) {
             priceReductionRate = ((currentPrice - newAveragePrice) / currentPrice) * 100;
        }

        // í‰ë‹¨ê°€ ë³€ë™ë¥  í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê²°ì •
        let rateClass = 'text-gray-700';
        let ratePrefix = '';
        if (priceReductionRate > 0) {
            rateClass = 'text-red-600 font-bold'; // ê°ì†Œ (ë¹¨ê°„ìƒ‰)
            ratePrefix = 'â†“ ';
        } else if (priceReductionRate < 0) {
            rateClass = 'text-blue-600 font-bold'; // ì¦ê°€ (íŒŒë€ìƒ‰)
            ratePrefix = 'â†‘ ';
            priceReductionRate = Math.abs(priceReductionRate);
        }
        
        // 10. ë¹„ìš© ìƒì„¸ ê³„ì‚° (í˜„ì¬ ì£¼ê°€ ê¸°ì¤€)
        const marketCosts = calculateTotalCosts(totalCostDCA, totalQuantityDCA, currentMarketPrice, feeRate, taxRate);


        // 11. ê²°ê³¼ ì¶œë ¥ (í…Œì´ë¸” í˜•ì‹)
        const tableHTML = `
            <thead>
                <tr>
                    <th colspan="2" class="text-center bg-indigo-100 rounded-t-lg">í•©ì‚° ê²°ê³¼ ìš”ì•½</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>ì´ ìˆ˜ëŸ‰</th>
                    <td class="value-col">${formatCurrency(totalQuantityDCA, 0)} ì£¼</td>
                </tr>
                <tr>
                    <th>ì´ í•©ì‚° ë§¤ìˆ˜ ì›ê¸ˆ</th>
                    <td class="value-col">${formatCurrency(totalCostDCA, 0)} ì›</td>
                </tr>
                
                <tr class="bg-yellow-100">
                    <th class="font-bold">ìˆœìˆ˜ í‰ê·  ë‹¨ê°€ (ë¹„ìš© ì œì™¸)</th>
                    <td class="value-col text-indigo-700 font-extrabold">${formatCurrency(newAveragePrice, 2)} ì›</td>
                </tr>
                <tr>
                    <th><span class="text-gray-700">í‰ë‹¨ê°€ ë³€ë™ë¥ </span></th>
                    <td class="value-col">
                        <span class="${rateClass}">${ratePrefix}${isFinite(priceReductionRate) ? formatCurrency(priceReductionRate, 2) : 'N/A'} %</span>
                    </td>
                </tr>
                
                <!-- ì†ìµë¶„ê¸°ì  (ì†Œìˆ˜ì  ë²„ë¦¼ ì²˜ë¦¬) -->
                <tr class="font-bold text-lg bg-green-100 border-t-2 border-green-500">
                    <th><span class="text-green-800">ì†ìµë¶„ê¸°ì  ë§¤ë„ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ ë°˜ì˜)</span></th>
                    <td class="value-col break-even-price-color">${isFinite(breakEvenPrice) ? formatCurrency(Math.floor(breakEvenPrice), 0) : 'ë¶ˆê°€ëŠ¥'} ì›</td>
                </tr>
                
                <!-- ë¬¼íƒ€ê¸° í›„ í˜„ì¬ ì£¼ê°€ ê¸°ì¤€ ì†ìµ -->
                <tr>
                    <th colspan="2" class="text-center bg-indigo-200 border-t mt-4 py-2 font-bold text-base">
                        <span class="text-indigo-800">ë¬¼íƒ€ê¸° í›„: ì£¼ê°€ ${formatCurrency(currentMarketPrice, 0)}ì› ê¸°ì¤€ ì†ìµ ë¶„ì„</span>
                    </th>
                </tr>
                <tr>
                    <th><span class="text-gray-700">ì˜ˆìƒ ìˆœì´ìµ/ì†ì‹¤</span></th>
                    <td class="value-col">
                        <span class="${postDcaStatus.resultClass}">${postDcaStatus.profitLossText}</span>
                    </td>
                </tr>
                <tr>
                    <th><span class="text-gray-700">ì˜ˆìƒ ìˆœìˆ˜ìµë¥ </span></th>
                    <td class="value-col">
                        <span class="${postDcaStatus.resultClass}">${postDcaStatus.profitRateText}</span>
                    </td>
                </tr>

                <!-- ë¹„ìš© ìš”ì•½ (ì…ë ¥ëœ ë¹„ìš© ê¸°ì¤€) -->
                <tr>
                    <th colspan="2" class="text-center bg-gray-50 border-t pt-4 font-bold text-sm">
                        <span class="text-gray-600">ì´ ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ í•©ê³„ (ì…ë ¥ê°’ ê¸°ì¤€)</span>
                    </th>
                </tr>
                <tr>
                    <th><span class="cost-color">ì´ ìˆ˜ìˆ˜ë£ŒÂ·ì„¸ê¸ˆ í•©ê³„</span></th>
                    <td class="value-col cost-color">${formatCurrency(marketCosts.totalDeductions, 0)} ì›</td>
                </tr>
                
            </tbody>
        `;

        document.getElementById('resultTable').innerHTML = tableHTML;
        document.getElementById('result').style.display = 'block';
    }
    
    /**
     * ì¿ í‚¤ì— ì €ì¥ëœ ëª¨ë“  ê°’ì„ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ì›ë‹ˆë‹¤.
     */
    function loadFromCookies() {
        // í†µí™”/ìˆ˜ëŸ‰ ë¡œë“œ (ì •ì  í•„ë“œ)
        const currencyInputs = [
            { id: 'currentPrice', cookie: 'dcaCurrentPrice', default: '0' },
            { id: 'currentQuantity', cookie: 'dcaCurrentQuantity', default: '0' },
            { id: 'currentMarketPrice', cookie: 'dcaMarketPrice', default: '0' }
        ];

        currencyInputs.forEach(item => {
            const input = document.getElementById(item.id);
            const storedValue = getCookie(item.cookie);
            
            // ì €ì¥ëœ ê°’ì´ ìˆê±°ë‚˜ ê¸°ë³¸ê°’ì´ 0ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê°’ì„ ì„¤ì •
            if (storedValue !== null && storedValue !== "" && parseFloat(storedValue) !== 0) {
                input.value = storedValue;
                window.formatCurrencyInput(input); 
            } 
        });
        
        // ë¹„ìœ¨ ë¡œë“œ (ë¹„ìš© í•„ë“œ)
        const feeRateInput = document.getElementById('feeRateInput');
        const taxRateInput = document.getElementById('taxRateInput');

        const storedFeeRate = getCookie('dcaFeeRate');
        const storedTaxRate = getCookie('dcaTaxRate');
        
        feeRateInput.value = (storedFeeRate !== null && storedFeeRate !== "") ? storedFeeRate : DEFAULT_FEE_RATE;
        taxRateInput.value = (storedTaxRate !== null && storedTaxRate !== "") ? storedTaxRate : DEFAULT_TAX_RATE;
        
        // ì´ˆê¸° ë™ì  ë§¤ìˆ˜ í•­ëª© í•˜ë‚˜ ì¶”ê°€ (ë¹ˆ ì¹¸ìœ¼ë¡œ ì‹œì‘)
        addPurchaseEntry(); 
    }

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', () => {
        loadFromCookies(); 
    });

</script>
</body>
</html>


