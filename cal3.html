<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>히스토리 계산기</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 설정 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* Light Gray Background */
        }
        
        /* 키 색상 정의 (밝은 테마) */
        .key { 
            background-color: #D1D5DB; /* Gray-300 */
            color: #1F2937; /* Dark Text */
            transition: transform 0.1s;
        }
        .key:active { transform: scale(0.95); }

        .operator { 
            background-color: #A9B3BF; /* Custom lighter gray */
            color: #1F2937; /* Dark Text */
            transition: transform 0.1s;
        }
        .operator:active { transform: scale(0.95); }

        .equal { 
            background-color: #10B981; /* Emerald-500 */
            color: #F9FAFB; /* Light Text */
            transition: transform 0.1s;
        }
        .equal:active { transform: scale(0.95); }

        .clear-key { 
            background-color: #EF4444; /* Red-500 */
            color: white; 
        }
        .backspace-key { 
            background-color: #FBBF24; /* Amber-400 */
            color: #1F2937; /* Dark Text */
        }

        .history-item {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .history-item-light {
            background-color: #F3F4F6; /* Lighter background for history item */
        }
        .history-item-light:hover {
            background-color: #E5E7EB; /* Lighter hover effect */
        }

        /* 스크롤바 숨기기 (선택 사항) */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* 모바일 우선 반응형 레이아웃 */
        .main-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 40rem; /* 최대 너비 제한 */
            margin: 0 auto;
        }
        /* 데스크탑 환경에서는 계산기와 히스토리를 옆으로 나란히 배치 */
        @media (min-width: 768px) {
            .main-grid {
                flex-direction: row;
                gap: 1.5rem;
                max-width: 60rem;
                align-items: flex-start;
            }
            .calculator-card {
                flex: 1; 
                min-width: 384px; 
            }
            .history-sidebar {
                flex: 1; 
                max-height: 80vh; 
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-200 min-h-screen pt-8 p-4 md:p-8">

    <div class="main-grid">
        <!-- Calculator Card (Left/Top) -->
        <div id="calculator" class="calculator-card w-full max-w-sm bg-white p-5 rounded-3xl shadow-xl transition-all duration-300 mx-auto">
            <!-- Display -->
            <div id="display" class="bg-gray-100 mb-4 rounded-2xl p-4 flex flex-col items-end justify-end font-light overflow-x-auto whitespace-nowrap scrollbar-hide" style="height: 5rem; color: #1F2937;">
                <div id="previous-op" class="text-sm text-gray-500 h-6"></div>
                <div id="current-op" class="text-4xl text-gray-900 h-10">0</div>
            </div>

            <!-- Button Grid (Revised Layout) -->
            <div id="main-button-grid" class="grid grid-cols-4 gap-3">
                <!-- Row 1: Operators ÷, ×, -, + (Full Top Row, requested order) -->
                <button class="operator text-2xl p-4 rounded-full shadow-md" data-value="/">÷</button>
                <button class="operator text-2xl p-4 rounded-full shadow-md" data-value="*">×</button>
                <button class="operator text-2xl p-4 rounded-full shadow-md" data-value="-">-</button>
                <button class="operator text-2xl p-4 rounded-full shadow-md" data-value="+">+</button>
                
                <!-- Row 2: Numbers 7, 8, 9, Backspace (Utility) -->
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="7">7</button>
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="8">8</button>
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="9">9</button>
                <button class="backspace-key text-2xl p-4 rounded-full shadow-md hover:brightness-110 transition-all duration-150" onclick="deleteLast()">⌫</button>

                <!-- Row 3: Numbers 4, 5, 6, AC (Utility) -->
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="4">4</button>
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="5">5</button>
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="6">6</button>
                <button class="clear-key text-white text-2xl p-4 rounded-full shadow-md hover:brightness-110 transition-all duration-150" onclick="clearDisplay()">AC</button>

                <!-- Row 4: Numbers 1, 2, 3, Equals (Utility, spans 2 rows) -->
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="1">1</button>
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="2">2</button>
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value="3">3</button>
                <button class="equal text-2xl p-4 rounded-full shadow-md row-span-2" onclick="calculate()">=</button> 
                
                <!-- Row 5: 0 (spans 2 columns), Decimal -->
                <button class="key text-2xl p-4 rounded-full col-span-2 shadow-md" data-value="0">0</button>
                <button class="key text-2xl p-4 rounded-full shadow-md" data-value=".">.</button>
                <!-- Column 4 is occupied by row-span-2 "=" -->
            </div>
        </div>

        <!-- History Sidebar (Right/Bottom) -->
        <div class="history-sidebar w-full md:w-80 bg-white rounded-3xl shadow-xl p-5 overflow-y-auto">
            <div class="mb-4 border-b border-gray-300 pb-2">
                <h2 class="text-xl font-bold text-gray-800">계산 기록 (History)</h2>
            </div>
            
            <!-- History List -->
            <div id="history-list" class="space-y-3">
                <!-- History items will be inserted here -->
                <p id="history-empty" class="text-gray-500 text-center text-sm mt-8">기록이 없습니다.</p>
            </div>
        </div>
    </div>

    <script>
        // JavaScript for Calculator Logic
        const currentOpDisplay = document.getElementById('current-op');
        const previousOpDisplay = document.getElementById('previous-op');
        const historyList = document.getElementById('history-list');

        let currentExpression = '';
        let resultDisplayed = false;
        let history = [];

        // 상수 정의
        const LAST_CALCULATION_KEY = 'last_calculation';
        const HISTORY_KEY = 'calculation_history';

        // --- 초기화 및 데이터 로드 ---
        window.onload = function() {
            loadState();
            renderHistory();

            // 모든 버튼에 이벤트 리스너를 추가합니다.
            document.querySelectorAll('.key, .operator').forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.getAttribute('data-value');
                    if (value) {
                        appendToDisplay(value);
                    }
                });
            });
        };
        
        /**
         * 로컬 스토리지에서 상태를 로드합니다.
         */
        function loadState() {
            const savedExpression = localStorage.getItem(LAST_CALCULATION_KEY);
            if (savedExpression) {
                currentExpression = savedExpression;
                currentOpDisplay.textContent = currentExpression;
            } else {
                currentOpDisplay.textContent = '0';
            }

            const savedHistory = localStorage.getItem(HISTORY_KEY);
            if (savedHistory) {
                try {
                    // JSON 문자열을 배열로 파싱
                    history = JSON.parse(savedHistory);
                } catch (e) {
                    console.error("Failed to parse history from localStorage:", e);
                    history = [];
                }
            }
        }

        /**
         * 현재 수식을 로컬 스토리지에 저장합니다.
         */
        function saveExpression() {
            localStorage.setItem(LAST_CALCULATION_KEY, currentExpression);
        }

        /**
         * 히스토리 배열을 로컬 스토리지에 저장합니다.
         */
        function saveHistory() {
            // 배열을 JSON 문자열로 변환하여 저장
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        // --- 히스토리 기능 구현 ---
        
        /**
         * 히스토리를 렌더링하고 비어있을 때 메시지를 표시합니다.
         */
        function renderHistory() {
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-gray-500 text-center text-sm mt-8';
                p.textContent = '기록이 없습니다.';
                historyList.appendChild(p);
                return;
            }

            // 배열을 역순으로 반복하여 가장 최근 기록을 위에 표시합니다.
            // i는 원본 배열에서의 인덱스를 의미합니다.
            for (let i = history.length - 1; i >= 0; i--) {
                const item = history[i];

                // 밝은 테마용 클래스 적용
                const div = document.createElement('div');
                div.className = 'history-item history-item-light p-3 rounded-xl shadow-sm flex justify-between items-start border border-gray-200';
                
                // 1. 기록 내용 (클릭 시 로드)
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-grow';
                contentDiv.innerHTML = `
                    <div class="text-sm text-gray-500">${item.expression.replace(/\*/g, '×').replace(/\//g, '÷')} =</div>
                    <div class="text-xl text-gray-900 font-semibold">${item.result}</div>
                `;
                contentDiv.addEventListener('click', () => loadFromHistory(item.result));


                // 2. 삭제 버튼 (개별 삭제)
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-gray-400 hover:text-red-600 p-1 ml-2 transition-colors duration-150 rounded-full flex-shrink-0';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                `;
                deleteButton.addEventListener('click', (event) => {
                    // 이벤트 버블링 방지 (기록 로드 이벤트 막기)
                    event.stopPropagation();
                    // 원본 배열 인덱스를 사용하여 삭제 함수 호출
                    deleteHistoryItem(i);
                });

                div.appendChild(contentDiv);
                div.appendChild(deleteButton);
                historyList.appendChild(div);
            }
        }

        /**
         * 히스토리 항목을 클릭했을 때 해당 결과를 현재 수식으로 로드합니다.
         * @param {string} result - 히스토리 항목의 결과값
         */
        function loadFromHistory(result) {
            currentExpression = String(result);
            currentOpDisplay.textContent = currentExpression;
            previousOpDisplay.textContent = ''; // 이전 수식 초기화
            resultDisplayed = true; // 결과 상태로 설정
            saveExpression();
        }

        /**
         * 지정된 인덱스의 히스토리 항목을 개별적으로 삭제합니다.
         * @param {number} index - history 배열에서의 항목 인덱스
         */
        function deleteHistoryItem(index) {
            // 원본 history 배열에서 해당 인덱스의 항목 1개를 제거
            history.splice(index, 1); 
            saveHistory(); // 변경된 배열 저장
            renderHistory(); // 화면 갱신
        }


        /**
         * 히스토리 전체를 삭제합니다. (UI에서 호출되지 않으나 로직은 유지)
         */
        function clearAllHistory() {
            history = [];
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        }

        // --- 계산기 핵심 로직 (이전과 동일) ---

        /**
         * 화면에 값 또는 연산자를 추가하고 저장합니다.
         * @param {string} value - 입력된 값 (숫자, 연산자)
         */
        function appendToDisplay(value) {
            // 결과가 표시된 후 숫자를 누르면 새 계산을 시작합니다.
            if (resultDisplayed && /[0-9.]/.test(value)) {
                currentExpression = value;
                resultDisplayed = false;
                previousOpDisplay.textContent = '';
            } else {
                // 결과가 표시된 상태에서 연산자를 누르면, 결과값을 첫 항으로 사용합니다.
                if (resultDisplayed && /[+\-*/]/.test(value)) {
                    resultDisplayed = false;
                    previousOpDisplay.textContent = '';
                } else if (resultDisplayed) {
                    resultDisplayed = false;
                }
                
                // 입력 유효성 검사
                const lastChar = currentExpression.slice(-1);
                const isOperator = /[+\-*/]/.test(value);
                const isLastCharOperator = /[+\-*/]/.test(lastChar);
                
                if (isOperator && isLastCharOperator) {
                    currentExpression = currentExpression.slice(0, -1) + value; // 연산자 대체
                } else if (value === '.') {
                    const parts = currentExpression.split(/[+\-*/]/);
                    const currentNumber = parts[parts.length - 1];
                    if (currentNumber.includes('.')) return;
                    
                    if (currentExpression === '' || isLastCharOperator) {
                        currentExpression += '0.';
                    } else {
                        currentExpression += value;
                    }
                } else {
                    currentExpression += value;
                }
            }

            // 화면에 표시
            currentOpDisplay.textContent = currentExpression || '0';
            currentOpDisplay.scrollLeft = currentOpDisplay.scrollWidth;
            
            // 상태를 localStorage에 저장
            saveExpression();
        }

        /**
         * AC (All Clear) 기능: 계산을 초기화하고 저장된 값을 지웁니다.
         */
        function clearDisplay() {
            currentExpression = '';
            currentOpDisplay.textContent = '0';
            previousOpDisplay.textContent = '';
            resultDisplayed = false;
            localStorage.removeItem(LAST_CALCULATION_KEY);
        }

        /**
         * 마지막 문자를 삭제합니다 (백스페이스).
         */
        function deleteLast() {
            if (currentExpression.length > 0) {
                currentExpression = currentExpression.slice(0, -1);
                currentOpDisplay.textContent = currentExpression || '0';
                resultDisplayed = false;
                saveExpression();
            } else {
                localStorage.removeItem(LAST_CALCULATION_KEY);
            }
        }

        /**
         * 계산을 수행하고 결과를 화면에 표시하며, 히스토리에 추가합니다.
         */
        function calculate() {
            if (currentExpression === '') return;

            // 이미 결과가 표시된 상태에서 = 버튼을 누르면 재계산 방지 (결과를 수식으로 사용)
            if (resultDisplayed) {
                previousOpDisplay.textContent = `${currentExpression} =`;
                return; 
            }

            try {
                // 수식 정리 및 유효성 검사
                let expressionToCalculate = currentExpression
                    .replace(/÷/g, '/')
                    .replace(/×/g, '*');
                
                // 마지막 문자가 연산자라면 계산하지 않고 제거
                if (/[+\-*/]$/.test(expressionToCalculate)) { 
                     expressionToCalculate = expressionToCalculate.slice(0, -1);
                }
                
                if (expressionToCalculate === '') {
                    clearDisplay();
                    return;
                }

                // 계산 실행
                let result = eval(expressionToCalculate);
                let originalExpression = currentExpression;

                // 오류 처리
                if (!isFinite(result)) {
                    currentOpDisplay.textContent = "오류: 0으로 나눔";
                    previousOpDisplay.textContent = originalExpression;
                    currentExpression = '';
                    resultDisplayed = true;
                    return;
                }

                // 결과 반올림 및 정리
                result = parseFloat(result.toFixed(10));
                
                // 히스토리에 추가
                const historyItem = {
                    expression: originalExpression,
                    result: result
                };
                history.push(historyItem);
                saveHistory();
                renderHistory(); // 히스토리 목록 업데이트

                // 화면 업데이트
                previousOpDisplay.textContent = `${originalExpression.replace(/\*/g, '×').replace(/\//g, '÷')} =`;
                currentExpression = String(result);
                currentOpDisplay.textContent = currentExpression;
                resultDisplayed = true;
                saveExpression(); // 계산 결과를 로컬 스토리지에 저장

            } catch (error) {
                currentOpDisplay.textContent = "수식 오류";
                previousOpDisplay.textContent = currentExpression.replace(/\*/g, '×').replace(/\//g, '÷');
                currentExpression = '';
                resultDisplayed = true;
            }
        }
    </script>
</body>
</html>


