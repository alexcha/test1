<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>히스토리 계산기 (라이트모드)</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 설정 및 라이트 모드 스타일 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* Light Gray Background */
        }
        
        /* 라이트 모드 키 색상 정의 */
        .key { 
            background-color: #FFFFFF; /* White Number/Decimal Key */
            color: #1F2937; /* Dark Text */
            transition: transform 0.1s;
        }
        .key:active { transform: scale(0.95); }

        .operator { 
            background-color: #E5E7EB; /* Gray-200 Operator Key */
            color: #1F2937; 
            transition: transform 0.1s;
        }
        .operator:active { transform: scale(0.95); }

        /* C, (), ±, ⌫ 버튼 스타일 */
        .utility-key {
            background-color: #D1D5DB; /* Gray-300 Utility Key */
            color: #1F2937;
            transition: transform 0.1s;
        }
        .utility-key:active { transform: scale(0.95); }

        .equal { 
            background-color: #10B981; /* Emerald-500 Green Equal Key */
            color: #FFFFFF; /* White Text for contrast */
            transition: transform 0.1s;
        }
        .equal:active { transform: scale(0.95); }

        .clear-key { 
            background-color: #EF4444; /* Red-500 C key */
            color: white; 
            transition: transform 0.1s;
        }
        .clear-key:active { transform: scale(0.95); }

        /* 디스플레이 스타일 */
        #display {
            background-color: #FFFFFF; /* White Display Background */
            color: #1F2937; /* Dark Text */
            border: 1px solid #D1D5DB; /* Subtle border */
        }
        #previous-op {
            color: #6B7280; /* Gray-500 for previous op */
        }
        #current-op {
            color: #1F2937; /* Dark Text for current op */
        }

        /* 히스토리 사이드바 (라이트 모드 적용) */
        .history-sidebar {
            background-color: #FFFFFF; /* White History Background */
            color: #1F2937; /* Dark Text */
            border: 1px solid #E5E7EB;
        }
        .history-sidebar h2 {
            color: #1F2937;
        }
        .history-sidebar .border-b {
            border-color: #D1D5DB; /* Light gray border for separator */
        }
        .history-item-dark {
            /* History item styling - using dark class but light colors */
            background-color: #F9FAFB; /* Off-white background for history item */
            border-color: #E5E7EB; 
            color: #1F2937;
        }
        .history-item-dark:hover {
            background-color: #EFF6FF; /* Subtle blue hover effect */
        }
        .history-item-dark .text-gray-500 {
             color: #6B7280; /* Darker gray for previous expression */
        }
        .history-item-dark .text-gray-900 {
            color: #1F2937; /* Dark text for result */
        }
        .history-sidebar .text-gray-500 {
            color: #6B7280; /* Text for empty history message */
        }
        
        /* 스크롤바 숨기기 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 모바일 우선 반응형 레이아웃 */
        .main-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 40rem; 
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            .main-grid {
                flex-direction: row;
                gap: 1.5rem;
                max-width: 65rem; /* 너비 확장 */
                align-items: flex-start;
            }
            .calculator-card {
                flex: 1; 
                min-width: 384px; 
            }
            .history-sidebar {
                flex: 1; 
                max-height: 90vh; 
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen pt-8 p-4 md:p-8">

    <div class="main-grid">
        <!-- Calculator Card (Left/Top) -->
        <div id="calculator" class="calculator-card w-full max-w-sm bg-white shadow-xl p-5 rounded-3xl transition-all duration-300 mx-auto">
            <!-- Display -->
            <div id="display" class="mb-4 rounded-2xl p-4 flex flex-col items-end justify-end font-light overflow-x-auto whitespace-nowrap scrollbar-hide" style="height: 5rem;">
                <div id="previous-op" class="text-sm h-6"></div>
                <div id="current-op" class="text-4xl font-normal h-10">0</div>
            </div>

            <!-- Button Grid (Image-based Layout) -->
            <div id="main-button-grid" class="grid grid-cols-4 gap-3">
                
                <!-- Row 1: C, (), ÷, ⌫ (Backspace) -->
                <button class="clear-key text-white text-2xl p-5 aspect-square rounded-full shadow-md" onclick="clearDisplay()">C</button>
                <button class="utility-key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="paren">()</button>
                <button class="operator text-2xl p-5 aspect-square rounded-full shadow-md" data-value="/">÷</button>
                <button class="utility-key text-2xl p-5 aspect-square rounded-full shadow-md" onclick="deleteLast()">⌫</button>
                
                <!-- Row 2: 7, 8, 9, × -->
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="7">7</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="8">8</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="9">9</button>
                <button class="operator text-2xl p-5 aspect-square rounded-full shadow-md" data-value="*">×</button>

                <!-- Row 3: 4, 5, 6, - -->
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="4">4</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="5">5</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="6">6</button>
                <button class="operator text-2xl p-5 aspect-square rounded-full shadow-md" data-value="-">-</button>

                <!-- Row 4: 1, 2, 3, + -->
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="1">1</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="2">2</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="3">3</button>
                <button class="operator text-2xl p-5 aspect-square rounded-full shadow-md" data-value="+">+</button>
                
                <!-- Row 5: +/-, 0, ., = -->
                <button class="utility-key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="plusminus">±</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value="0">0</button>
                <button class="key text-2xl p-5 aspect-square rounded-full shadow-md" data-value=".">.</button>
                <button class="equal text-2xl p-5 aspect-square rounded-full shadow-md" onclick="calculate()">=</button> 
            </div>
        </div>

        <!-- History Sidebar (Right/Bottom) -->
        <div class="history-sidebar w-full md:w-96 bg-white shadow-xl rounded-3xl p-5 overflow-y-auto">
            <div class="mb-4 border-b pb-2">
                <h2 class="text-xl font-bold">계산 기록 (History)</h2>
            </div>
            
            <!-- History List -->
            <div id="history-list" class="space-y-3">
                <!-- History items will be inserted here -->
                <p id="history-empty" class="text-gray-500 text-center text-sm mt-8">기록이 없습니다.</p>
            </div>
        </div>
    </div>

    <script>
        // JavaScript for Calculator Logic
        const currentOpDisplay = document.getElementById('current-op');
        const previousOpDisplay = document.getElementById('previous-op');
        const historyList = document.getElementById('history-list');

        let currentExpression = '';
        let resultDisplayed = false;
        let history = [];
        let openParentheses = 0; // 괄호 카운터

        // 상수 정의
        const LAST_CALCULATION_KEY = 'last_calculation';
        const HISTORY_KEY = 'calculation_history';
        const MAX_HISTORY_ITEMS = 10; // ⭐️ 최대 기록 항목 수 (10개)
        
        // --- 포맷팅 유틸리티 함수 ---

        /**
         * 숫자에 콤마(천 단위 구분 기호)를 추가합니다.
         * @param {string | number} number - 포맷팅할 숫자 또는 숫자 문자열
         * @returns {string} 콤마가 추가된 문자열
         */
        function formatNumberWithCommas(number) {
            if (typeof number !== 'string') {
                number = String(number);
            }
            
            // 부호와 소수점 부분을 분리합니다.
            const parts = number.split('.');
            let integerPart = parts[0];
            const decimalPart = parts.length > 1 ? '.' + parts[1] : '';
            const sign = integerPart.startsWith('-') ? '-' : '';
            
            // 부호 제거 후 정수 부분에 콤마 추가
            integerPart = integerPart.replace('-', '');
            // 정규 표현식: 숫자가 3개 단위로 반복되는 곳의 앞에 콤마 삽입
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            return sign + integerPart + decimalPart;
        }

        /**
         * 콤마(천 단위 구분 기호)를 제거합니다. (계산용)
         * @param {string} str - 콤마가 포함된 문자열
         * @returns {string} 콤마가 제거된 문자열
         */
        function stripCommas(str) {
            if (typeof str !== 'string') return String(str);
            return str.replace(/,/g, '');
        }

        // --- 초기화 및 데이터 로드 ---
        window.onload = function() {
            loadState();
            renderHistory();
            
            // 모든 버튼에 이벤트 리스너를 추가합니다.
            document.querySelectorAll('.key, .operator, .utility-key').forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.getAttribute('data-value');
                    if (value && value.length === 1) { // 숫자, . , 연산자
                        appendToDisplay(value);
                    } else if (value === 'paren') { // 괄호
                        handleParentheses();
                    } else if (value === 'plusminus') { // 부호 변경
                        handlePlusMinus();
                    }
                });
            });
        };
        
        /**
         * 로컬 스토리지에서 상태를 로드합니다.
         */
        function loadState() {
            const savedExpression = localStorage.getItem(LAST_CALCULATION_KEY);
            if (savedExpression) {
                currentExpression = savedExpression; // 콤마 없는 원본 수식 로드
                updateDisplay(); // 포맷팅하여 표시
            } else {
                currentOpDisplay.textContent = '0';
            }

            const savedHistory = localStorage.getItem(HISTORY_KEY);
            if (savedHistory) {
                try {
                    history = JSON.parse(savedHistory);
                    // 로드 시에도 최대 항목 수 유지 (오래된 항목 제거)
                    if (history.length > MAX_HISTORY_ITEMS) {
                        history.splice(0, history.length - MAX_HISTORY_ITEMS);
                        saveHistory(); // 변경된 배열 저장
                    }
                } catch (e) {
                    console.error("Failed to parse history from localStorage:", e);
                    history = [];
                }
            }
        }

        /**
         * 현재 수식을 로컬 스토리지에 저장합니다.
         */
        function saveExpression() {
            // currentExpression은 콤마 없이 저장됩니다.
            localStorage.setItem(LAST_CALCULATION_KEY, currentExpression);
        }

        /**
         * 히스토리 배열을 로컬 스토리지에 저장합니다.
         */
        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }
        
        /**
         * 현재 수식을 포맷팅하여 화면에 표시합니다.
         */
        function updateDisplay() {
            // 수식 문자열을 숫자, 연산자, 괄호 등으로 분리하여 포맷팅을 적용합니다.
            const formattedExpression = currentExpression.split(/([+\-*/()])/)
                .map(part => {
                    // 숫자, 소수점, 부호로만 이루어진 부분을 찾고 콤마 포맷팅 적용
                    // part가 비어있지 않고, 숫자나 소수점을 포함하며, 연산자/괄호가 아닌 경우 (즉, 숫자 항인 경우)
                    if (part.length > 0 && (/[0-9]/.test(part) || part === '0.') && !/[+\-*/()]/.test(part)) {
                        return formatNumberWithCommas(part);
                    }
                    return part; // 연산자, 괄호 등은 그대로 반환
                }).join('');
            
            currentOpDisplay.textContent = formattedExpression || '0';
            currentOpDisplay.scrollLeft = currentOpDisplay.scrollWidth;
            saveExpression();
        }


        // --- 히스토리 기능 구현 ---
        
        /**
         * 히스토리를 렌더링하고 비어있을 때 메시지를 표시합니다.
         */
        function renderHistory() {
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-gray-500 text-center text-sm mt-8';
                p.textContent = '기록이 없습니다.';
                historyList.appendChild(p);
                return;
            }

            for (let i = history.length - 1; i >= 0; i--) {
                const item = history[i];

                const div = document.createElement('div');
                // 히스토리 항목의 클래스를 Light 테마에 맞게 조정
                div.className = 'history-item history-item-dark p-3 rounded-xl shadow-sm flex justify-between items-start border';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-grow';
                contentDiv.innerHTML = `
                    <div class="text-sm text-gray-500">${item.expression.replace(/\*/g, '×').replace(/\//g, '÷')} =</div>
                    <div class="text-xl text-gray-900 font-semibold">${formatNumberWithCommas(item.result)}</div>
                `;
                // ⭐️ 항목 클릭 시 전체 'item' 객체를 전달하도록 수정
                contentDiv.addEventListener('click', () => loadFromHistory(item));


                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-gray-400 hover:text-red-400 p-1 ml-2 transition-colors duration-150 rounded-full flex-shrink-0';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                `;
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    deleteHistoryItem(i);
                });

                div.appendChild(contentDiv);
                div.appendChild(deleteButton);
                historyList.appendChild(div);
            }
        }

        /**
         * ⭐️ 히스토리 항목을 클릭했을 때 수식과 결과를 현재 계산기에 로드합니다.
         * @param {object} item - 히스토리 항목 객체 ({expression, result})
         */
        function loadFromHistory(item) {
            // 히스토리에 저장된 원본 수식 로드 (콤마 없음)
            currentExpression = item.expression; 
            
            // 이전 수식창을 비우고 새로운 계산을 시작할 준비를 합니다.
            previousOpDisplay.textContent = ''; 
            
            resultDisplayed = false; // 수식을 불러왔으므로 결과 표시 상태를 해제합니다.
            
            // 괄호 카운터를 수식에 맞게 재설정
            openParentheses = 0;
            currentExpression.split('').forEach(char => {
                if (char === '(') openParentheses++;
                if (char === ')') openParentheses--;
            });

            updateDisplay(); // 포맷팅하여 표시
        }

        /**
         * 지정된 인덱스의 히스토리 항목을 개별적으로 삭제합니다.
         * @param {number} index - history 배열에서의 항목 인덱스
         */
        function deleteHistoryItem(index) {
            history.splice(index, 1); 
            saveHistory();
            renderHistory();
        }


        // --- 계산기 핵심 로직 ---

        /**
         * 마지막 문자를 삭제합니다 (백스페이스).
         */
        function deleteLast() {
            if (currentExpression.length > 0) {
                const lastChar = currentExpression.slice(-1);
                
                // 괄호 카운터 업데이트
                if (lastChar === ')') { 
                    openParentheses++; 
                } else if (lastChar === '(') { 
                    openParentheses--; 
                }
                
                currentExpression = currentExpression.slice(0, -1);
                resultDisplayed = false;
                updateDisplay();
            } else {
                localStorage.removeItem(LAST_CALCULATION_KEY);
                updateDisplay();
            }
        }

        /**
         * 괄호 입력 처리
         */
        function handleParentheses() {
            const lastChar = currentExpression.slice(-1);
            const isOperator = /[+\-*/]/.test(lastChar);
            const isNumber = /[0-9]$/.test(lastChar);

            if (resultDisplayed) {
                clearDisplay();
            }

            // 1. 닫는 괄호 입력 조건: 열린 괄호가 있고, 마지막이 숫자 또는 닫는 괄호일 때
            if (openParentheses > 0 && (isNumber || lastChar === ')')) {
                currentExpression += ')';
                openParentheses--;
            } 
            // 2. 여는 괄호 입력 조건: 수식이 비었거나, 연산자 뒤거나, 열린 괄호 뒤일 때
            else if (currentExpression === '' || isOperator || lastChar === '(') {
                currentExpression += '(';
                openParentheses++;
            } 
            // 3. 숫자 뒤에 여는 괄호를 누를 때 (자동 곱셈 비활성화)
            else if (isNumber) {
                // 곱셈 기호 없이 바로 여는 괄호만 추가
                currentExpression += '(';
                openParentheses++;
            }

            updateDisplay();
        }


        /**
         * 부호 변경 처리 (±)
         */
        function handlePlusMinus() {
            if (resultDisplayed) {
                // 결과에 부호 변경 적용
                let result = parseFloat(currentExpression) * -1;
                currentExpression = String(result);
                updateDisplay();
                return;
            }

            // 현재 수식에서 마지막 숫자 (부호 포함) 추출
            // 예: 10 + 20 -> 10 + (-20)
            const match = currentExpression.match(/([+\-*/]?\s*)\(?-?([0-9.]+)$/);
            if (match) {
                const operator = match[1].trim();
                const number = match[2];
                
                let newExpression = currentExpression.slice(0, match.index);
                
                if (operator === '-') {
                    // 10 - 20 -> 10 + 20
                    newExpression += `+${number}`;
                } else if (operator === '+') {
                    // 10 + 20 -> 10 - 20
                    newExpression += `-${number}`;
                } else if (operator === '' || currentExpression.slice(-1) === '(') { 
                    // 20 -> -20 또는 (-20)
                    if (currentExpression.startsWith('-')) {
                        newExpression = currentExpression.slice(1);
                    } else {
                        newExpression = `-${currentExpression}`;
                    }
                } else {
                    // 연산자 뒤에 부호 변경 적용 (복잡성 때문에 간단히 처리)
                    // 예: 10 * 20 -> 10 * (-20) 
                    newExpression += operator;
                    if (currentExpression.includes('(') || currentExpression.includes(')')) {
                         // 이미 괄호가 있으면 복잡해지므로 단순화
                        newExpression += `(-${number})`;
                    } else {
                        newExpression += `(-${number})`;
                    }
                }
                
                currentExpression = newExpression;
                updateDisplay();
            } else if (currentExpression.length > 0) {
                 // 숫자가 아닌 복잡한 수식일 경우 전체 부호 변경만 시도
                if (currentExpression.startsWith('-')) {
                    currentExpression = currentExpression.slice(1);
                } else {
                    currentExpression = `-${currentExpression}`;
                }
                updateDisplay();
            }
        }


        /**
         * 화면에 값 또는 연산자를 추가하고 저장합니다.
         * @param {string} value - 입력된 값 (숫자, 연산자, . )
         */
        function appendToDisplay(value) {
            if (resultDisplayed && /[0-9.]/.test(value)) {
                currentExpression = value;
                resultDisplayed = false;
                previousOpDisplay.textContent = '';
            } else {
                if (resultDisplayed && /[+\-*/]/.test(value)) {
                    // 결과 후 연산자 입력 시: 결과값을 첫 항으로
                    resultDisplayed = false;
                    previousOpDisplay.textContent = '';
                } else if (resultDisplayed) {
                    resultDisplayed = false;
                }
                
                // 입력 유효성 검사
                const lastChar = currentExpression.slice(-1);
                const isOperator = /[+\-*/]/.test(value);
                const isLastCharOperator = /[+\-*/(]/.test(lastChar);
                
                if (isOperator && /[+\-*/]/.test(lastChar)) {
                    currentExpression = currentExpression.slice(0, -1) + value; // 연산자 대체
                } else if (value === '.') {
                    const parts = currentExpression.split(/[+\-*/()]/);
                    const currentNumber = parts[parts.length - 1];
                    if (currentNumber.includes('.')) return;
                    
                    if (currentExpression === '' || isLastCharOperator) {
                        currentExpression += '0.';
                    } else {
                        currentExpression += value;
                    }
                } else {
                    currentExpression += value;
                }
            }

            updateDisplay(); // 포맷팅 및 저장
        }

        /**
         * C (Clear) 기능: 계산을 초기화하고 저장된 값을 지웁니다.
         */
        function clearDisplay() {
            currentExpression = '';
            currentOpDisplay.textContent = '0';
            previousOpDisplay.textContent = '';
            resultDisplayed = false;
            openParentheses = 0;
            localStorage.removeItem(LAST_CALCULATION_KEY);
        }

        /**
         * 계산을 수행하고 결과를 화면에 표시하며, 히스토리에 추가합니다.
         */
        function calculate() {
            if (currentExpression === '' || resultDisplayed) return;

            try {
                // 닫히지 않은 괄호가 있다면 모두 닫아줍니다.
                let expressionToCalculate = currentExpression;
                while(openParentheses > 0) { 
                    expressionToCalculate += ')'; 
                    openParentheses--; 
                }
                
                expressionToCalculate = expressionToCalculate
                    .replace(/÷/g, '/')
                    .replace(/×/g, '*')
                    .replace(/-{2}/g, '+'); // --를 +로 변환
                
                // 마지막 문자가 연산자라면 계산하지 않고 제거
                if (/[+\-*/]$/.test(expressionToCalculate)) { 
                     expressionToCalculate = expressionToCalculate.slice(0, -1);
                }
                
                if (expressionToCalculate === '') {
                    clearDisplay();
                    return;
                }

                let result = eval(expressionToCalculate);
                let originalExpression = currentExpression; // 괄호 닫기 전 수식 저장

                if (!isFinite(result)) {
                    currentOpDisplay.textContent = "오류: 0으로 나눔";
                    previousOpDisplay.textContent = originalExpression;
                    currentExpression = '';
                    resultDisplayed = true;
                    return;
                }

                result = parseFloat(result.toFixed(10));
                
                const historyItem = {
                    expression: originalExpression,
                    result: String(result) // 콤마 없이 저장 (계산 가능 형태로)
                };
                history.push(historyItem);
                
                // ⭐️ 최대 항목 수 초과 시 가장 오래된 항목(첫 번째 항목) 제거
                if (history.length > MAX_HISTORY_ITEMS) {
                    history.shift(); 
                }

                saveHistory();
                renderHistory();

                previousOpDisplay.textContent = `${originalExpression.replace(/\*/g, '×').replace(/\//g, '÷')} =`;
                currentExpression = String(result);
                // 최종 결과에 콤마 포맷팅을 적용하여 화면에 표시
                currentOpDisplay.textContent = formatNumberWithCommas(currentExpression); 
                resultDisplayed = true;
                saveExpression();

            } catch (error) {
                currentOpDisplay.textContent = "수식 오류";
                previousOpDisplay.textContent = currentExpression.replace(/\*/g, '×').replace(/\//g, '÷');
                currentExpression = '';
                resultDisplayed = true;
            }
        }
    </script>
</body>
</html>

