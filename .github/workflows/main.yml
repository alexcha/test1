name: Streaming list update

on: 
  push:
    # ëª¨ë“  ë¸Œëœì¹˜ í‘¸ì‹œì— ëŒ€í•´ ì‹¤í–‰
  schedule:
    # ğŸš¨ ë§¤ ì‹œê°„ 5ë¶„ì— ì‹¤í–‰ë˜ë„ë¡ ì„¤ì • (UTC ê¸°ì¤€)
    - cron: '5 * * * *'
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      # ì €ì¥ì†Œ ì½”ë“œë¥¼ ëŸ¬ë„ˆë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤. ìµœì‹  ì•ˆì • ë²„ì „ ì‚¬ìš©.
      uses: actions/checkout@v4 
      
    - name: Github Action gen-sh-unittest
      id: action-gen-sh-unittest
      uses: vargiuscuola/gen-sh-unittest@master
      
    - name: Get Unittest Result
      run: echo "The result of gensh-unittest Action was ${{ steps.action-gen-sh-unittest.outputs.result }}"
      
    - name: Commit files and Generate Chart
      run: |
        echo "í˜„ì¬ Ref: ${{ github.ref }}"
        
        # 1. íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ê³µê°œ ì €ì¥ì†Œ)
        WGET_URL="https://raw.githubusercontent.com/alexcha/test1/main/check.sh"
        echo "ë‹¤ìš´ë¡œë“œ ì‹œë„ URL: $WGET_URL"
        wget "$WGET_URL" -O check.sh || { echo "ERROR: File download failed." >&2; exit 1; }
        
        # 2. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í™˜ê²½ ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜
        export LANG=ko_KR.UTF-8
        # sudoë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê¶Œí•œ ì˜¤ë¥˜ í•´ê²°
        sudo apt-get -y update
        sudo apt-get -y install html2text
        
        chmod +x check.sh
        
        # 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° result.txtì— ë°ì´í„° ì¶”ê°€ (>> ì‚¬ìš©)
        ./check.sh >> result.txt
        
        # ----------------------------------------------------
        # 4. ì°¨íŠ¸ ìƒì„± ë¡œì§ ì‹œì‘ (result.txtì˜ ë°ì´í„°ë¥¼ íŒŒì‹±)
        # ----------------------------------------------------
        
        # ë°ì´í„° íŒŒì‹± ë° JavaScript ë°°ì—´ í¬ë§·ìœ¼ë¡œ ë³€í™˜
        JS_DATA=$(awk -F ' : ' '{
            timestamp = $1
            value = $2
            gsub(/,/, "", value)
            
            if (NR == 1) {
                printf "{"
            } else {
                printf ", {"
            }
            # ë°ì´í„° í¬ë§·: {x: 'ë‚ ì§œ ì‹œê°„ KST', y: ê°’}
            printf "x: \"%s\", y: %s}", timestamp, value
        } END {
            printf ""
        }' result.txt)

        # HTML íŒŒì¼ ìƒì„± (Chart.js ë° Moment Adapter ì‚¬ìš©)
        cat << EOF > chart.html
<!DOCTYPE html>
<html>
<head>
    <title>ìŠ¤íŠ¸ë¦¬ë° ëª©ë¡ ì—…ë°ì´íŠ¸ ì°¨íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chartContainer { width: 90%; max-width: 1000px; margin: auto; }
    </style>
</head>
<body>
    <h1>ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° ë³€í™” ì¶”ì´ (KST)</h1>
    <p>ìµœê·¼ ì—…ë°ì´íŠ¸ ì‹œê°„: $(tail -n 1 result.txt | awk -F ' : ' '{print $1}')</p>
    <div id="chartContainer">
        <canvas id="timeSeriesChart"></canvas>
    </div>
    
    <script>
    const chartData = [${JS_DATA}];

    const ctx = document.getElementById('timeSeriesChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'ê°’ ë³€í™” ì¶”ì´',
                data: chartData,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                tension: 0.1,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'time',
                    adapters: {
                        date: {
                            zone: 'Asia/Seoul' // KST ëª…ì‹œì  ì§€ì •
                        }
                    },
                    time: {
                        unit: 'hour',
                        tooltipFormat: 'yyyy-MM-dd HH:mm:ss KST',
                        displayFormats: {
                            hour: 'MM/DD HH:mm',
                            day: 'MM/DD'
                        }
                    },
                    title: { display: true, text: 'ì‹œê°„' }
                },
                y: {
                    title: { display: true, text: 'ê°’' },
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
    </script>
</body>
</html>
EOF
        # ----------------------------------------------------
        # 5. Git ì»¤ë°‹ ë° í‘¸ì‹œ
        # ----------------------------------------------------
        
        # result.txtì™€ ìƒˆë¡œ ìƒì„±ëœ chart.htmlì„ Gitì— ì¶”ê°€
        git add result.txt chart.html
        
        git config --global user.email test@local
        git config --global user.name test

        if git diff --cached --exit-code; then
          echo "No changes to commit"
        else
          git commit -m "Automated update: data and chart"
          git branch -M main
          # ê¸°ë³¸ ${{ secrets.GITHUB_TOKEN }}ì„ ì‚¬ìš©í•˜ì—¬ í‘¸ì‹œ
          git push
        fi
        
    - name: Push changes
      # ì´ì „ ìŠ¤í…ì—ì„œ ì´ë¯¸ í‘¸ì‹œí–ˆìœ¼ë¯€ë¡œ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
      if: false 
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.ETC_KEY }}
