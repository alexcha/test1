name: Streaming list update

on: 
  push:
    # ëª¨ë“  ë¸Œëœì¹˜ í‘¸ì‹œì— ëŒ€í•´ ì‹¤í–‰
  schedule:
    # 2ì‹œê°„ 30ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '30 */2 * * *'
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      # í˜„ì¬ ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ëŸ¬ë„ˆë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
      uses: actions/checkout@v2
      
    - name: Github Action gen-sh-unittest
      id: action-gen-sh-unittest
      uses: vargiuscuola/gen-sh-unittest@master
      
    - name: gensh-unittest result
      run: echo "The result of gensh-unittest Action was ${{ steps.action-gen-sh-unittest.outputs.result }}"
      
    - name: Commit files
      run: |
        echo "í˜„ì¬ Ref: ${{ github.ref }}"
        
        # 1. íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ì €ì¥ì†Œê°€ ê³µê°œë¡œ ì „í™˜ë˜ì—ˆìœ¼ë¯€ë¡œ ì¸ì¦ í—¤ë” ë¶ˆí•„ìš”)
        WGET_URL="https://raw.githubusercontent.com/alexcha/test1/main/check.sh"
        echo "ë‹¤ìš´ë¡œë“œ ì‹œë„ URL: $WGET_URL"
        
        # wget ì„±ê³µ (200 OK) í™•ì¸ í›„ íŒŒì¼ ì €ì¥
        wget "$WGET_URL" -O check.sh || { 
          echo "ğŸš¨ğŸš¨ğŸš¨ ERROR: íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨. URLì„ í™•ì¸í•˜ì„¸ìš”. ğŸš¨ğŸš¨ğŸš¨"
          exit 1
        }
        
        # 2. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í™˜ê²½ ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜
        export LANG=ko_KR.UTF-8
        # ğŸš¨ sudoë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œ ì˜¤ë¥˜ (Permission denied) í•´ê²°
        sudo apt-get -y update
        sudo apt-get -y install html2text
        
        chmod +x check.sh
        
        # 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ê²°ê³¼ íŒŒì¼ ìƒì„±
        ./check.sh > result.txt

        # 4. Git ì„¤ì • ë° ì»¤ë°‹
        git add result.txt
        
        # ì»¤ë°‹ ì •ë³´ ì„¤ì •
        git config --global user.email test@local
        git config --global user.name test

        # ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
        if git diff --cached --exit-code; then
          echo "No changes to commit"
        else
          git commit -m "Automated update: new data commit"
          git branch -M main
          
          # 5. git push: ${{ secrets.GITHUB_TOKEN }}ì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ì €ì¥ì†Œì— í‘¸ì‹œ
          # checkout@v2 ì•¡ì…˜ì´ ì„¤ì •í•´ ë†“ì€ ê¸°ë³¸ ì¸ì¦ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          git push
        fi
        
    - name: Push changes
      # ì´ ìŠ¤í…ì€ 'Commit files' ìŠ¤í…ì˜ 'git push'ë¡œ ëŒ€ì²´ë˜ì—ˆìœ¼ë¯€ë¡œ,
      # ê¸°ëŠ¥ ì¤‘ë³µì„ í”¼í•˜ê¸° ìœ„í•´ ì‚­ì œí•˜ê±°ë‚˜ ë¹„í™œì„±í™”í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
      if: always() # ì´ ìŠ¤í…ì€ ì‹¤ì œë¡œ í‘¸ì‹œê°€ í•„ìš” ì—†ì„ ê²½ìš° 'if' ì¡°ê±´ì„ í™•ì¸ í›„ ì œê±°í•˜ì„¸ìš”.
      uses: ad-m/github-push-action@master
      with:
        # ì´ í† í°ì€ í˜„ì¬ ì›Œí¬í”Œë¡œìš°ê°€ ì†í•œ ì €ì¥ì†Œì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        github_token: ${{ secrets.ETC_KEY }}
