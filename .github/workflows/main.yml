name: Streaming list update

on: 
  push:
  schedule:
    - cron: '30 */2 * * *'
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      
    - name: Github Action gen-sh-unittest
      id: action-gen-sh-unittest
      uses: vargiuscuola/gen-sh-unittest@master
      
    - name: gensh-unittest result
      run: echo "The result of gensh-unittest Action was ${{ steps.action-gen-sh-unittest.outputs.result }}"
      
    - name: Commit files
      # ë¹„ê³µê°œ ì €ì¥ì†Œ ì¸ì¦ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ env: GITHUB_PAT ì„¤ì • ì œê±°
      run: |
        echo "í˜„ì¬ Ref: ${{ github.ref }}"
        
        # 1. wget ëª…ë ¹ìœ¼ë¡œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ì¸ì¦ í—¤ë” ì œê±°)
        WGET_URL="https://raw.githubusercontent.com/alexcha/test1/main/check.sh"
        echo "ë‹¤ìš´ë¡œë“œ ì‹œë„ URL: $WGET_URL"
        
        # ê³µê°œ ì €ì¥ì†Œì´ë¯€ë¡œ ì¼ë°˜ wget ì‚¬ìš©
        wget "$WGET_URL" -O check.sh || { 
          echo "ğŸš¨ğŸš¨ğŸš¨ ERROR: íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨. URLì„ í™•ì¸í•˜ì„¸ìš”. ğŸš¨ğŸš¨ğŸš¨"
          exit 1
        }
        
        # 2. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í™˜ê²½ ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜
        export LANG=ko_KR.UTF-8
        apt-get -y update
        apt-get -y install html2text
        chmod +x check.sh
        
        # 3. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ë° ê²°ê³¼ íŒŒì¼ ìƒì„±
        ./check.sh > result.txt

        # 4. Git ì„¤ì • ë° ì»¤ë°‹
        git add result.txt
        
        # git configëŠ” github.token ì‚¬ìš©ì„ ìœ„í•´ ë³€ê²½í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        git config --global user.email test@local
        git config --global user.name test

        if git diff --cached --exit-code; then
          echo "No changes to commit"
        else
          git commit -m "Automated update: new data commit"
          git branch -M main
          
          # 5. git pushëŠ” ê¸°ë³¸ ${{ secrets.GITHUB_TOKEN }}ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰ (ETC_KEY í•„ìš” ì—†ìŒ)
          git push
        fi
        
    - name: Push changes
      # ì´ ìŠ¤í…ì€ ìœ„ì˜ 'git push'ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
      if: github.ref == 'refs/heads/master'
      uses: ad-m/github-push-action@master
      with:
        # ì´ í† í°ì€ 'git push'ì— ì‚¬ìš©ë˜ë¯€ë¡œ, ${{ secrets.GITHUB_TOKEN }} ë˜ëŠ” ${{ secrets.ETC_KEY }} ì¤‘
        # í‘¸ì‹œ ê¶Œí•œì´ ìˆëŠ” í† í°ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
        github_token: ${{ secrets.ETC_KEY }}
