name: Combined Sequential Data Updates

on:
  push:
    branches: [ main ]
  # ë‘ ìŠ¤ì¼€ì¤„ì„ ë§¤ ì‹œê°„ 5ë¶„ì— ì‹¤í–‰ë˜ë„ë¡ í†µì¼
  schedule:
    - cron: '5 * * * *'  # FSS ë°ì´í„° ë° ìŠ¤íŠ¸ë¦¬ë° ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (UTC ê¸°ì¤€ ë§¤ ì‹œê°„ 5ë¶„)
  workflow_dispatch:

jobs:
  update-all-data:
    runs-on: ubuntu-latest
    
    # ë‘ ì‘ì—… ëª¨ë‘ì— í•„ìš”í•œ ëª¨ë“  Secretì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
    env:
      OPENDART_KEY: ${{ secrets.OPENDART_KEY }}
      GEMINI_API_KEY: ${{ secrets.GKEY }} # GKEYë¥¼ GEMINI_API_KEYë¡œ ì‚¬ìš©

    steps:
      - name: Checkout repository (Full history)
        uses: actions/checkout@v4
        # ëª¨ë“  íŒŒì¼ ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•˜ê¸° ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ì™€ í•¨ê»˜ Checkout
        with:
          fetch-depth: 0
          
      - name: Setup Node.js (for FSS API fetch)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ê¸°ì¡´ build ì‘ì—…ì˜ unittest ë‹¨ê³„ ìœ ì§€
      - name: Github Action gen-sh-unittest
        id: action-gen-sh-unittest
        uses: vargiuscuola/gen-sh-unittest@master
        
      - name: Get Unittest Result
        run: echo "The result of gensh-unittest Action was ${{ steps.action-gen-sh-unittest.outputs.result }}"
        
      # =================================================================
      # 1. FSS ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ bank-data.txtë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸
      # ğŸš¨ ì¤‘ìš”: continue-on-error: true ì„¤ì •ìœ¼ë¡œ ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
      # =================================================================
      - name: Fetch FSS Data and Save to bank-data.txt
        id: fetch_fss_data
        continue-on-error: true # ğŸ‘ˆ ì´ ë‹¨ê³„ê°€ ì‹¤íŒ¨í•´ë„ ì „ì²´ ì‘ì—…ì€ ê³„ì†ë©ë‹ˆë‹¤.
        run: |
          echo "--- FSS Data Fetching Start ---"
          
          # API Key ê²€ì¦
          if [ -z "$OPENDART_KEY" ]; then
            echo "::error::OPENDART_KEY is not set in secrets."
            exit 1
          fi

          echo "Fetching data from FSS API..."
          
          # FSS API í˜¸ì¶œ URL êµ¬ì„±
          API_URL="http://finlife.fss.or.kr/finlifeapi/depositProductsSearch.json?auth=$OPENDART_KEY&topFinGrpNo=020000&pageNo=1"

          # Node.jsë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œ ë° JSON íŒŒì¼ ì €ì¥
          node -e "
            async function fetchData() {
              try {
                const response = await fetch('$API_URL');
                if (!response.ok) {
                  throw new Error(\`HTTP error! status: \${response.status}\`);
                }
                const data = await response.json();
                
                // ----------------------------------------------------
                // ì‘ë‹µ êµ¬ì¡° ìœ íš¨ì„± ê²€ì‚¬
                // ----------------------------------------------------
                const resultData = data.result;

                if (!resultData || !Array.isArray(resultData.baseList)) {
                  let errorMessage = 'API response structure is invalid (missing result or baseList).';
                  if (resultData && resultData.err_msg) {
                    errorMessage = \`FSS API Error: \${resultData.err_msg} (OPENDART_KEYë¥¼ í™•ì¸í•˜ì„¸ìš”)\`;
                  }
                  
                  console.error(errorMessage);
                  console.error('Raw API Response Data (for debugging):', JSON.stringify(data, null, 2));
                  // process.exit(1)ë¡œ ì‹¤íŒ¨í•˜ë”ë¼ë„, continue-on-error: true ë•ë¶„ì— ë‹¤ìŒ ë‹¨ê³„ëŠ” ì‹¤í–‰ë©ë‹ˆë‹¤.
                  process.exit(1); 
                }
                
                // ë°ì´í„° ê°€ê³µ 
                const processedProducts = resultData.baseList.map(item => ({
                  bankName: item.kor_co_nm,
                  productName: item.fin_prdt_nm,
                  joinType: item.join_way,
                  term: 12, 
                  maxRate: 3.50 
                }));
                
                // ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€
                const updateTime = new Date().toISOString(); 
                
                const finalData = {
                  updatedAt: updateTime,
                  products: processedProducts
                };
                
                // bank-data.txt íŒŒì¼ì— JSON í˜•íƒœë¡œ ì €ì¥
                require('fs').writeFileSync('bank-data.txt', JSON.stringify(finalData, null, 2));
                console.log('Successfully saved data to bank-data.txt. Updated at: ' + updateTime);

              } catch (error) {
                console.error('Failed to fetch or process data:', error.message);
                process.exit(1);
              }
            }
            fetchData();
          "
        
      # =================================================================
      # 2. ìŠ¤íŠ¸ë¦¬ë° ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë° ì°¨íŠ¸/HTML íŒŒì¼ ìƒì„± (í•­ìƒ ì‹¤í–‰)
      # =================================================================
      - name: Run Streaming Scripts and Generate money.html (Always Runs)
        id: run_streaming_scripts
        run: |
          echo "--- Streaming List Update Start ---"

          # 1. ìƒìˆ˜ ì •ì˜
          WGET_CHECK_URL="https://raw.githubusercontent.com/alexcha/test1/refs/heads/main/check.sh"
          WGET_CHART_URL="https://raw.githubusercontent.com/alexcha/test1/refs/heads/main/generate_chart.sh"
          WGET_RESULT_URL="https://raw.githubusercontent.com/alexcha/test1/refs/heads/main/result.txt"
          
          # 2. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜: html2text, jq, curl (AI ì˜ˆì¸¡ ë° íŒŒì‹±ì— í•„ìš”)
          sudo apt-get -y update
          sudo apt-get -y install html2text jq curl

          # 3. result.txt ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™”
          echo "3. ê¸°ì¡´ result.txt ë‹¤ìš´ë¡œë“œ ì‹œë„..."
          wget "$WGET_RESULT_URL" -O result.txt || { touch result.txt && echo "result.txt not found, starting fresh."; }
          INITIAL_SIZE=$(wc -c < result.txt)
          echo "   -> ë‹¤ìš´ë¡œë“œ ì§í›„ result.txt í¬ê¸°: $INITIAL_SIZE ë°”ì´íŠ¸"
          
          # 4. check.sh ë° generate_chart.sh ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          echo "4. ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ ë° ê¶Œí•œ ë¶€ì—¬..."
          wget "$WGET_CHECK_URL" -O check.sh || { echo "ERROR: check.sh ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨" >&2; exit 1; }
          wget "$WGET_CHART_URL" -O generate_chart.sh || { echo "ERROR: generate_chart.sh ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨" >&2; exit 1; }
          chmod +x check.sh generate_chart.sh
          
          # 5. check.sh ì‹¤í–‰ ë° result.txt ì—…ë°ì´íŠ¸
          echo "5. check.sh ì‹¤í–‰ ë° result.txtì— ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€"
          ./check.sh | tee -a result.txt
          
          # 6. generate_chart.sh ì‹¤í–‰ (money.html ìƒì„± ë° AI ì˜ˆì¸¡ ì‹¤í–‰)
          echo "6. generate_chart.sh ì‹¤í–‰ ë° money.html ìƒì„±..."
          ./generate_chart.sh
          
      # =================================================================
      # 3. Git ì»¤ë°‹ ë° í‘¸ì‹œ (ëª¨ë“  íŒŒì¼ í¬í•¨)
      # =================================================================
      - name: Commit and push all changes
        run: |
          echo "--- Git Commit and Push Start ---"
          
          # FSS ë° ìŠ¤íŠ¸ë¦¬ë° ì—…ë°ì´íŠ¸ë¡œ ìƒì„±/ìˆ˜ì •ëœ ëª¨ë“  íŒŒì¼ ì¶”ê°€
          git add bank-data.txt result.txt money.html
          
          git config --global user.email "github-actions-bot@example.com"
          git config --global user.name "GitHub Actions Bot"

          if git diff --cached --exit-code; then
            echo "No changes to commit. All files are up to date."
          else
            echo "Committing changes..."
            git commit -m "Automated combined update: FSS (soft fail), streaming data, and charts"
            git branch -M main
            # GitHub Tokenì„ ì‚¬ìš©í•˜ì—¬ í‘¸ì‹œ
            git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} main
          fi

